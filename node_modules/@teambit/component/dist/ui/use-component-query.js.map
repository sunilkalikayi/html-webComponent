{"version":3,"names":["componentIdFields","gql","componentOverviewFields","componentFields","GET_COMPONENT","SUB_SUBSCRIPTION_ADDED","SUB_COMPONENT_CHANGED","SUB_COMPONENT_REMOVED","useComponentQuery","componentId","host","filters","idRef","useRef","current","useDataQuery","variables","id","extensionId","log","data","error","loading","subscribeToMore","rest","useEffect","unsubAddition","document","updateQuery","prev","subscriptionData","prevComponent","getHost","get","addedComponent","componentAdded","component","name","unsubChanges","updatedComponent","componentChanged","isUpdated","ComponentID","isEqualObj","unsubRemoval","removedIds","componentRemoved","componentIds","length","isRemoved","some","removedId","rawComponent","useMemo","aspectList","entries","aspects","map","aspectObject","aspectId","aspectData","fromObject","componentDescriptor","ComponentDescriptor","toString","undefined","ComponentModel","from","ComponentError","message"],"sources":["use-component-query.ts"],"sourcesContent":["import { useMemo, useEffect, useRef } from 'react';\nimport { gql } from '@apollo/client';\nimport { useDataQuery } from '@teambit/ui-foundation.ui.hooks.use-data-query';\nimport { ComponentID, ComponentIdObj } from '@teambit/component-id';\nimport { ComponentDescriptor } from '@teambit/component-descriptor';\n\nimport { ComponentModel } from './component-model';\nimport { ComponentError } from './component-error';\n\nexport const componentIdFields = gql`\n  fragment componentIdFields on ComponentID {\n    name\n    version\n    scope\n  }\n`;\n\nexport const componentOverviewFields = gql`\n  fragment componentOverviewFields on Component {\n    id {\n      ...componentIdFields\n    }\n    aspects(include: [\"teambit.preview/preview\", \"teambit.envs/envs\"]) {\n      # 'id' property in gql refers to a *global* identifier and used for caching.\n      # this makes aspect data cache under the same key, even when they are under different components.\n      # renaming the property fixes that.\n      id\n      data\n    }\n    elementsUrl\n    description\n    deprecation {\n      isDeprecate\n      newId\n    }\n    labels\n    displayName\n    server {\n      env\n      url\n    }\n    buildStatus\n    env {\n      id\n      icon\n    }\n    size {\n      compressedTotal\n    }\n    preview {\n      includesEnvTemplate\n      legacyHeader\n      isScaling\n    }\n    compositions {\n      identifier\n      displayName\n    }\n  }\n  ${componentIdFields}\n`;\n\nexport const componentFields = gql`\n  fragment componentFields on Component {\n    id {\n      ...componentIdFields\n    }\n    ...componentOverviewFields\n    packageName\n    latest\n    compositions {\n      identifier\n      displayName\n    }\n    tags {\n      version\n    }\n    logs(type: $logType, offset: $logOffset, limit: $logLimit, head: $logHead, sort: $logSort) {\n      id\n      message\n      username\n      email\n      date\n      hash\n      tag\n    }\n  }\n  ${componentIdFields}\n  ${componentOverviewFields}\n`;\n\nconst GET_COMPONENT = gql`\n  query Component(\n    $id: String!\n    $extensionId: String!\n    $logType: String\n    $logOffset: Int\n    $logLimit: Int\n    $logHead: String\n    $logSort: String\n  ) {\n    getHost(id: $extensionId) {\n      id # used for GQL caching\n      get(id: $id) {\n        ...componentFields\n      }\n    }\n  }\n  ${componentFields}\n`;\n\nconst SUB_SUBSCRIPTION_ADDED = gql`\n  subscription OnComponentAdded($logType: String, $logOffset: Int, $logLimit: Int, $logHead: String, $logSort: String) {\n    componentAdded {\n      component {\n        ...componentFields\n      }\n    }\n  }\n  ${componentFields}\n`;\n\nconst SUB_COMPONENT_CHANGED = gql`\n  subscription OnComponentChanged(\n    $logType: String\n    $logOffset: Int\n    $logLimit: Int\n    $logHead: String\n    $logSort: String\n  ) {\n    componentChanged {\n      component {\n        ...componentFields\n      }\n    }\n  }\n  ${componentFields}\n`;\n\nconst SUB_COMPONENT_REMOVED = gql`\n  subscription OnComponentRemoved {\n    componentRemoved {\n      componentIds {\n        ...componentIdFields\n      }\n    }\n  }\n  ${componentIdFields}\n`;\nexport type Filters = {\n  log?: { logType?: string; logOffset?: number; logLimit?: number; logHead?: string; logSort?: string };\n};\n/** provides data to component ui page, making sure both variables and return value are safely typed and memoized */\nexport function useComponentQuery(componentId: string, host: string, filters?: Filters) {\n  const idRef = useRef(componentId);\n  idRef.current = componentId;\n  const { data, error, loading, subscribeToMore, ...rest } = useDataQuery(GET_COMPONENT, {\n    variables: { id: componentId, extensionId: host, ...(filters?.log || {}) },\n  });\n\n  useEffect(() => {\n    // @TODO @Kutner fix subscription for scope\n    if (host !== 'teambit.workspace/workspace') {\n      return () => {};\n    }\n\n    const unsubAddition = subscribeToMore({\n      document: SUB_SUBSCRIPTION_ADDED,\n      updateQuery: (prev, { subscriptionData }) => {\n        const prevComponent = prev?.getHost?.get;\n        const addedComponent = subscriptionData?.data?.componentAdded?.component;\n\n        if (!addedComponent || prevComponent) return prev;\n\n        if (idRef.current === addedComponent.id.name) {\n          return {\n            ...prev,\n            getHost: {\n              ...prev.getHost,\n              get: addedComponent,\n            },\n          };\n        }\n\n        return prev;\n      },\n    });\n\n    const unsubChanges = subscribeToMore({\n      document: SUB_COMPONENT_CHANGED,\n      updateQuery: (prev, { subscriptionData }) => {\n        if (!subscriptionData.data) return prev;\n\n        const prevComponent = prev?.getHost?.get;\n        const updatedComponent = subscriptionData?.data?.componentChanged?.component;\n\n        const isUpdated = updatedComponent && ComponentID.isEqualObj(prevComponent?.id, updatedComponent?.id);\n\n        if (isUpdated) {\n          return {\n            ...prev,\n            getHost: {\n              ...prev.getHost,\n              get: updatedComponent,\n            },\n          };\n        }\n\n        return prev;\n      },\n    });\n\n    const unsubRemoval = subscribeToMore({\n      document: SUB_COMPONENT_REMOVED,\n      updateQuery: (prev, { subscriptionData }) => {\n        if (!subscriptionData.data) return prev;\n\n        const prevComponent = prev?.getHost?.get;\n        const removedIds: ComponentIdObj[] | undefined = subscriptionData?.data?.componentRemoved?.componentIds;\n        if (!prevComponent || !removedIds?.length) return prev;\n\n        const isRemoved = removedIds.some((removedId) => ComponentID.isEqualObj(removedId, prevComponent.id));\n\n        if (isRemoved) {\n          return {\n            ...prev,\n            getHost: {\n              ...prev.getHost,\n              get: null,\n            },\n          };\n        }\n\n        return prev;\n      },\n    });\n\n    return () => {\n      unsubChanges();\n      unsubAddition();\n      unsubRemoval();\n    };\n  }, []);\n\n  const rawComponent = data?.getHost?.get;\n  return useMemo(() => {\n    const aspectList = {\n      entries: rawComponent?.aspects.map((aspectObject) => {\n        return {\n          ...aspectObject,\n          aspectId: aspectObject.id,\n          aspectData: aspectObject.data,\n        };\n      }),\n    };\n    const id = rawComponent && ComponentID.fromObject(rawComponent.id);\n    return {\n      componentDescriptor: id ? ComponentDescriptor.fromObject({ id: id.toString(), aspectList }) : undefined,\n      component: rawComponent ? ComponentModel.from({ ...rawComponent, host }) : undefined,\n      // eslint-disable-next-line\n      error: error\n        ? new ComponentError(500, error.message)\n        : !rawComponent && !loading\n        ? new ComponentError(404)\n        : undefined,\n      loading,\n      ...rest,\n    };\n  }, [rawComponent, host, error]);\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAAA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAEA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAAmD;AAAA;AAE5C,MAAMA,iBAAiB,GAAG,IAAAC,aAAG,CAAC;AACrC;AACA;AACA;AACA;AACA;AACA,CAAC;AAAC;AAEK,MAAMC,uBAAuB,GAAG,IAAAD,aAAG,CAAC;AAC3C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAID,iBAAkB;AACtB,CAAC;AAAC;AAEK,MAAMG,eAAe,GAAG,IAAAF,aAAG,CAAC;AACnC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAID,iBAAkB;AACtB,IAAIE,uBAAwB;AAC5B,CAAC;AAAC;AAEF,MAAME,aAAa,GAAG,IAAAH,aAAG,CAAC;AAC1B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAIE,eAAgB;AACpB,CAAC;AAED,MAAME,sBAAsB,GAAG,IAAAJ,aAAG,CAAC;AACnC;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAIE,eAAgB;AACpB,CAAC;AAED,MAAMG,qBAAqB,GAAG,IAAAL,aAAG,CAAC;AAClC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AA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"}