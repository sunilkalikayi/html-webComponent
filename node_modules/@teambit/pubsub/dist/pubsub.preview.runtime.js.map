{"version":3,"names":["PubsubPreview","EventEmitter2","retries","PubSubNoParentError","connectToParent","timeout","methods","pub","handleMessageFromParent","promise","then","parentPubsub","_parentPubsub","catch","e","code","ErrorCode","ConnectionTimeout","connectToParentPubSub","topic","message","events","emit","sub","callback","emitter","on","unSub","off","event","err","console","error","inIframe","isBrowser","window","self","top","provider","pubsubPreview","PreviewRuntime","PubsubAspect","addRuntime"],"sources":["pubsub.preview.runtime.ts"],"sourcesContent":["/**\n * Please Notice: This file will run in the preview iframe.\n */\n\nimport { PreviewRuntime } from '@teambit/preview';\nimport { isBrowser } from '@teambit/ui-foundation.ui.is-browser';\n\nimport { EventEmitter2 } from 'eventemitter2';\nimport { connectToParent, ErrorCode } from 'penpal';\n\nimport { BitBaseEvent } from './bit-base-event';\nimport { PubSubNoParentError } from './no-parent-error';\nimport { PubsubAspect } from './pubsub.aspect';\nimport { Callback } from './types';\n\ntype ParentMethods = {\n  pub: (topic: string, event: BitBaseEvent<any>) => Promise<any>;\n};\n\nexport class PubsubPreview {\n  private _parentPubsub?: ParentMethods;\n  private events = new EventEmitter2();\n\n  public sub(topic: string, callback: Callback) {\n    const emitter = this.events;\n    emitter.on(topic, callback);\n\n    const unSub = () => {\n      emitter.off(topic, callback);\n    };\n    return unSub;\n  }\n\n  public pub(topic: string, event: BitBaseEvent<any>) {\n    this.events.emit(topic, event);\n    this._parentPubsub?.pub(topic, event).catch((err) => {\n      // eslint-disable-next-line no-console\n      console.error('[Pubsub.preview]', err);\n    });\n  }\n\n  private inIframe() {\n    try {\n      return isBrowser && window.self !== window.top;\n    } catch (e: any) {\n      return false;\n    }\n  }\n\n  private connectToParentPubSub = (retries = 10): Promise<ParentMethods | undefined> => {\n    if (retries <= 0) throw new PubSubNoParentError();\n\n    return connectToParent<ParentMethods>({\n      timeout: 300,\n      methods: {\n        pub: this.handleMessageFromParent,\n      },\n    })\n      .promise.then((parentPubsub) => (this._parentPubsub = parentPubsub))\n      .catch((e: any) => {\n        if (e.code !== ErrorCode.ConnectionTimeout) throw e;\n\n        return this.connectToParentPubSub(retries - 1);\n      });\n  };\n\n  private handleMessageFromParent = (topic: string, message: BitBaseEvent<any>) => {\n    this.events.emit(topic, message);\n  };\n\n  static runtime = PreviewRuntime;\n\n  static async provider(): Promise<PubsubPreview> {\n    const pubsubPreview = new PubsubPreview();\n\n    if (pubsubPreview.inIframe()) {\n      pubsubPreview.connectToParentPubSub().catch((err) => {\n        // parent window is not required to accept connections\n        if (err instanceof PubSubNoParentError) return;\n\n        // eslint-disable-next-line no-console\n        console.error('[Pubsub.preview]', err);\n      });\n    }\n\n    return pubsubPreview;\n  }\n}\n\nPubsubAspect.addRuntime(PubsubPreview);\n"],"mappings":";;;;;;;;;;;;;;;AAIA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAEA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAGA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAZA;AACA;AACA;;AAiBO,MAAMA,aAAa,CAAC;EAAA;IAAA;IAAA,gDAER,KAAIC,6BAAa,GAAE;IAAA,+DA4BJ,CAACC,OAAO,GAAG,EAAE,KAAyC;MACpF,IAAIA,OAAO,IAAI,CAAC,EAAE,MAAM,KAAIC,oCAAmB,GAAE;MAEjD,OAAO,IAAAC,yBAAe,EAAgB;QACpCC,OAAO,EAAE,GAAG;QACZC,OAAO,EAAE;UACPC,GAAG,EAAE,IAAI,CAACC;QACZ;MACF,CAAC,CAAC,CACCC,OAAO,CAACC,IAAI,CAAEC,YAAY,IAAM,IAAI,CAACC,aAAa,GAAGD,YAAa,CAAC,CACnEE,KAAK,CAAEC,CAAM,IAAK;QACjB,IAAIA,CAAC,CAACC,IAAI,KAAKC,mBAAS,CAACC,iBAAiB,EAAE,MAAMH,CAAC;QAEnD,OAAO,IAAI,CAACI,qBAAqB,CAAChB,OAAO,GAAG,CAAC,CAAC;MAChD,CAAC,CAAC;IACN,CAAC;IAAA,iEAEiC,CAACiB,KAAa,EAAEC,OAA0B,KAAK;MAC/E,IAAI,CAACC,MAAM,CAACC,IAAI,CAACH,KAAK,EAAEC,OAAO,CAAC;IAClC,CAAC;EAAA;EA7CMG,GAAG,CAACJ,KAAa,EAAEK,QAAkB,EAAE;IAC5C,MAAMC,OAAO,GAAG,IAAI,CAACJ,MAAM;IAC3BI,OAAO,CAACC,EAAE,CAACP,KAAK,EAAEK,QAAQ,CAAC;IAE3B,MAAMG,KAAK,GAAG,MAAM;MAClBF,OAAO,CAACG,GAAG,CAACT,KAAK,EAAEK,QAAQ,CAAC;IAC9B,CAAC;IACD,OAAOG,KAAK;EACd;EAEOpB,GAAG,CAACY,KAAa,EAAEU,KAAwB,EAAE;IAAA;IAClD,IAAI,CAACR,MAAM,CAACC,IAAI,CAACH,KAAK,EAAEU,KAAK,CAAC;IAC9B,2BAAI,CAACjB,aAAa,wDAAlB,oBAAoBL,GAAG,CAACY,KAAK,EAAEU,KAAK,CAAC,CAAChB,KAAK,CAAEiB,GAAG,IAAK;MACnD;MACAC,OAAO,CAACC,KAAK,CAAC,kBAAkB,EAAEF,GAAG,CAAC;IACxC,CAAC,CAAC;EACJ;EAEQG,QAAQ,GAAG;IACjB,IAAI;MACF,OAAOC,2BAAS,IAAIC,MAAM,CAACC,IAAI,KAAKD,MAAM,CAACE,GAAG;IAChD,CAAC,CAAC,OAAOvB,CAAM,EAAE;MACf,OAAO,KAAK;IACd;EACF;EAyBA,aAAawB,QAAQ,GAA2B;IAC9C,MAAMC,aAAa,GAAG,IAAIvC,aAAa,EAAE;IAEzC,IAAIuC,aAAa,CAACN,QAAQ,EAAE,EAAE;MAC5BM,aAAa,CAACrB,qBAAqB,EAAE,CAACL,KAAK,CAAEiB,GAAG,IAAK;QACnD;QACA,IAAIA,GAAG,YAAY3B,oCAAmB,EAAE;;QAExC;QACA4B,OAAO,CAACC,KAAK,CAAC,kBAAkB,EAAEF,GAAG,CAAC;MACxC,CAAC,CAAC;IACJ;IAEA,OAAOS,aAAa;EACtB;AACF;AAAC;AAAA,gCApEYvC,aAAa,aAmDPwC,yBAAc;AAmBjCC,sBAAY,CAACC,UAAU,CAAC1C,aAAa,CAAC"}