{"version":3,"names":["PubsubUI","EventEmitter2","topic","callback","events","on","unSub","off","event","propagate","emitEvent","pubToChild","iframe","connection","connectToChild","methods","pub","promise","then","childConnection","childApi","catch","err","console","error","destroy","emit","getPubSubContext","createProvider","connect","connectToIframe","provider","uiUI","pubsubUI","reactContext","registerRenderHooks","UIRuntime","UIAspect","PubsubAspect","addRuntime"],"sources":["pubsub.ui.runtime.ts"],"sourcesContent":["import { UIRuntime, UIAspect, UiUI } from '@teambit/ui';\nimport { EventEmitter2 } from 'eventemitter2';\nimport { connectToChild } from 'penpal';\nimport type { AsyncMethodReturns } from 'penpal/lib/types';\nimport { BitBaseEvent } from './bit-base-event';\nimport { PubsubAspect } from './pubsub.aspect';\nimport { createProvider } from './pubsub-context';\nimport { Callback } from './types';\n\ntype PubOptions = {\n  /** forward the event to adjacent windows (including the preview iframe)  */\n  propagate?: boolean;\n};\n\ntype ChildMethods = {\n  pub: (topic: string, event: BitBaseEvent<any>) => any;\n};\nexport class PubsubUI {\n  private childApi?: AsyncMethodReturns<ChildMethods>;\n  private events = new EventEmitter2();\n\n  /**\n   * subscribe to events\n   */\n  public sub = (topic: string, callback: Callback) => {\n    const events = this.events;\n    events.on(topic, callback);\n\n    const unSub = () => {\n      events.off(topic, callback);\n    };\n\n    return unSub;\n  };\n\n  /**\n   * publish event to all subscribers, including nested iframes.\n   */\n  public pub = (topic: string, event: BitBaseEvent<any>, { propagate }: PubOptions = {}) => {\n    this.emitEvent(topic, event);\n\n    // opt-in to forward to iframe, as we would not want 'private' messages automatically passing to iframe\n    if (propagate) {\n      this.pubToChild(topic, event);\n    }\n  };\n\n  private connectToIframe = (iframe: HTMLIFrameElement) => {\n    const connection = connectToChild<ChildMethods>({\n      iframe,\n      methods: {\n        pub: this.emitEvent,\n      },\n    });\n\n    connection.promise\n      .then((childConnection) => (this.childApi = childConnection))\n      .catch((err) => {\n        // eslint-disable-next-line no-console\n        console.error('[Pubsub.ui]', 'failed connecting to child iframe:', err);\n      });\n\n    const destroy = () => {\n      connection && connection.destroy();\n    };\n    return destroy;\n  };\n\n  getPubSubContext() {\n    return createProvider({\n      connect: this.connectToIframe,\n    });\n  }\n\n  /**\n   * publish event to all subscribers in this window\n   */\n  private emitEvent = (topic: string, event: BitBaseEvent<any>) => {\n    this.events.emit(topic, event);\n  };\n\n  /**\n   * publish event to nested iframes\n   */\n  private pubToChild = (topic: string, event: BitBaseEvent<any>) => {\n    return this.childApi?.pub(topic, event);\n  };\n\n  static runtime = UIRuntime;\n  static dependencies = [UIAspect];\n\n  static async provider([uiUI]: [UiUI]) {\n    const pubsubUI = new PubsubUI();\n\n    const reactContext = pubsubUI.getPubSubContext();\n\n    if (uiUI) uiUI.registerRenderHooks({ reactContext });\n\n    return pubsubUI;\n  }\n}\n\nPubsubAspect.addRuntime(PubsubUI);\n"],"mappings":";;;;;;;;;;;;;;;;AAAA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAGA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAWO,MAAMA,QAAQ,CAAC;EAAA;IAAA;IAAA,gDAEH,KAAIC,6BAAa,GAAE;IAAA,6CAKvB,CAACC,KAAa,EAAEC,QAAkB,KAAK;MAClD,MAAMC,MAAM,GAAG,IAAI,CAACA,MAAM;MAC1BA,MAAM,CAACC,EAAE,CAACH,KAAK,EAAEC,QAAQ,CAAC;MAE1B,MAAMG,KAAK,GAAG,MAAM;QAClBF,MAAM,CAACG,GAAG,CAACL,KAAK,EAAEC,QAAQ,CAAC;MAC7B,CAAC;MAED,OAAOG,KAAK;IACd,CAAC;IAAA,6CAKY,CAACJ,KAAa,EAAEM,KAAwB,EAAE;MAAEC;IAAsB,CAAC,GAAG,CAAC,CAAC,KAAK;MACxF,IAAI,CAACC,SAAS,CAACR,KAAK,EAAEM,KAAK,CAAC;;MAE5B;MACA,IAAIC,SAAS,EAAE;QACb,IAAI,CAACE,UAAU,CAACT,KAAK,EAAEM,KAAK,CAAC;MAC/B;IACF,CAAC;IAAA,yDAE0BI,MAAyB,IAAK;MACvD,MAAMC,UAAU,GAAG,IAAAC,wBAAc,EAAe;QAC9CF,MAAM;QACNG,OAAO,EAAE;UACPC,GAAG,EAAE,IAAI,CAACN;QACZ;MACF,CAAC,CAAC;MAEFG,UAAU,CAACI,OAAO,CACfC,IAAI,CAAEC,eAAe,IAAM,IAAI,CAACC,QAAQ,GAAGD,eAAgB,CAAC,CAC5DE,KAAK,CAAEC,GAAG,IAAK;QACd;QACAC,OAAO,CAACC,KAAK,CAAC,aAAa,EAAE,oCAAoC,EAAEF,GAAG,CAAC;MACzE,CAAC,CAAC;MAEJ,MAAMG,OAAO,GAAG,MAAM;QACpBZ,UAAU,IAAIA,UAAU,CAACY,OAAO,EAAE;MACpC,CAAC;MACD,OAAOA,OAAO;IAChB,CAAC;IAAA,mDAWmB,CAACvB,KAAa,EAAEM,KAAwB,KAAK;MAC/D,IAAI,CAACJ,MAAM,CAACsB,IAAI,CAACxB,KAAK,EAAEM,KAAK,CAAC;IAChC,CAAC;IAAA,oDAKoB,CAACN,KAAa,EAAEM,KAAwB,KAAK;MAAA;MAChE,yBAAO,IAAI,CAACY,QAAQ,mDAAb,eAAeJ,GAAG,CAACd,KAAK,EAAEM,KAAK,CAAC;IACzC,CAAC;EAAA;EAlBDmB,gBAAgB,GAAG;IACjB,OAAO,IAAAC,+BAAc,EAAC;MACpBC,OAAO,EAAE,IAAI,CAACC;IAChB,CAAC,CAAC;EACJ;;EAEA;AACF;AACA;;EAeE,aAAaC,QAAQ,CAAC,CAACC,IAAI,CAAS,EAAE;IACpC,MAAMC,QAAQ,GAAG,IAAIjC,QAAQ,EAAE;IAE/B,MAAMkC,YAAY,GAAGD,QAAQ,CAACN,gBAAgB,EAAE;IAEhD,IAAIK,IAAI,EAAEA,IAAI,CAACG,mBAAmB,CAAC;MAAED;IAAa,CAAC,CAAC;IAEpD,OAAOD,QAAQ;EACjB;AACF;AAAC;AAAA,gCAnFYjC,QAAQ,aAuEFoC,eAAS;AAAA,gCAvEfpC,QAAQ,kBAwEG,CAACqC,cAAQ,CAAC;AAalCC,sBAAY,CAACC,UAAU,CAACvC,QAAQ,CAAC"}