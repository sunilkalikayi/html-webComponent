{"version":3,"names":["pickOutdatedPkgs","outdatedPkgs","updateDependencies","prompt","choices","makeOutdatedPkgChoices","footer","indicator","state","choice","enabled","message","chalk","cyan","green","red","name","pointer","styles","dark","white","em","bgBlack","whiteBright","success","type","validate","value","length","j","down","k","up","result","names","map","cancel","Object","values","filter","updateDependency","DEP_TYPE_PRIORITY","dependencies","devDependencies","peerDependencies","mergedOutdatedPkgs","mergeOutdatedPkgs","sort","pkg1","pkg2","targetField","localeCompare","renderedTable","alignColumns","outdatedPkgsRows","groupedChoices","forEach","outdatedPkg","index","context","renderContext","push","entries","subChoices","outdatedPkgsNotFromComponentModel","source","componentId","omit","dependentComponents","currentRange","hasDifferentRanges","tryPickLowestRange","range1","range2","semver","lt","rangeToVersion","range","startsWith","substring","variantPattern","TARGET_FIELD_TO_DEP_TYPE","change","diff","semverDiff","latestRange","colorizeChange","latest","colorizeSemverDiff","grey","renderDependents","rows","table","border","getBorderCharacters","columnDefault","paddingLeft","paddingRight","columns","alignment","drawHorizontalLine","split"],"sources":["pick-outdated-pkgs.ts"],"sourcesContent":["import colorizeSemverDiff from '@pnpm/colorize-semver-diff';\nimport semverDiff from '@pnpm/semver-diff';\nimport { OutdatedPkg } from '@teambit/dependency-resolver';\nimport { omit } from 'lodash';\nimport { getBorderCharacters, table } from 'table';\nimport chalk from 'chalk';\nimport { prompt } from 'enquirer';\nimport semver from 'semver';\n\n/**\n * Lets the user pick the packages that should be updated.\n */\nexport async function pickOutdatedPkgs(outdatedPkgs: OutdatedPkg[]): Promise<MergedOutdatedPkg[]> {\n  const { updateDependencies } = (await prompt({\n    choices: makeOutdatedPkgChoices(outdatedPkgs),\n    footer: '\\nEnter to start updating. Ctrl-c to cancel.',\n    indicator: (state: any, choice: any) => ` ${choice.enabled ? '●' : '○'}`,\n    message:\n      'Choose which packages to update ' +\n      `(Press ${chalk.cyan('<space>')} to select, ` +\n      `${chalk.cyan('<a>')} to toggle all, ` +\n      `${chalk.cyan('<i>')} to invert selection)\n${chalk.green('Green')} - indicates a semantically safe update\n${chalk.red('Red')} - indicates a semantically breaking change`,\n    name: 'updateDependencies',\n    pointer: '❯',\n    styles: {\n      dark: chalk.white,\n      em: chalk.bgBlack.whiteBright,\n      success: chalk.white,\n    },\n    type: 'multiselect',\n    validate(value: string[]) {\n      if (value.length === 0) {\n        return 'You must choose at least one package.';\n      }\n      return true;\n    },\n    j() {\n      return this.down();\n    },\n    k() {\n      return this.up();\n    },\n    result(names: string[]) {\n      // This is needed in order to have the values of the choices in the answer object.\n      // Otherwise, only the names of the selected choices would've been included.\n      return this.map(names);\n    },\n    cancel() {\n      // By default, canceling the prompt via Ctrl+c throws an empty string.\n      // The custom cancel function prevents that behavior.\n      // Otherwise, Bit CLI would print an error and confuse users.\n      // See related issue: https://github.com/enquirer/enquirer/issues/225\n    },\n  } as any)) as { updateDependencies: Record<string, string | MergedOutdatedPkg> };\n  return Object.values(updateDependencies ?? {}).filter(\n    (updateDependency) => typeof updateDependency !== 'string'\n  ) as OutdatedPkg[];\n}\n\nconst DEP_TYPE_PRIORITY = {\n  dependencies: 0,\n  devDependencies: 1,\n  peerDependencies: 2,\n};\n\n/**\n * Groups the outdated packages and makes choices for enquirer's prompt.\n */\nexport function makeOutdatedPkgChoices(outdatedPkgs: OutdatedPkg[]) {\n  const mergedOutdatedPkgs = mergeOutdatedPkgs(outdatedPkgs);\n  mergedOutdatedPkgs.sort((pkg1, pkg2) => {\n    if (pkg1.targetField === pkg2.targetField) return pkg1.name.localeCompare(pkg2.name);\n    return DEP_TYPE_PRIORITY[pkg1.targetField] - DEP_TYPE_PRIORITY[pkg2.targetField];\n  });\n  const renderedTable = alignColumns(outdatedPkgsRows(mergedOutdatedPkgs));\n  const groupedChoices = {};\n  mergedOutdatedPkgs.forEach((outdatedPkg, index) => {\n    const context = renderContext(outdatedPkg);\n    if (!groupedChoices[context]) {\n      groupedChoices[context] = [];\n    }\n    groupedChoices[context].push({\n      message: renderedTable[index],\n      name: outdatedPkg.name,\n      value: outdatedPkg,\n    });\n  });\n  const choices = Object.entries(groupedChoices).map(([context, subChoices]) => ({\n    message: chalk.cyan(context),\n    choices: subChoices,\n  }));\n  return choices;\n}\n\nexport interface MergedOutdatedPkg extends OutdatedPkg {\n  dependentComponents?: string[];\n  hasDifferentRanges?: boolean;\n}\n\nfunction mergeOutdatedPkgs(outdatedPkgs: OutdatedPkg[]): MergedOutdatedPkg[] {\n  const mergedOutdatedPkgs: Record<\n    string,\n    MergedOutdatedPkg & Required<Pick<MergedOutdatedPkg, 'dependentComponents'>>\n  > = {};\n  const outdatedPkgsNotFromComponentModel: OutdatedPkg[] = [];\n  for (const outdatedPkg of outdatedPkgs) {\n    if (outdatedPkg.source === 'component-model' && outdatedPkg.componentId) {\n      if (!mergedOutdatedPkgs[outdatedPkg.name]) {\n        mergedOutdatedPkgs[outdatedPkg.name] = {\n          ...omit(outdatedPkg, ['componentId']),\n          source: 'rootPolicy',\n          dependentComponents: [outdatedPkg.componentId],\n        };\n      } else {\n        if (mergedOutdatedPkgs[outdatedPkg.name].currentRange !== outdatedPkg.currentRange) {\n          mergedOutdatedPkgs[outdatedPkg.name].hasDifferentRanges = true;\n        }\n        mergedOutdatedPkgs[outdatedPkg.name].currentRange = tryPickLowestRange(\n          mergedOutdatedPkgs[outdatedPkg.name].currentRange,\n          outdatedPkg.currentRange\n        );\n        mergedOutdatedPkgs[outdatedPkg.name].dependentComponents.push(outdatedPkg.componentId);\n        if (outdatedPkg.targetField === 'dependencies') {\n          mergedOutdatedPkgs[outdatedPkg.name].targetField = outdatedPkg.targetField;\n        }\n      }\n    } else {\n      outdatedPkgsNotFromComponentModel.push(outdatedPkg);\n    }\n  }\n  return [...Object.values(mergedOutdatedPkgs), ...outdatedPkgsNotFromComponentModel];\n}\n\nfunction tryPickLowestRange(range1: string, range2: string) {\n  if (range1 === '*' || range2 === '*') return '*';\n  try {\n    return semver.lt(rangeToVersion(range1), rangeToVersion(range2)) ? range1 : range2;\n  } catch {\n    return '*';\n  }\n}\n\nfunction rangeToVersion(range: string) {\n  if (range.startsWith('~') || range.startsWith('^')) {\n    return range.substring(1);\n  }\n  return range;\n}\n\nfunction renderContext(outdatedPkg: MergedOutdatedPkg) {\n  if (outdatedPkg.variantPattern) {\n    return `${outdatedPkg.variantPattern} (variant)`;\n  }\n  if (outdatedPkg.componentId) {\n    return `${outdatedPkg.componentId} (component)`;\n  }\n  return 'Root policies';\n}\n\nconst TARGET_FIELD_TO_DEP_TYPE = {\n  devDependencies: 'dev',\n  dependencies: 'runtime',\n  peerDependencies: 'peer',\n};\n\nfunction outdatedPkgsRows(outdatedPkgs: MergedOutdatedPkg[]) {\n  return outdatedPkgs.map((outdatedPkg) => {\n    const { change, diff } = semverDiff(outdatedPkg.currentRange, outdatedPkg.latestRange);\n    let colorizeChange = change ?? 'breaking';\n    if (change === 'feature') {\n      colorizeChange = 'fix';\n    }\n    const latest = colorizeSemverDiff({\n      change: colorizeChange,\n      diff,\n    });\n    return [\n      outdatedPkg.name,\n      chalk.grey(`(${TARGET_FIELD_TO_DEP_TYPE[outdatedPkg.targetField]})`),\n      outdatedPkg.hasDifferentRanges ? '*' : outdatedPkg.currentRange,\n      '❯',\n      latest,\n      outdatedPkg.dependentComponents ? renderDependents(outdatedPkg.dependentComponents) : ' ',\n    ];\n  });\n}\n\nfunction renderDependents(dependentComponents: string[]): string {\n  let result = `because of ${dependentComponents[0]}`;\n  if (dependentComponents.length > 1) {\n    result += ` and ${dependentComponents.length - 1} other components`;\n  }\n  return result;\n}\n\nfunction alignColumns(rows: string[][]) {\n  return table(rows, {\n    border: getBorderCharacters('void'),\n    columnDefault: {\n      paddingLeft: 0,\n      paddingRight: 1,\n    },\n    columns: {\n      // This is the current range column\n      2: { alignment: 'right' },\n    },\n    drawHorizontalLine: () => false,\n  }).split('\\n');\n}\n"],"mappings":"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"}