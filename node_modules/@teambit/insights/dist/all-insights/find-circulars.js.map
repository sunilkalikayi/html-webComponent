{"version":3,"names":["INSIGHT_CIRCULAR_DEPS_NAME","FindCycles","constructor","graphBuilder","runInsight","graph","getGraph","message","data","undefined","cycles","findCycles","length","renderData","string","map","cycle","join","run","bareResult","renderedData","result","metaData","name","description","addAsComponentIssue","components","allIds","uniq","flat","componentsWithCircular","filter","component","includes","id","toString","forEach","state","issues","getOrCreate","IssuesClasses","CircularDependencies"],"sources":["find-circulars.ts"],"sourcesContent":["import { Component } from '@teambit/component';\nimport { IssuesClasses } from '@teambit/component-issues';\nimport { GraphBuilder } from '@teambit/graph';\nimport { uniq } from 'lodash';\nimport { Insight, InsightResult, RawResult } from '../insight';\n\nexport const INSIGHT_CIRCULAR_DEPS_NAME = 'circular';\n\nexport default class FindCycles implements Insight {\n  name = INSIGHT_CIRCULAR_DEPS_NAME;\n  description = 'Get all circular dependencies in component graph';\n  graphBuilder: GraphBuilder;\n  constructor(graphBuilder: GraphBuilder) {\n    this.graphBuilder = graphBuilder;\n  }\n  private async runInsight(): Promise<RawResult> {\n    const graph = await this.graphBuilder.getGraph();\n    if (!graph) {\n      return {\n        message: '',\n        data: undefined,\n      };\n    }\n    const cycles = graph.findCycles();\n    if (cycles.length === 1) {\n      return {\n        message: `Found ${cycles.length} cycle.`,\n        data: cycles,\n      };\n    }\n    return {\n      message: `Found ${cycles.length} cycles.`,\n      data: cycles,\n    };\n  }\n\n  private renderData(data: RawResult) {\n    if (data.data.length === 0) {\n      return 'No cyclic dependencies';\n    }\n    const string = data.data\n      .map((cycle) => {\n        return `\\nCyclic dependency\n-----------------\n- ${cycle.join('\\n- ')}`;\n      })\n      .join('\\n');\n    return string;\n  }\n\n  async run(): Promise<InsightResult> {\n    const bareResult = await this.runInsight();\n    const renderedData = this.renderData(bareResult);\n    const result: InsightResult = {\n      metaData: {\n        name: this.name,\n        description: this.description,\n      },\n      data: bareResult.data,\n      message: bareResult.message,\n      renderedData,\n    };\n\n    if (bareResult.message) {\n      result.message = bareResult.message;\n    }\n    return result;\n  }\n\n  async addAsComponentIssue(components: Component[]) {\n    const result = await this.runInsight();\n    if (!result.data.length) {\n      return; // no circulars\n    }\n    const allIds = uniq(result.data.flat());\n    const componentsWithCircular = components.filter((component) => allIds.includes(component.id.toString()));\n    componentsWithCircular.forEach((component) => {\n      component.state.issues.getOrCreate(IssuesClasses.CircularDependencies).data = true;\n    });\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAEA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAGO,MAAMA,0BAA0B,GAAG,UAAU;AAAC;AAEtC,MAAMC,UAAU,CAAoB;EAIjDC,WAAW,CAACC,YAA0B,EAAE;IAAA,8CAHjCH,0BAA0B;IAAA,qDACnB,kDAAkD;IAAA;IAG9D,IAAI,CAACG,YAAY,GAAGA,YAAY;EAClC;EACA,MAAcC,UAAU,GAAuB;IAC7C,MAAMC,KAAK,GAAG,MAAM,IAAI,CAACF,YAAY,CAACG,QAAQ,EAAE;IAChD,IAAI,CAACD,KAAK,EAAE;MACV,OAAO;QACLE,OAAO,EAAE,EAAE;QACXC,IAAI,EAAEC;MACR,CAAC;IACH;IACA,MAAMC,MAAM,GAAGL,KAAK,CAACM,UAAU,EAAE;IACjC,IAAID,MAAM,CAACE,MAAM,KAAK,CAAC,EAAE;MACvB,OAAO;QACLL,OAAO,EAAG,SAAQG,MAAM,CAACE,MAAO,SAAQ;QACxCJ,IAAI,EAAEE;MACR,CAAC;IACH;IACA,OAAO;MACLH,OAAO,EAAG,SAAQG,MAAM,CAACE,MAAO,UAAS;MACzCJ,IAAI,EAAEE;IACR,CAAC;EACH;EAEQG,UAAU,CAACL,IAAe,EAAE;IAClC,IAAIA,IAAI,CAACA,IAAI,CAACI,MAAM,KAAK,CAAC,EAAE;MAC1B,OAAO,wBAAwB;IACjC;IACA,MAAME,MAAM,GAAGN,IAAI,CAACA,IAAI,CACrBO,GAAG,CAAEC,KAAK,IAAK;MACd,OAAQ;AAChB;AACA,IAAIA,KAAK,CAACC,IAAI,CAAC,MAAM,CAAE,EAAC;IAClB,CAAC,CAAC,CACDA,IAAI,CAAC,IAAI,CAAC;IACb,OAAOH,MAAM;EACf;EAEA,MAAMI,GAAG,GAA2B;IAClC,MAAMC,UAAU,GAAG,MAAM,IAAI,CAACf,UAAU,EAAE;IAC1C,MAAMgB,YAAY,GAAG,IAAI,CAACP,UAAU,CAACM,UAAU,CAAC;IAChD,MAAME,MAAqB,GAAG;MAC5BC,QAAQ,EAAE;QACRC,IAAI,EAAE,IAAI,CAACA,IAAI;QACfC,WAAW,EAAE,IAAI,CAACA;MACpB,CAAC;MACDhB,IAAI,EAAEW,UAAU,CAACX,IAAI;MACrBD,OAAO,EAAEY,UAAU,CAACZ,OAAO;MAC3Ba;IACF,CAAC;IAED,IAAID,UAAU,CAACZ,OAAO,EAAE;MACtBc,MAAM,CAACd,OAAO,GAAGY,UAAU,CAACZ,OAAO;IACrC;IACA,OAAOc,MAAM;EACf;EAEA,MAAMI,mBAAmB,CAACC,UAAuB,EAAE;IACjD,MAAML,MAAM,GAAG,MAAM,IAAI,CAACjB,UAAU,EAAE;IACtC,IAAI,CAACiB,MAAM,CAACb,IAAI,CAACI,MAAM,EAAE;MACvB,OAAO,CAAC;IACV;;IACA,MAAMe,MAAM,GAAG,IAAAC,cAAI,EAACP,MAAM,CAACb,IAAI,CAACqB,IAAI,EAAE,CAAC;IACvC,MAAMC,sBAAsB,GAAGJ,UAAU,CAACK,MAAM,CAAEC,SAAS,IAAKL,MAAM,CAACM,QAAQ,CAACD,SAAS,CAACE,EAAE,CAACC,QAAQ,EAAE,CAAC,CAAC;IACzGL,sBAAsB,CAACM,OAAO,CAAEJ,SAAS,IAAK;MAC5CA,SAAS,CAACK,KAAK,CAACC,MAAM,CAACC,WAAW,CAACC,gCAAa,CAACC,oBAAoB,CAAC,CAACjC,IAAI,GAAG,IAAI;IACpF,CAAC,CAAC;EACJ;AACF;AAAC"}