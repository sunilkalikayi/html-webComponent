{"version":3,"names":["chalk","require","OnTestsChanged","TesterService","constructor","workspace","logger","pubsub","devFiles","render","env","descriptor","getDescriptor","id","displayName","version","highlight","config","language","ignoreIllegals","environment","getTester","undefined","tester","icon","displayConfig","onTestRunComplete","callback","_callback","run","context","options","specFiles","ComponentMap","as","components","component","detectTestFiles","testCount","toArray","reduce","acc","specs","length","componentWithTests","ui","consoleWarning","cyan","Tests","console","patterns","componentDir","componentPatterns","getDevPatterns","TesterAspect","paths","map","pattern","path","resolve","relative","additionalHostDependencies","getAdditionalTestHostDependencies","testerContext","Object","assign","release","rootPath","debug","watch","coverage","results","forEach","publish","testsChanged","componentId","toString","testsResults","loading","test"],"sources":["tester.service.tsx"],"sourcesContent":["import { Logger } from '@teambit/logger';\nimport { resolve } from 'path';\nimport React from 'react';\nimport { Text, Newline } from 'ink';\nimport { EnvService, ExecutionContext, EnvDefinition } from '@teambit/envs';\nimport { ComponentMap } from '@teambit/component';\nimport { Workspace } from '@teambit/workspace';\nimport highlight from 'cli-highlight';\nimport { PubSubEngine } from 'graphql-subscriptions';\nimport { DevFilesMain } from '@teambit/dev-files';\nimport { Tester, Tests, CallbackFn } from './tester';\nimport { TesterAspect } from './tester.aspect';\nimport { TesterOptions } from './tester.main.runtime';\nimport { detectTestFiles } from './utils';\n\nconst chalk = require('chalk');\n\nexport const OnTestsChanged = 'OnTestsChanged';\n\nexport type TesterDescriptor = {\n  /**\n   * id of the tester (e.g. jest/mocha)\n   */\n  id: string;\n\n  /**\n   * display name of the tester (e.g. Jest / Mocha)\n   */\n  displayName: string;\n\n  /**\n   * icon of the configured tester.\n   */\n  icon: string;\n\n  /**\n   * string containing the config for display.\n   */\n  config: string;\n\n  version?: string;\n};\n\nexport class TesterService implements EnvService<Tests, TesterDescriptor> {\n  name = 'tester';\n\n  constructor(\n    readonly workspace: Workspace,\n\n    private logger: Logger,\n\n    private pubsub: PubSubEngine,\n\n    private devFiles: DevFilesMain\n  ) {}\n\n  _callback: CallbackFn | undefined;\n\n  render(env: EnvDefinition) {\n    const descriptor = this.getDescriptor(env);\n    return (\n      <Text key={descriptor?.id}>\n        <Text color=\"cyan\">configured tester: </Text>\n        <Text>\n          {descriptor?.id} ({descriptor?.displayName} @ {descriptor?.version})\n        </Text>\n        <Newline />\n        <Text underline color=\"cyan\">\n          tester config:\n        </Text>\n        <Newline />\n        <Text>\n          {/* refactor a separate component which highlights for cli */}\n          {highlight(descriptor?.config || '', { language: 'javascript', ignoreIllegals: true })}\n        </Text>\n        <Newline />\n      </Text>\n    );\n  }\n\n  getDescriptor(environment: EnvDefinition) {\n    if (!environment.env.getTester) return undefined;\n    const tester: Tester = environment.env.getTester();\n\n    return {\n      id: tester.id || '',\n      displayName: tester.displayName || '',\n      icon: tester.icon || '',\n      config: tester.displayConfig ? tester.displayConfig() : '',\n      version: tester.version ? tester.version() : '?',\n    };\n  }\n\n  onTestRunComplete(callback: CallbackFn) {\n    this._callback = callback;\n  }\n\n  async run(context: ExecutionContext, options: TesterOptions): Promise<Tests> {\n    const tester: Tester = context.env.getTester();\n    const specFiles = ComponentMap.as(context.components, (component) => {\n      return detectTestFiles(component, this.devFiles);\n    });\n    const testCount = specFiles.toArray().reduce((acc, [, specs]) => acc + specs.length, 0);\n\n    const componentWithTests = specFiles.toArray().reduce((acc: number, [, specs]) => {\n      if (specs.length > 0) acc += 1;\n      return acc;\n    }, 0);\n\n    if (testCount === 0 && !options.ui) {\n      this.logger.consoleWarning(`no tests found for environment ${chalk.cyan(context.id)}\\n`);\n      return new Tests([]);\n    }\n\n    if (!options.ui)\n      this.logger.console(`testing ${componentWithTests} components with environment ${chalk.cyan(context.id)}\\n`);\n\n    const patterns = ComponentMap.as(context.components, (component) => {\n      const componentDir = this.workspace.componentDir(component.id);\n      const componentPatterns = this.devFiles.getDevPatterns(component, TesterAspect.id);\n      return {\n        componentDir,\n        paths:\n          componentPatterns.map((pattern: string) => ({\n            path: resolve(componentDir, pattern),\n            relative: pattern,\n          })) || [],\n      };\n    });\n\n    let additionalHostDependencies = [];\n    if (\n      context.env.getAdditionalTestHostDependencies &&\n      typeof context.env.getAdditionalTestHostDependencies === 'function'\n    ) {\n      additionalHostDependencies = await context.env.getAdditionalTestHostDependencies();\n    }\n\n    const testerContext = Object.assign(context, {\n      release: false,\n      specFiles,\n      patterns,\n      rootPath: this.workspace.path,\n      workspace: this.workspace,\n      debug: options.debug,\n      watch: options.watch,\n      ui: options.ui,\n      coverage: options.coverage,\n      additionalHostDependencies,\n    });\n\n    if (options.watch && options.ui && tester.watch) {\n      if (tester.onTestRunComplete) {\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\n        tester.onTestRunComplete((results) => {\n          if (this._callback) this._callback(results);\n          results.components.forEach((component) => {\n            // eslint-disable-next-line @typescript-eslint/no-floating-promises\n            this.pubsub.publish(OnTestsChanged, {\n              testsChanged: {\n                id: component.componentId.toString(),\n                testsResults: component.results,\n                loading: component.loading,\n              },\n            });\n          });\n        });\n      }\n\n      return tester.watch(testerContext);\n    }\n\n    const results = await tester.test(testerContext);\n\n    return results;\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAEA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAEA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAGA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAEA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAEA,MAAMA,KAAK,GAAGC,OAAO,CAAC,OAAO,CAAC;AAEvB,MAAMC,cAAc,GAAG,gBAAgB;AAAC;AA0BxC,MAAMC,aAAa,CAAgD;EAGxEC,WAAW,CACAC,SAAoB,EAErBC,MAAc,EAEdC,MAAoB,EAEpBC,QAAsB,EAC9B;IAAA,KAPSH,SAAoB,GAApBA,SAAoB;IAAA,KAErBC,MAAc,GAAdA,MAAc;IAAA,KAEdC,MAAoB,GAApBA,MAAoB;IAAA,KAEpBC,QAAsB,GAAtBA,QAAsB;IAAA,8CATzB,QAAQ;IAAA;EAUZ;EAIHC,MAAM,CAACC,GAAkB,EAAE;IACzB,MAAMC,UAAU,GAAG,IAAI,CAACC,aAAa,CAACF,GAAG,CAAC;IAC1C,oBACE,+BAAC,WAAI;MAAC,GAAG,EAAEC,UAAU,aAAVA,UAAU,uBAAVA,UAAU,CAAEE;IAAG,gBACxB,+BAAC,WAAI;MAAC,KAAK,EAAC;IAAM,yBAA2B,eAC7C,+BAAC,WAAI,QACFF,UAAU,aAAVA,UAAU,uBAAVA,UAAU,CAAEE,EAAE,QAAIF,UAAU,aAAVA,UAAU,uBAAVA,UAAU,CAAEG,WAAW,SAAKH,UAAU,aAAVA,UAAU,uBAAVA,UAAU,CAAEI,OAAO,MAC7D,eACP,+BAAC,cAAO,OAAG,eACX,+BAAC,WAAI;MAAC,SAAS;MAAC,KAAK,EAAC;IAAM,oBAErB,eACP,+BAAC,cAAO,OAAG,eACX,+BAAC,WAAI,QAEF,IAAAC,uBAAS,EAAC,CAAAL,UAAU,aAAVA,UAAU,uBAAVA,UAAU,CAAEM,MAAM,KAAI,EAAE,EAAE;MAAEC,QAAQ,EAAE,YAAY;MAAEC,cAAc,EAAE;IAAK,CAAC,CAAC,CACjF,eACP,+BAAC,cAAO,OAAG,CACN;EAEX;EAEAP,aAAa,CAACQ,WAA0B,EAAE;IACxC,IAAI,CAACA,WAAW,CAACV,GAAG,CAACW,SAAS,EAAE,OAAOC,SAAS;IAChD,MAAMC,MAAc,GAAGH,WAAW,CAACV,GAAG,CAACW,SAAS,EAAE;IAElD,OAAO;MACLR,EAAE,EAAEU,MAAM,CAACV,EAAE,IAAI,EAAE;MACnBC,WAAW,EAAES,MAAM,CAACT,WAAW,IAAI,EAAE;MACrCU,IAAI,EAAED,MAAM,CAACC,IAAI,IAAI,EAAE;MACvBP,MAAM,EAAEM,MAAM,CAACE,aAAa,GAAGF,MAAM,CAACE,aAAa,EAAE,GAAG,EAAE;MAC1DV,OAAO,EAAEQ,MAAM,CAACR,OAAO,GAAGQ,MAAM,CAACR,OAAO,EAAE,GAAG;IAC/C,CAAC;EACH;EAEAW,iBAAiB,CAACC,QAAoB,EAAE;IACtC,IAAI,CAACC,SAAS,GAAGD,QAAQ;EAC3B;EAEA,MAAME,GAAG,CAACC,OAAyB,EAAEC,OAAsB,EAAkB;IAC3E,MAAMR,MAAc,GAAGO,OAAO,CAACpB,GAAG,CAACW,SAAS,EAAE;IAC9C,MAAMW,SAAS,GAAGC,yBAAY,CAACC,EAAE,CAACJ,OAAO,CAACK,UAAU,EAAGC,SAAS,IAAK;MACnE,OAAO,IAAAC,wBAAe,EAACD,SAAS,EAAE,IAAI,CAAC5B,QAAQ,CAAC;IAClD,CAAC,CAAC;IACF,MAAM8B,SAAS,GAAGN,SAAS,CAACO,OAAO,EAAE,CAACC,MAAM,CAAC,CAACC,GAAG,EAAE,GAAGC,KAAK,CAAC,KAAKD,GAAG,GAAGC,KAAK,CAACC,MAAM,EAAE,CAAC,CAAC;IAEvF,MAAMC,kBAAkB,GAAGZ,SAAS,CAACO,OAAO,EAAE,CAACC,MAAM,CAAC,CAACC,GAAW,EAAE,GAAGC,KAAK,CAAC,KAAK;MAChF,IAAIA,KAAK,CAACC,MAAM,GAAG,CAAC,EAAEF,GAAG,IAAI,CAAC;MAC9B,OAAOA,GAAG;IACZ,CAAC,EAAE,CAAC,CAAC;IAEL,IAAIH,SAAS,KAAK,CAAC,IAAI,CAACP,OAAO,CAACc,EAAE,EAAE;MAClC,IAAI,CAACvC,MAAM,CAACwC,cAAc,CAAE,kCAAiC9C,KAAK,CAAC+C,IAAI,CAACjB,OAAO,CAACjB,EAAE,CAAE,IAAG,CAAC;MACxF,OAAO,KAAImC,eAAK,EAAC,EAAE,CAAC;IACtB;IAEA,IAAI,CAACjB,OAAO,CAACc,EAAE,EACb,IAAI,CAACvC,MAAM,CAAC2C,OAAO,CAAE,WAAUL,kBAAmB,gCAA+B5C,KAAK,CAAC+C,IAAI,CAACjB,OAAO,CAACjB,EAAE,CAAE,IAAG,CAAC;IAE9G,MAAMqC,QAAQ,GAAGjB,yBAAY,CAACC,EAAE,CAACJ,OAAO,CAACK,UAAU,EAAGC,SAAS,IAAK;MAClE,MAAMe,YAAY,GAAG,IAAI,CAAC9C,SAAS,CAAC8C,YAAY,CAACf,SAAS,CAACvB,EAAE,CAAC;MAC9D,MAAMuC,iBAAiB,GAAG,IAAI,CAAC5C,QAAQ,CAAC6C,cAAc,CAACjB,SAAS,EAAEkB,uBAAY,CAACzC,EAAE,CAAC;MAClF,OAAO;QACLsC,YAAY;QACZI,KAAK,EACHH,iBAAiB,CAACI,GAAG,CAAEC,OAAe,KAAM;UAC1CC,IAAI,EAAE,IAAAC,eAAO,EAACR,YAAY,EAAEM,OAAO,CAAC;UACpCG,QAAQ,EAAEH;QACZ,CAAC,CAAC,CAAC,IAAI;MACX,CAAC;IACH,CAAC,CAAC;IAEF,IAAII,0BAA0B,GAAG,EAAE;IACnC,IACE/B,OAAO,CAACpB,GAAG,CAACoD,iCAAiC,IAC7C,OAAOhC,OAAO,CAACpB,GAAG,CAACoD,iCAAiC,KAAK,UAAU,EACnE;MACAD,0BAA0B,GAAG,MAAM/B,OAAO,CAACpB,GAAG,CAACoD,iCAAiC,EAAE;IACpF;IAEA,MAAMC,aAAa,GAAGC,MAAM,CAACC,MAAM,CAACnC,OAAO,EAAE;MAC3CoC,OAAO,EAAE,KAAK;MACdlC,SAAS;MACTkB,QAAQ;MACRiB,QAAQ,EAAE,IAAI,CAAC9D,SAAS,CAACqD,IAAI;MAC7BrD,SAAS,EAAE,IAAI,CAACA,SAAS;MACzB+D,KAAK,EAAErC,OAAO,CAACqC,KAAK;MACpBC,KAAK,EAAEtC,OAAO,CAACsC,KAAK;MACpBxB,EAAE,EAAEd,OAAO,CAACc,EAAE;MACdyB,QAAQ,EAAEvC,OAAO,CAACuC,QAAQ;MAC1BT;IACF,CAAC,CAAC;IAEF,IAAI9B,OAAO,CAACsC,KAAK,IAAItC,OAAO,CAACc,EAAE,IAAItB,MAAM,CAAC8C,KAAK,EAAE;MAC/C,IAAI9C,MAAM,CAACG,iBAAiB,EAAE;QAC5B;QACAH,MAAM,CAACG,iBAAiB,CAAE6C,OAAO,IAAK;UACpC,IAAI,IAAI,CAAC3C,SAAS,EAAE,IAAI,CAACA,SAAS,CAAC2C,OAAO,CAAC;UAC3CA,OAAO,CAACpC,UAAU,CAACqC,OAAO,CAAEpC,SAAS,IAAK;YACxC;YACA,IAAI,CAAC7B,MAAM,CAACkE,OAAO,CAACvE,cAAc,EAAE;cAClCwE,YAAY,EAAE;gBACZ7D,EAAE,EAAEuB,SAAS,CAACuC,WAAW,CAACC,QAAQ,EAAE;gBACpCC,YAAY,EAAEzC,SAAS,CAACmC,OAAO;gBAC/BO,OAAO,EAAE1C,SAAS,CAAC0C;cACrB;YACF,CAAC,CAAC;UACJ,CAAC,CAAC;QACJ,CAAC,CAAC;MACJ;MAEA,OAAOvD,MAAM,CAAC8C,KAAK,CAACN,aAAa,CAAC;IACpC;IAEA,MAAMQ,OAAO,GAAG,MAAMhD,MAAM,CAACwD,IAAI,CAAChB,aAAa,CAAC;IAEhD,OAAOQ,OAAO;EAChB;AACF;AAAC"}