{"version":3,"names":["wcComponentFields","gql","WORKSPACE","COMPONENT_SUBSCRIPTION_ADDED","COMPONENT_SUBSCRIPTION_CHANGED","COMPONENT_SUBSCRIPTION_REMOVED","useWorkspace","options","useDataQuery","data","subscribeToMore","rest","optionsRef","useLatest","useEffect","unSubCompAddition","document","updateQuery","prev","subscriptionData","update","addedComponent","componentAdded","component","componentExists","workspace","components","find","ComponentID","isEqualObj","id","ignoreVersion","setTimeout","current","onComponentAdded","ComponentModel","from","unSubCompChange","updatedComponent","componentChanged","onComponentUpdated","map","name","unSubCompRemoved","idsToRemove","componentRemoved","componentIds","length","onComponentRemoved","fromObject","filter","every","useMemo","Workspace","undefined"],"sources":["use-workspace.ts"],"sourcesContent":["import { useEffect, useMemo } from 'react';\nimport { ComponentModel } from '@teambit/component';\nimport useLatest from '@react-hook/latest';\nimport { useDataQuery } from '@teambit/ui-foundation.ui.hooks.use-data-query';\nimport { gql } from '@apollo/client';\nimport { ComponentID, ComponentIdObj } from '@teambit/component-id';\n\nimport { Workspace } from './workspace-model';\n\ntype UseWorkspaceOptions = {\n  onComponentAdded?: (component: ComponentModel[]) => void;\n  onComponentUpdated?: (component: ComponentModel[]) => void;\n  onComponentRemoved?: (compId: ComponentID[]) => void;\n};\ntype RawComponent = { id: ComponentIdObj };\n\nconst wcComponentFields = gql`\n  fragment wcComponentFields on Component {\n    id {\n      name\n      version\n      scope\n    }\n    compositions {\n      identifier\n    }\n    description\n    issuesCount\n    status {\n      isOutdated\n      isNew\n      isInScope\n      isStaged\n      modifyInfo {\n        hasModifiedFiles\n        hasModifiedDependencies\n      }\n      isDeleted\n    }\n    preview {\n      isScaling\n    }\n    deprecation {\n      isDeprecate\n      newId\n    }\n    server {\n      env\n      url\n    }\n    env {\n      id\n      icon\n    }\n  }\n`;\n\nconst WORKSPACE = gql`\n  query workspace {\n    workspace {\n      name\n      path\n      icon\n      components {\n        ...wcComponentFields\n      }\n    }\n  }\n  ${wcComponentFields}\n`;\n\nconst COMPONENT_SUBSCRIPTION_ADDED = gql`\n  subscription OnComponentAdded {\n    componentAdded {\n      component {\n        ...wcComponentFields\n      }\n    }\n  }\n  ${wcComponentFields}\n`;\n\nconst COMPONENT_SUBSCRIPTION_CHANGED = gql`\n  subscription OnComponentChanged {\n    componentChanged {\n      component {\n        ...wcComponentFields\n      }\n    }\n  }\n  ${wcComponentFields}\n`;\n\nconst COMPONENT_SUBSCRIPTION_REMOVED = gql`\n  subscription OnComponentRemoved {\n    componentRemoved {\n      componentIds {\n        name\n        version\n        scope\n      }\n    }\n  }\n`;\n\nexport function useWorkspace(options: UseWorkspaceOptions = {}) {\n  const { data, subscribeToMore, ...rest } = useDataQuery(WORKSPACE);\n  const optionsRef = useLatest(options);\n\n  useEffect(() => {\n    const unSubCompAddition = subscribeToMore({\n      document: COMPONENT_SUBSCRIPTION_ADDED,\n      updateQuery: (prev, { subscriptionData }) => {\n        const update = subscriptionData.data;\n        const addedComponent = update?.componentAdded?.component;\n        if (!addedComponent) return prev;\n\n        const componentExists = prev.workspace.components.find((component: any) =>\n          ComponentID.isEqualObj(component.id, addedComponent.id, { ignoreVersion: true })\n        );\n        if (componentExists) return prev;\n\n        // side effect - trigger observers\n        setTimeout(() => optionsRef.current.onComponentAdded?.([ComponentModel.from(addedComponent)]));\n\n        return {\n          ...prev,\n          workspace: {\n            ...prev.workspace,\n            components: [...prev.workspace.components, addedComponent],\n          },\n        };\n      },\n    });\n\n    const unSubCompChange = subscribeToMore({\n      document: COMPONENT_SUBSCRIPTION_CHANGED,\n      updateQuery: (prev, { subscriptionData }) => {\n        const update = subscriptionData.data;\n        if (!update) return prev;\n\n        const updatedComponent = update.componentChanged.component;\n        // side effect - trigger observers\n        setTimeout(() => optionsRef.current.onComponentUpdated?.([ComponentModel.from(updatedComponent)]));\n\n        return {\n          ...prev,\n          workspace: {\n            ...prev.workspace,\n            components: prev.workspace.components.map((component) =>\n              component.id.name === updatedComponent.id.name ? updatedComponent : component\n            ),\n          },\n        };\n      },\n    });\n\n    const unSubCompRemoved = subscribeToMore({\n      document: COMPONENT_SUBSCRIPTION_REMOVED,\n      updateQuery: (prev, { subscriptionData }) => {\n        const idsToRemove: ComponentIdObj[] | undefined = subscriptionData.data?.componentRemoved?.componentIds;\n        if (!idsToRemove || idsToRemove.length === 0) return prev;\n\n        // side effect - trigger observers\n        setTimeout(() => optionsRef.current.onComponentRemoved?.(idsToRemove.map((id) => ComponentID.fromObject(id))));\n\n        return {\n          ...prev,\n          workspace: {\n            ...prev.workspace,\n            components: prev.workspace.components.filter((component: RawComponent) =>\n              idsToRemove.every((id) => !ComponentID.isEqualObj(id, component.id))\n            ),\n          },\n        };\n      },\n    });\n\n    // TODO - sub to component removal\n\n    return () => {\n      unSubCompAddition();\n      unSubCompChange();\n      unSubCompRemoved();\n    };\n  }, [optionsRef]);\n\n  const workspace = useMemo(() => {\n    return data?.workspace ? Workspace.from(data?.workspace) : undefined;\n  }, [data?.workspace]);\n\n  return {\n    workspace,\n    subscribeToMore,\n    ...rest,\n  };\n}\n"],"mappings":"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"}