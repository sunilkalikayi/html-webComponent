{"version":3,"names":["ComponentLogMain","constructor","workspace","getLogs","id","isRemote","shortHash","consumer","bitId","BitId","parse","remote","getRemoteByName","scope","log","ConsumerNotFound","componentId","resolveComponentId","logs","forEach","date","Date","parseInt","toLocaleString","undefined","getLogsWithParents","graph","buildSnapGraph","sorted","toposort","map","node","stringifyLogInfoOneLine","attr","logInfo","parents","length","join","chalk","yellow","hash","username","message","provider","cli","community","componentLog","register","LogCmd","getDocsDomain","CLIAspect","WorkspaceAspect","CommunityAspect","MainRuntime","ComponentLogAspect","addRuntime"],"sources":["component-log.main.runtime.ts"],"sourcesContent":["import { CLIAspect, CLIMain, MainRuntime } from '@teambit/cli';\nimport { BitId } from '@teambit/legacy-bit-id';\nimport WorkspaceAspect, { Workspace } from '@teambit/workspace';\nimport { CommunityAspect } from '@teambit/community';\nimport type { CommunityMain } from '@teambit/community';\n\nimport { ConsumerNotFound } from '@teambit/legacy/dist/consumer/exceptions';\nimport chalk from 'chalk';\nimport getRemoteByName from '@teambit/legacy/dist/remotes/get-remote-by-name';\nimport { ComponentLogAspect } from './component-log.aspect';\nimport LogCmd from './log-cmd';\nimport { buildSnapGraph } from './snap-graph';\n\nexport class ComponentLogMain {\n  constructor(private workspace: Workspace | undefined) {}\n\n  async getLogs(id: string, isRemote: boolean, shortHash = false) {\n    if (isRemote) {\n      const consumer = this.workspace?.consumer;\n      const bitId: BitId = BitId.parse(id, true);\n      const remote = await getRemoteByName(bitId.scope as string, consumer);\n      return remote.log(bitId);\n    }\n    if (!this.workspace) throw new ConsumerNotFound();\n    const componentId = await this.workspace.resolveComponentId(id);\n    const logs = await this.workspace.scope.getLogs(componentId, shortHash);\n    logs.forEach((log) => {\n      log.date = log.date ? new Date(parseInt(log.date)).toLocaleString() : undefined;\n    });\n    return logs;\n  }\n\n  async getLogsWithParents(id: string) {\n    const logs = await this.getLogs(id, false, true);\n    const graph = buildSnapGraph(logs);\n    const sorted = graph.toposort();\n    return sorted.map((node) => this.stringifyLogInfoOneLine(node.attr));\n  }\n\n  private stringifyLogInfoOneLine(logInfo: ComponentLogInfo) {\n    const parents = logInfo.parents.length ? `Parent(s): ${logInfo.parents.join(', ')}` : '<N/A>';\n    return `${chalk.yellow(logInfo.hash)} ${logInfo.username || ''} ${logInfo.date || ''} ${\n      logInfo.message\n    }, ${parents}`;\n  }\n\n  static slots = [];\n  static dependencies = [CLIAspect, WorkspaceAspect, CommunityAspect];\n  static runtime = MainRuntime;\n  static async provider([cli, workspace, community]: [CLIMain, Workspace, CommunityMain]) {\n    const componentLog = new ComponentLogMain(workspace);\n    cli.register(new LogCmd(componentLog, community.getDocsDomain()));\n    return componentLog;\n  }\n}\n\nComponentLogAspect.addRuntime(ComponentLogMain);\n\nexport type ComponentLogInfo = {\n  hash: string;\n  message: string;\n  onLane?: boolean;\n  parents: string[];\n  username?: string;\n  email?: string;\n  date?: string;\n  tag?: string;\n};\n"],"mappings":"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"}