{"version":3,"names":["CommandRunner","constructor","command","args","flags","commandName","parseCommandName","name","runCommand","bootstrapCommand","runMigrateIfNeeded","determineConsoleWritingDuringCommand","json","runJsonHandler","shouldRunRender","runRenderHandler","report","runReportHandler","err","handleErrorAndExit","internal","Error","Analytics","init","logger","info","token","TOKEN_FLAG_NAME","globalFlags","toString","isTerminal","process","stdout","isTTY","Boolean","render","result","code","data","writeAndExit","JSON","stringify","loader","off","toRenderResult","waitUntilExit","exitAfterFlush","exitCode","on","start","shouldWriteToConsole","log","logValue","undefined","switchToConsoleLogger","write","migration","debug","migrate","obj","isRenderResult","hasOwnProperty"],"sources":["command-runner.ts"],"sourcesContent":["import { render } from 'ink';\nimport { migrate } from '@teambit/legacy/dist/api/consumer';\nimport logger, { LoggerLevel } from '@teambit/legacy/dist/logger/logger';\nimport { CLIArgs, Command, Flags, RenderResult } from '@teambit/legacy/dist/cli/command';\nimport { parseCommandName } from '@teambit/legacy/dist/cli/command-registry';\nimport loader from '@teambit/legacy/dist/cli/loader';\nimport { handleErrorAndExit } from '@teambit/legacy/dist/cli/handle-errors';\nimport { TOKEN_FLAG_NAME } from '@teambit/legacy/dist/constants';\nimport globalFlags from '@teambit/legacy/dist/cli/global-flags';\nimport { Analytics } from '@teambit/legacy/dist/analytics/analytics';\n\nexport class CommandRunner {\n  private commandName: string;\n  constructor(private command: Command, private args: CLIArgs, private flags: Flags) {\n    this.commandName = parseCommandName(this.command.name);\n  }\n\n  /**\n   * run command using one of the handler, \"json\"/\"report\"/\"render\". once done, exit the process.\n   */\n  async runCommand() {\n    try {\n      this.bootstrapCommand();\n      await this.runMigrateIfNeeded();\n      this.determineConsoleWritingDuringCommand();\n      if (this.flags.json) {\n        return await this.runJsonHandler();\n      }\n      if (this.shouldRunRender()) {\n        return await this.runRenderHandler();\n      }\n      if (this.command.report) {\n        return await this.runReportHandler();\n      }\n    } catch (err: any) {\n      return handleErrorAndExit(err, this.commandName, this.command.internal);\n    }\n\n    throw new Error(`command \"${this.commandName}\" doesn't implement \"render\" nor \"report\" methods`);\n  }\n\n  private bootstrapCommand() {\n    Analytics.init(this.commandName, this.flags, this.args);\n    logger.info(`[*] started a new command: \"${this.commandName}\" with the following data:`, {\n      args: this.args,\n      flags: this.flags,\n    });\n    const token = this.flags[TOKEN_FLAG_NAME];\n    if (token) {\n      globalFlags.token = token.toString();\n    }\n  }\n\n  /**\n   * when both \"render\" and \"report\" were implemented, check whether it's a terminal.\n   * if it's a terminal, use \"render\", if not, use \"report\" because \"report\" is just a string\n   */\n  private shouldRunRender() {\n    const isTerminal = process.stdout.isTTY;\n    if (this.command.report && !isTerminal) {\n      return false;\n    }\n    return Boolean(this.command.render);\n  }\n\n  /**\n   * this works for both, Harmony commands and Legacy commands (the legacy-command-adapter\n   * implements json() method)\n   */\n  private async runJsonHandler() {\n    if (!this.flags.json) return null;\n    if (!this.command.json) throw new Error(`command \"${this.commandName}\" doesn't implement \"json\" method`);\n    const result = await this.command.json(this.args, this.flags);\n    const code = result.code || 0;\n    const data = result.data || result;\n    return this.writeAndExit(JSON.stringify(data, null, 2), code);\n  }\n\n  private async runRenderHandler() {\n    if (!this.command.render) throw new Error('runRenderHandler expects command.render to be implemented');\n    const result = await this.command.render(this.args, this.flags);\n    loader.off();\n\n    const { data, code } = toRenderResult(result);\n\n    const { waitUntilExit } = render(data);\n    await waitUntilExit();\n    return logger.exitAfterFlush(code, this.commandName);\n  }\n\n  private async runReportHandler() {\n    if (!this.command.report) throw new Error('runReportHandler expects command.report to be implemented');\n    const result = await this.command.report(this.args, this.flags);\n    loader.off();\n    const data = typeof result === 'string' ? result : result.data;\n    const exitCode = typeof result === 'string' ? 0 : result.code;\n    return this.writeAndExit(`${data}\\n`, exitCode);\n  }\n\n  /**\n   * the loader and logger.console write output to the console during the command execution.\n   * for internals commands, such as, _put, _fetch, the command.loader = false.\n   */\n  private determineConsoleWritingDuringCommand() {\n    if (this.command.loader && !this.flags.json && !this.flags['get-yargs-completions']) {\n      loader.on();\n      loader.start(`running command \"${this.commandName}\"...`);\n      logger.shouldWriteToConsole = true;\n    } else {\n      loader.off();\n      logger.shouldWriteToConsole = false;\n    }\n    if (this.flags.log) {\n      // probably not necessary anymore. it is handled in src/logger - determineWritingLogToScreen()\n      const logValue = typeof this.flags.log === 'string' ? this.flags.log : undefined;\n      logger.switchToConsoleLogger(logValue as LoggerLevel);\n    }\n  }\n\n  private async writeAndExit(data: string, exitCode: number) {\n    // eslint-disable-next-line @typescript-eslint/no-misused-promises\n    return process.stdout.write(data, async () => logger.exitAfterFlush(exitCode, this.commandName, data));\n  }\n\n  private async runMigrateIfNeeded(): Promise<any> {\n    // @ts-ignore LegacyCommandAdapter has .migration\n    if (this.command.migration) {\n      logger.debug('Checking if a migration is needed');\n      // @ts-ignore AUTO-ADDED-AFTER-MIGRATION-PLEASE-FIX!\n      return migrate(null, false);\n    }\n    return null;\n  }\n}\n\nfunction toRenderResult(obj: RenderResult | React.ReactElement) {\n  return isRenderResult(obj) ? obj : { data: obj, code: 0 };\n}\n\nfunction isRenderResult(obj: RenderResult | any): obj is RenderResult {\n  // eslint-disable-next-line no-prototype-builtins\n  return typeof obj === 'object' && typeof obj.code === 'number' && obj.hasOwnProperty('data');\n}\n"],"mappings":"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"}