{"version":3,"names":["DEFAULT_TAR_DIR_IN_CAPSULE","PACK_CONCURRENCY","TAR_FILE_ARTIFACT_NAME","Packer","constructor","isolator","logger","host","scope","legacyPacker","LegacyPacker","packComponent","componentId","scopePath","options","loadScopeFromCache","undefined","legacyScope","LegacyScope","load","ScopeNotFound","capsule","getCapsule","res","packCapsule","writeOptions","dryRun","Object","assign","_","omit","id","packMultipleCapsules","capsules","override","omitFullTarPath","results","pMap","concurrency","concreteWriteOpts","outDir","packResult","npmPack","path","component","fieldsToRemove","push","metadata","omitBy","isUndefined","value","errors","warnings","startTime","endTime","getArtifactDefInCapsule","rootDir","def","name","globPatterns","componentIdStr","resolveComponentId","network","isolateComponents","baseDir","seedersCapsules","Error"],"sources":["packer.ts"],"sourcesContent":["import _ from 'lodash';\nimport { ComponentFactory } from '@teambit/component';\nimport { ComponentResult, ArtifactDefinition } from '@teambit/builder';\nimport { Capsule, IsolatorMain } from '@teambit/isolator';\nimport { ScopeMain } from '@teambit/scope';\nimport LegacyScope from '@teambit/legacy/dist/scope/scope';\nimport { Packer as LegacyPacker, PackWriteOptions, PackOptions } from '@teambit/legacy/dist/pack';\nimport { Logger } from '@teambit/logger';\nimport pMap from 'p-map';\n\n// @ts-ignore (for some reason the tsc -w not found this)\nimport { ScopeNotFound } from './exceptions/scope-not-found';\n\nexport { PackOptions };\n\nexport type PackResult = Omit<ComponentResult, 'component'>;\nexport type PackResultWithId = PackResult & {\n  id: string;\n};\n\nconst DEFAULT_TAR_DIR_IN_CAPSULE = 'package-tar';\nconst PACK_CONCURRENCY = 10;\nexport const TAR_FILE_ARTIFACT_NAME = 'package tar file';\n\nexport class Packer {\n  legacyPacker: LegacyPacker;\n  constructor(\n    private isolator: IsolatorMain,\n    private logger: Logger,\n    private host: ComponentFactory,\n    private scope?: ScopeMain\n  ) {\n    this.legacyPacker = new LegacyPacker(this.logger);\n  }\n\n  async packComponent(\n    componentId: string,\n    scopePath: string | undefined,\n    options: PackOptions\n  ): Promise<PackResultWithId> {\n    // By default do not load scope from cache when packing\n    const loadScopeFromCache =\n      options && options.loadScopeFromCache !== undefined ? !!options.loadScopeFromCache : false;\n    const legacyScope = scopePath ? await LegacyScope.load(scopePath, loadScopeFromCache) : this.scope?.legacyScope;\n    if (!legacyScope) {\n      throw new ScopeNotFound(scopePath);\n    }\n    const capsule = await this.getCapsule(componentId, legacyScope);\n    const res = await this.packCapsule(capsule, options.writeOptions, options.dryRun);\n\n    return Object.assign({}, _.omit(res, ['component']), { id: componentId });\n  }\n\n  async packMultipleCapsules(\n    capsules: Capsule[],\n    writeOptions: PackWriteOptions = { override: true },\n    dryRun = false,\n    omitFullTarPath = false\n  ): Promise<ComponentResult[]> {\n    // const description = `packing components${dryRun ? ' (dry-run)' : ''}`;\n    const results = pMap(\n      capsules,\n      (capsule) => {\n        return this.packCapsule(capsule, writeOptions, dryRun, omitFullTarPath);\n      },\n      { concurrency: PACK_CONCURRENCY }\n    );\n    return results;\n  }\n\n  async packCapsule(\n    capsule: Capsule,\n    writeOptions: PackWriteOptions = { override: true },\n    dryRun = false,\n    omitFullTarPath = false\n  ): Promise<ComponentResult> {\n    const concreteWriteOpts = writeOptions;\n    // Set the package-tar as out dir to easily read the tar later\n    concreteWriteOpts.outDir = concreteWriteOpts.outDir ?? DEFAULT_TAR_DIR_IN_CAPSULE;\n    const packResult = await this.legacyPacker.npmPack(\n      capsule.path,\n      concreteWriteOpts.outDir || capsule.path,\n      concreteWriteOpts.override,\n      dryRun\n    );\n    const component = capsule.component;\n    const fieldsToRemove: string[] = [];\n    if (omitFullTarPath) {\n      fieldsToRemove.push('tarPath');\n    }\n    // TODO: @gilad please make sure to fix this type error now that I added lodash types\n    const metadata = _(packResult.metadata).omitBy(_.isUndefined).omit(fieldsToRemove).value() as any;\n\n    return {\n      component,\n      metadata,\n      errors: packResult.errors,\n      warnings: packResult.warnings,\n      startTime: packResult.startTime,\n      endTime: packResult.endTime,\n    };\n  }\n\n  getArtifactDefInCapsule(outDir?: string): ArtifactDefinition {\n    const rootDir = outDir || DEFAULT_TAR_DIR_IN_CAPSULE;\n    const def: ArtifactDefinition = {\n      name: TAR_FILE_ARTIFACT_NAME,\n      globPatterns: [`${rootDir}/*.tgz`],\n    };\n    return def;\n  }\n\n  private async getCapsule(componentIdStr: string, legacyScope: LegacyScope): Promise<Capsule> {\n    const componentId = await this.host.resolveComponentId(componentIdStr);\n    const network = await this.isolator.isolateComponents([componentId], { baseDir: this.host.path }, legacyScope);\n    const capsule = network.seedersCapsules.getCapsule(componentId);\n\n    if (!capsule) throw new Error(`capsule not found for ${componentId}`);\n    return capsule;\n  }\n}\n"],"mappings":"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"}