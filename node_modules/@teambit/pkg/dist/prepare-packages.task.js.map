{"version":3,"names":["PreparePackagesTask","constructor","aspectId","logger","envs","execute","context","writeNpmIgnoreFile","result","componentsResults","Promise","all","capsuleNetwork","seedersCapsules","map","capsule","writeNpmIgnore","executeDistAsRootTask","env","getCompiler","compilerInstance","distDir","graphCapsules","removeSourceFiles","moveDistToRoot","updatePackageJson","excludeDirs","dir","excludeFiles","allFiles","getAllFilesPaths","ignore","debug","join","file","fs","remove","path","from","to","moveSync","compiler","distMainFile","getDistPathBySrcPath","component","state","_consumer","mainFile","distMainFileWithoutDistDir","replace","sep","packageJson","PackageJsonFile","loadFromCapsuleSync","addOrUpdateProperty","write"],"sources":["prepare-packages.task.ts"],"sourcesContent":["import { BuildContext, BuiltTaskResult, BuildTask } from '@teambit/builder';\nimport { Compiler } from '@teambit/compiler';\nimport { Capsule } from '@teambit/isolator';\nimport { EnvsMain } from '@teambit/envs';\nimport { Logger } from '@teambit/logger';\nimport PackageJsonFile from '@teambit/legacy/dist/consumer/component/package-json-file';\nimport fs from 'fs-extra';\nimport path from 'path';\nimport { writeNpmIgnore } from './write-npm-ignore';\n\n/**\n * prepare packages for publishing.\n */\nexport class PreparePackagesTask implements BuildTask {\n  readonly name = 'PreparePackages';\n  readonly location = 'end';\n  constructor(readonly aspectId: string, private logger: Logger, private envs: EnvsMain) {}\n\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  async execute(context: BuildContext): Promise<BuiltTaskResult> {\n    await this.writeNpmIgnoreFile(context);\n    const result = {\n      componentsResults: [],\n    };\n\n    return result;\n  }\n\n  private async writeNpmIgnoreFile(context: BuildContext) {\n    await Promise.all(\n      context.capsuleNetwork.seedersCapsules.map(async (capsule) => {\n        await writeNpmIgnore(capsule, this.envs);\n      })\n    );\n  }\n\n  /**\n   * remove the source files and copy the dists files\n   * into the root of the capsule.\n   * this is needed when components import from other components internal paths. without this task,\n   * the internal paths are the source, so node will throw an error when trying to use them. this\n   * task makes sure that the internal paths point to the consumable code (dists).\n   */\n  private async executeDistAsRootTask(context: BuildContext) {\n    if (!context.env.getCompiler) return;\n    const compilerInstance: Compiler = context.env.getCompiler();\n    const distDir = compilerInstance.distDir;\n\n    await Promise.all(\n      context.capsuleNetwork.graphCapsules.map(async (capsule) => {\n        await this.removeSourceFiles(capsule, distDir);\n        await this.moveDistToRoot(capsule, distDir);\n        await this.updatePackageJson(capsule, compilerInstance, distDir);\n      })\n    );\n  }\n\n  private async removeSourceFiles(capsule: Capsule, distDir: string) {\n    const excludeDirs = [distDir, 'node_modules', 'public', 'bin'].map((dir) => `${dir}/**`);\n    const excludeFiles = ['package.json'];\n    const allFiles = capsule.getAllFilesPaths('.', { ignore: [...excludeDirs, ...excludeFiles] });\n    this.logger.debug(`delete the following files:\\n${allFiles.join('\\n')}`);\n    await Promise.all(allFiles.map((file) => fs.remove(path.join(capsule.path, file))));\n  }\n\n  private async moveDistToRoot(capsule: Capsule, distDir: string) {\n    const from = path.join(capsule.path, distDir);\n    const to = capsule.path;\n    this.logger.debug(`move from ${from} to: ${to}`);\n    // for some reason `fs.move` throws an error \"dest already exists.\".\n    fs.moveSync(from, to);\n  }\n\n  /**\n   * by default, the \"main\" prop points to the dist file (e.g. \"dist/index./js\").\n   * here, we have to change it because there is no dist dir anymore.\n   */\n  private async updatePackageJson(capsule: Capsule, compiler: Compiler, distDir: string) {\n    const distMainFile = compiler.getDistPathBySrcPath(capsule.component.state._consumer.mainFile);\n    const distMainFileWithoutDistDir = distMainFile.replace(`${distDir}${path.sep}`, '');\n    const packageJson = PackageJsonFile.loadFromCapsuleSync(capsule.path);\n    packageJson.addOrUpdateProperty('main', distMainFileWithoutDistDir);\n    await packageJson.write();\n  }\n}\n"],"mappings":"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"}