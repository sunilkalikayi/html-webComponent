{"version":3,"names":["ElementsMain","constructor","builder","componentExtension","getElementsDirName","createTask","storageResolver","ElementTask","getWebpackTransformers","defaultTransformer","configMutator","context","defaultBundlePrefix","ElementsArtifact","defaultMainFilePrefix","namePascalCase","camelCase","target","components","id","name","pascalCase","raw","output","filename","library","type","getElements","component","artifacts","getArtifactsVinylByAspect","ElementsAspect","length","undefined","isElementsExist","getArtifactsByAspect","isEmpty","getElementUrl","url","getMainElementsFileUrl","getRoute","baseRoute","provider","loggerMain","graphql","elements","logger","createLogger","elementsRoute","ElementsRoute","register","elementsSchema","registerRoute","ComponentAspect","BuilderAspect","LoggerAspect","GraphqlAspect","MainRuntime","addRuntime"],"sources":["elements.main.runtime.ts"],"sourcesContent":["import camelCase from 'camelcase';\nimport { ArtifactStorageResolver, BuilderAspect, BuilderMain } from '@teambit/builder';\nimport { MainRuntime } from '@teambit/cli';\nimport ComponentAspect, { Component, ComponentMain } from '@teambit/component';\nimport { LoggerAspect, LoggerMain } from '@teambit/logger';\nimport { WebpackConfigTransformer } from '@teambit/webpack';\nimport GraphqlAspect, { GraphqlMain } from '@teambit/graphql';\nimport { ElementsArtifact } from './elements-artifact';\nimport { ElementsAspect } from './elements.aspect';\nimport { ElementsRoute } from './elements.route';\nimport { ElementTask } from './elements.task';\nimport { elementsSchema } from './elemets.graphql';\n\nexport class ElementsMain {\n  constructor(private builder: BuilderMain, private componentExtension: ComponentMain) {}\n  baseRoute = `elements/`;\n\n  getElementsDirName(): string {\n    return '__bit__elements';\n  }\n\n  createTask(storageResolver?: ArtifactStorageResolver) {\n    return new ElementTask(this, storageResolver);\n  }\n\n  getWebpackTransformers(): WebpackConfigTransformer[] {\n    const defaultTransformer: WebpackConfigTransformer = (configMutator, context) => {\n      const defaultBundlePrefix = ElementsArtifact.defaultMainFilePrefix;\n      const namePascalCase = camelCase(context.target.components[0].id.name, { pascalCase: true });\n      configMutator.raw.output = configMutator.raw.output || {};\n      configMutator.raw.output.filename = `static/js/${defaultBundlePrefix}.[contenthash:8].js`;\n      configMutator.raw.output.library = {\n        name: namePascalCase,\n        type: 'umd',\n      };\n      return configMutator;\n    };\n    return [defaultTransformer];\n  }\n\n  async getElements(component: Component): Promise<ElementsArtifact | undefined> {\n    const artifacts = await this.builder.getArtifactsVinylByAspect(component, ElementsAspect.id);\n    if (!artifacts.length) return undefined;\n\n    return new ElementsArtifact(artifacts);\n  }\n\n  isElementsExist(component: Component): boolean {\n    const artifacts = this.builder.getArtifactsByAspect(component, ElementsAspect.id);\n    return !artifacts.isEmpty();\n  }\n\n  async getElementUrl(component: Component): Promise<string | undefined> {\n    const artifacts = await this.getElements(component);\n    // In case there are no elements return as undefined\n    if (!artifacts) return undefined;\n    if (artifacts?.isEmpty()) return undefined;\n\n    const url = artifacts?.getMainElementsFileUrl();\n    // In case of public url (like cdn) return the public url\n    if (url) {\n      return url;\n    }\n    // return the url in the scope\n    return this.componentExtension.getRoute(component.id, this.baseRoute);\n  }\n\n  static slots = [];\n  static dependencies = [ComponentAspect, BuilderAspect, LoggerAspect, GraphqlAspect];\n  static runtime = MainRuntime;\n  static async provider([componentExtension, builder, loggerMain, graphql]: [\n    ComponentMain,\n    BuilderMain,\n    LoggerMain,\n    GraphqlMain\n  ]) {\n    const elements = new ElementsMain(builder, componentExtension);\n    const logger = loggerMain.createLogger(ElementsAspect.id);\n    const elementsRoute = new ElementsRoute(elements, logger);\n    graphql.register(elementsSchema(elements));\n    componentExtension.registerRoute([elementsRoute]);\n    return elements;\n  }\n}\n\nElementsAspect.addRuntime(ElementsMain);\n"],"mappings":";;;;;;;;;;;;;;;;AAAA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAEA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAEO,MAAMA,YAAY,CAAC;EACxBC,WAAW,CAASC,OAAoB,EAAUC,kBAAiC,EAAE;IAAA,KAAjED,OAAoB,GAApBA,OAAoB;IAAA,KAAUC,kBAAiC,GAAjCA,kBAAiC;IAAA,mDACtE,WAAU;EAD+D;EAGtFC,kBAAkB,GAAW;IAC3B,OAAO,iBAAiB;EAC1B;EAEAC,UAAU,CAACC,eAAyC,EAAE;IACpD,OAAO,KAAIC,wBAAW,EAAC,IAAI,EAAED,eAAe,CAAC;EAC/C;EAEAE,sBAAsB,GAA+B;IACnD,MAAMC,kBAA4C,GAAG,CAACC,aAAa,EAAEC,OAAO,KAAK;MAC/E,MAAMC,mBAAmB,GAAGC,oCAAgB,CAACC,qBAAqB;MAClE,MAAMC,cAAc,GAAG,IAAAC,oBAAS,EAACL,OAAO,CAACM,MAAM,CAACC,UAAU,CAAC,CAAC,CAAC,CAACC,EAAE,CAACC,IAAI,EAAE;QAAEC,UAAU,EAAE;MAAK,CAAC,CAAC;MAC5FX,aAAa,CAACY,GAAG,CAACC,MAAM,GAAGb,aAAa,CAACY,GAAG,CAACC,MAAM,IAAI,CAAC,CAAC;MACzDb,aAAa,CAACY,GAAG,CAACC,MAAM,CAACC,QAAQ,GAAI,aAAYZ,mBAAoB,qBAAoB;MACzFF,aAAa,CAACY,GAAG,CAACC,MAAM,CAACE,OAAO,GAAG;QACjCL,IAAI,EAAEL,cAAc;QACpBW,IAAI,EAAE;MACR,CAAC;MACD,OAAOhB,aAAa;IACtB,CAAC;IACD,OAAO,CAACD,kBAAkB,CAAC;EAC7B;EAEA,MAAMkB,WAAW,CAACC,SAAoB,EAAyC;IAC7E,MAAMC,SAAS,GAAG,MAAM,IAAI,CAAC3B,OAAO,CAAC4B,yBAAyB,CAACF,SAAS,EAAEG,0BAAc,CAACZ,EAAE,CAAC;IAC5F,IAAI,CAACU,SAAS,CAACG,MAAM,EAAE,OAAOC,SAAS;IAEvC,OAAO,KAAIpB,oCAAgB,EAACgB,SAAS,CAAC;EACxC;EAEAK,eAAe,CAACN,SAAoB,EAAW;IAC7C,MAAMC,SAAS,GAAG,IAAI,CAAC3B,OAAO,CAACiC,oBAAoB,CAACP,SAAS,EAAEG,0BAAc,CAACZ,EAAE,CAAC;IACjF,OAAO,CAACU,SAAS,CAACO,OAAO,EAAE;EAC7B;EAEA,MAAMC,aAAa,CAACT,SAAoB,EAA+B;IACrE,MAAMC,SAAS,GAAG,MAAM,IAAI,CAACF,WAAW,CAACC,SAAS,CAAC;IACnD;IACA,IAAI,CAACC,SAAS,EAAE,OAAOI,SAAS;IAChC,IAAIJ,SAAS,aAATA,SAAS,eAATA,SAAS,CAAEO,OAAO,EAAE,EAAE,OAAOH,SAAS;IAE1C,MAAMK,GAAG,GAAGT,SAAS,aAATA,SAAS,uBAATA,SAAS,CAAEU,sBAAsB,EAAE;IAC/C;IACA,IAAID,GAAG,EAAE;MACP,OAAOA,GAAG;IACZ;IACA;IACA,OAAO,IAAI,CAACnC,kBAAkB,CAACqC,QAAQ,CAACZ,SAAS,CAACT,EAAE,EAAE,IAAI,CAACsB,SAAS,CAAC;EACvE;EAKA,aAAaC,QAAQ,CAAC,CAACvC,kBAAkB,EAAED,OAAO,EAAEyC,UAAU,EAAEC,OAAO,CAKtE,EAAE;IACD,MAAMC,QAAQ,GAAG,IAAI7C,YAAY,CAACE,OAAO,EAAEC,kBAAkB,CAAC;IAC9D,MAAM2C,MAAM,GAAGH,UAAU,CAACI,YAAY,CAAChB,0BAAc,CAACZ,EAAE,CAAC;IACzD,MAAM6B,aAAa,GAAG,KAAIC,0BAAa,EAACJ,QAAQ,EAAEC,MAAM,CAAC;IACzDF,OAAO,CAACM,QAAQ,CAAC,IAAAC,yBAAc,EAACN,QAAQ,CAAC,CAAC;IAC1C1C,kBAAkB,CAACiD,aAAa,CAAC,CAACJ,aAAa,CAAC,CAAC;IACjD,OAAOH,QAAQ;EACjB;AACF;AAAC;AAAA,gCAtEY7C,YAAY,WAsDR,EAAE;AAAA,gCAtDNA,YAAY,kBAuDD,CAACqD,oBAAe,EAAEC,wBAAa,EAAEC,sBAAY,EAAEC,kBAAa,CAAC;AAAA,gCAvDxExD,YAAY,aAwDNyD,kBAAW;AAgB9B1B,0BAAc,CAAC2B,UAAU,CAAC1D,YAAY,CAAC"}