{"version":3,"names":["ElementsRoute","constructor","elements","logger","baseRoute","req","res","component","status","send","artifact","getElements","e","file","params","elementsPath","relativePath","calculatedPath","join","getElementsDirName","getFile","getMainElementsBundleFile","contents","str","cwd","path","contentType","mime","getType","set","error","serverError"],"sources":["elements.route.ts"],"sourcesContent":["import { Request, Response, Route } from '@teambit/express';\nimport mime from 'mime';\nimport { join } from 'path';\nimport type { Component } from '@teambit/component';\nimport { serverError } from '@teambit/ui-foundation.ui.pages.static-error';\nimport type { Logger } from '@teambit/logger';\n\nimport { ElementsMain } from './elements.main.runtime';\nimport { ElementsArtifact } from './elements-artifact';\n\ntype UrlParams = {\n  /** `/elements/:elementPath(*)` */\n  elementsPath?: string;\n};\n\nexport class ElementsRoute implements Route {\n  constructor(\n    /**\n     * elements extension.\n     */\n    private elements: ElementsMain,\n    private logger: Logger\n  ) {}\n\n  route = `/${this.elements.baseRoute}:elementsPath(*)`;\n  method = 'get';\n\n  middlewares = [\n    async (req: Request<UrlParams>, res: Response) => {\n      try {\n        // @ts-ignore TODO: @guy please fix.\n        const component = req.component as Component | undefined;\n        if (!component) return res.status(404).send();\n\n        let artifact: ElementsArtifact | undefined;\n        // TODO - prevent error `getVinylsAndImportIfMissing is not a function` #4680\n        try {\n          artifact = await this.elements.getElements(component);\n        } catch (e: any) {\n          return res.status(404).send();\n        }\n        // TODO: please fix file path concatenation here.\n        let file;\n        if (req.params.elementsPath) {\n          const relativePath = req.params.elementsPath;\n          const calculatedPath = join(this.elements.getElementsDirName(), 'public', relativePath);\n          file = artifact?.getFile(calculatedPath);\n        } else {\n          file = artifact?.getMainElementsBundleFile();\n        }\n        if (!file) return res.status(404).send();\n\n        const contents = file.contents;\n        const str = `${file.cwd}/${file.path}`;\n        // @ts-ignore - temporarily, remove it later\n        const contentType = mime.getType(str);\n        if (contentType) res.set('Content-Type', contentType);\n        return res.send(contents);\n      } catch (e: any) {\n        this.logger.error('failed getting elements', e);\n        return res.status(500).send(serverError());\n      }\n    },\n  ];\n}\n"],"mappings":";;;;;;;;;;;;;;;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAEA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAWO,MAAMA,aAAa,CAAkB;EAC1CC,WAAW;EACT;AACJ;AACA;EACYC,QAAsB,EACtBC,MAAc,EACtB;IAAA,KAFQD,QAAsB,GAAtBA,QAAsB;IAAA,KACtBC,MAAc,GAAdA,MAAc;IAAA,+CAGf,IAAG,IAAI,CAACD,QAAQ,CAACE,SAAU,kBAAiB;IAAA,gDAC5C,KAAK;IAAA,qDAEA,CACZ,OAAOC,GAAuB,EAAEC,GAAa,KAAK;MAChD,IAAI;QACF;QACA,MAAMC,SAAS,GAAGF,GAAG,CAACE,SAAkC;QACxD,IAAI,CAACA,SAAS,EAAE,OAAOD,GAAG,CAACE,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,EAAE;QAE7C,IAAIC,QAAsC;QAC1C;QACA,IAAI;UACFA,QAAQ,GAAG,MAAM,IAAI,CAACR,QAAQ,CAACS,WAAW,CAACJ,SAAS,CAAC;QACvD,CAAC,CAAC,OAAOK,CAAM,EAAE;UACf,OAAON,GAAG,CAACE,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,EAAE;QAC/B;QACA;QACA,IAAII,IAAI;QACR,IAAIR,GAAG,CAACS,MAAM,CAACC,YAAY,EAAE;UAAA;UAC3B,MAAMC,YAAY,GAAGX,GAAG,CAACS,MAAM,CAACC,YAAY;UAC5C,MAAME,cAAc,GAAG,IAAAC,YAAI,EAAC,IAAI,CAAChB,QAAQ,CAACiB,kBAAkB,EAAE,EAAE,QAAQ,EAAEH,YAAY,CAAC;UACvFH,IAAI,gBAAGH,QAAQ,8CAAR,UAAUU,OAAO,CAACH,cAAc,CAAC;QAC1C,CAAC,MAAM;UAAA;UACLJ,IAAI,iBAAGH,QAAQ,+CAAR,WAAUW,yBAAyB,EAAE;QAC9C;QACA,IAAI,CAACR,IAAI,EAAE,OAAOP,GAAG,CAACE,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,EAAE;QAExC,MAAMa,QAAQ,GAAGT,IAAI,CAACS,QAAQ;QAC9B,MAAMC,GAAG,GAAI,GAAEV,IAAI,CAACW,GAAI,IAAGX,IAAI,CAACY,IAAK,EAAC;QACtC;QACA,MAAMC,WAAW,GAAGC,eAAI,CAACC,OAAO,CAACL,GAAG,CAAC;QACrC,IAAIG,WAAW,EAAEpB,GAAG,CAACuB,GAAG,CAAC,cAAc,EAAEH,WAAW,CAAC;QACrD,OAAOpB,GAAG,CAACG,IAAI,CAACa,QAAQ,CAAC;MAC3B,CAAC,CAAC,OAAOV,CAAM,EAAE;QACf,IAAI,CAACT,MAAM,CAAC2B,KAAK,CAAC,yBAAyB,EAAElB,CAAC,CAAC;QAC/C,OAAON,GAAG,CAACE,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC,IAAAsB,kCAAW,GAAE,CAAC;MAC5C;IACF,CAAC,CACF;EAzCE;AA0CL;AAAC"}