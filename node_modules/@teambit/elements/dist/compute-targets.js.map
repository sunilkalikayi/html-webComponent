{"version":3,"names":["computeTargets","context","createEntryFn","outDirName","Promise","all","components","map","comp","getComponentTarget","component","elementsWrapperFn","outputPath","getOutputPath","id","existsSync","mkdirpSync","entries","getEntryFile","componentId","capsule","capsuleNetwork","graphCapsules","getCapsule","Error","toString","resolve","path","mainFilePath","getMainFilePath","entryContent","componentName","name","targetPath","join","writeFileSync","mainFile","state","_consumer","compiler","env","getCompiler","getDistPathBySrcPath"],"sources":["compute-targets.ts"],"sourcesContent":["import { BuildContext } from '@teambit/builder';\nimport { Target } from '@teambit/bundler';\nimport { Compiler } from '@teambit/compiler';\nimport { Component } from '@teambit/component';\nimport { ComponentID } from '@teambit/component-id';\nimport { existsSync, mkdirpSync, writeFileSync } from 'fs-extra';\nimport { join, resolve } from 'path';\nimport { ElementsWrapperFn } from './elements.task';\n\nexport async function computeTargets(\n  context: BuildContext,\n  createEntryFn: ElementsWrapperFn,\n  outDirName: string\n): Promise<Target[]> {\n  return Promise.all(context.components.map((comp) => getComponentTarget(context, comp, createEntryFn, outDirName)));\n}\n\nasync function getComponentTarget(\n  context: BuildContext,\n  component: Component,\n  elementsWrapperFn: ElementsWrapperFn,\n  outDirName: string\n): Promise<Target> {\n  const outputPath = getOutputPath(context, component.id, outDirName);\n  if (!existsSync(outputPath)) mkdirpSync(outputPath);\n\n  return {\n    entries: [await getEntryFile(outputPath, component, elementsWrapperFn, context)],\n    components: [component],\n    outputPath,\n  };\n}\n\nfunction getOutputPath(context: BuildContext, componentId: ComponentID, outDirName: string): string {\n  // return resolve(`${context.capsuleNetwork.capsulesRootDir}/${getDirName(context, componentId)}`);\n  const capsule = context.capsuleNetwork.graphCapsules.getCapsule(componentId);\n  if (!capsule) throw new Error(`can't find capsule for ${componentId.toString()} while bundling for element`);\n  return resolve(`${capsule?.path}/${outDirName}`);\n}\n\nasync function getEntryFile(\n  outputPath: string,\n  component: Component,\n  elementsWrapperFn: ElementsWrapperFn,\n  context: BuildContext\n): Promise<string> {\n  const mainFilePath = getMainFilePath(context, component);\n  const entryContent = elementsWrapperFn({ mainFilePath, componentName: component.id.name });\n  const targetPath = join(outputPath, `__elements.js`);\n  writeFileSync(targetPath, entryContent);\n  return targetPath;\n}\n\nfunction getMainFilePath(context: BuildContext, component: Component): string {\n  const capsule = context.capsuleNetwork.graphCapsules.getCapsule(component.id);\n  if (!capsule) throw new Error(`can't find capsule for ${component.id.toString()} while bundling for element`);\n  const mainFile = component.state._consumer.mainFile;\n  const compiler: Compiler = context.env.getCompiler();\n  return join(capsule.path, compiler.getDistPathBySrcPath(mainFile));\n}\n"],"mappings":";;;;;;;;AAKA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAGO,eAAeA,cAAc,CAClCC,OAAqB,EACrBC,aAAgC,EAChCC,UAAkB,EACC;EACnB,OAAOC,OAAO,CAACC,GAAG,CAACJ,OAAO,CAACK,UAAU,CAACC,GAAG,CAAEC,IAAI,IAAKC,kBAAkB,CAACR,OAAO,EAAEO,IAAI,EAAEN,aAAa,EAAEC,UAAU,CAAC,CAAC,CAAC;AACpH;AAEA,eAAeM,kBAAkB,CAC/BR,OAAqB,EACrBS,SAAoB,EACpBC,iBAAoC,EACpCR,UAAkB,EACD;EACjB,MAAMS,UAAU,GAAGC,aAAa,CAACZ,OAAO,EAAES,SAAS,CAACI,EAAE,EAAEX,UAAU,CAAC;EACnE,IAAI,CAAC,IAAAY,qBAAU,EAACH,UAAU,CAAC,EAAE,IAAAI,qBAAU,EAACJ,UAAU,CAAC;EAEnD,OAAO;IACLK,OAAO,EAAE,CAAC,MAAMC,YAAY,CAACN,UAAU,EAAEF,SAAS,EAAEC,iBAAiB,EAAEV,OAAO,CAAC,CAAC;IAChFK,UAAU,EAAE,CAACI,SAAS,CAAC;IACvBE;EACF,CAAC;AACH;AAEA,SAASC,aAAa,CAACZ,OAAqB,EAAEkB,WAAwB,EAAEhB,UAAkB,EAAU;EAClG;EACA,MAAMiB,OAAO,GAAGnB,OAAO,CAACoB,cAAc,CAACC,aAAa,CAACC,UAAU,CAACJ,WAAW,CAAC;EAC5E,IAAI,CAACC,OAAO,EAAE,MAAM,IAAII,KAAK,CAAE,0BAAyBL,WAAW,CAACM,QAAQ,EAAG,6BAA4B,CAAC;EAC5G,OAAO,IAAAC,eAAO,EAAE,GAAEN,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEO,IAAK,IAAGxB,UAAW,EAAC,CAAC;AAClD;AAEA,eAAee,YAAY,CACzBN,UAAkB,EAClBF,SAAoB,EACpBC,iBAAoC,EACpCV,OAAqB,EACJ;EACjB,MAAM2B,YAAY,GAAGC,eAAe,CAAC5B,OAAO,EAAES,SAAS,CAAC;EACxD,MAAMoB,YAAY,GAAGnB,iBAAiB,CAAC;IAAEiB,YAAY;IAAEG,aAAa,EAAErB,SAAS,CAACI,EAAE,CAACkB;EAAK,CAAC,CAAC;EAC1F,MAAMC,UAAU,GAAG,IAAAC,YAAI,EAACtB,UAAU,EAAG,eAAc,CAAC;EACpD,IAAAuB,wBAAa,EAACF,UAAU,EAAEH,YAAY,CAAC;EACvC,OAAOG,UAAU;AACnB;AAEA,SAASJ,eAAe,CAAC5B,OAAqB,EAAES,SAAoB,EAAU;EAC5E,MAAMU,OAAO,GAAGnB,OAAO,CAACoB,cAAc,CAACC,aAAa,CAACC,UAAU,CAACb,SAAS,CAACI,EAAE,CAAC;EAC7E,IAAI,CAACM,OAAO,EAAE,MAAM,IAAII,KAAK,CAAE,0BAAyBd,SAAS,CAACI,EAAE,CAACW,QAAQ,EAAG,6BAA4B,CAAC;EAC7G,MAAMW,QAAQ,GAAG1B,SAAS,CAAC2B,KAAK,CAACC,SAAS,CAACF,QAAQ;EACnD,MAAMG,QAAkB,GAAGtC,OAAO,CAACuC,GAAG,CAACC,WAAW,EAAE;EACpD,OAAO,IAAAP,YAAI,EAACd,OAAO,CAACO,IAAI,EAAEY,QAAQ,CAACG,oBAAoB,CAACN,QAAQ,CAAC,CAAC;AACpE"}