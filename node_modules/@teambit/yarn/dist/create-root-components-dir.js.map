{"version":3,"names":["createRootComponentsDir","depResolver","rootDir","componentDirectoryMap","pickedComponents","Map","deps","pickComponentsAndAllDeps","Array","from","hashMap","keys","copiesDir","path","join","Promise","all","entries","map","rootComponentDir","packageJson","rel","relative","targetDir","modulesDir","fs","copy","filter","src","overwrite","writeJson","spaces","newManifestsByPaths","pkgJson","get","compDir","name","dependencies","peerDependencies","installConfig","hoistingLimits","rootComponentIds","rootComponentId","component","push","packageJsonObject","pkgName","getPackageName","JSON","parse","readFile","set","depsList","getDependencies","dep","ComponentDependency","componentId","toString"],"sources":["create-root-components-dir.ts"],"sourcesContent":["import fs from 'fs-extra';\nimport path from 'path';\nimport { ComponentDependency, DependencyResolverMain } from '@teambit/dependency-resolver';\nimport { ComponentMap } from '@teambit/component';\n\n/**\n * All components are copied to a temporary folder (`<workspace-root>/.bit_components`).\n * Each of the copies gets a `package.json` generated, where the component dependencies\n * from the workspace are declared using the `file:` protocol.\n * Every workspace component is then referenced from the `node_modules/<pkgname>` directory (using the `file:` protocol).\n * The peer dependencies of the components are added as runtime dependencies of `node_modules/<pkgname>`.\n *\n * This way Yarn will install each workspace component in isolation with its component dependencies and peer dependencies\n * inside `node_modules/<pkgName>/node_modules`.\n */\nexport async function createRootComponentsDir({\n  depResolver,\n  rootDir,\n  componentDirectoryMap,\n}: {\n  depResolver: DependencyResolverMain;\n  rootDir: string;\n  componentDirectoryMap: ComponentMap<string>;\n}): Promise<Record<string, object>> {\n  const pickedComponents = new Map<string, Record<string, any>>();\n  const deps = await pickComponentsAndAllDeps(\n    depResolver,\n    Array.from(componentDirectoryMap.hashMap.keys()),\n    componentDirectoryMap,\n    pickedComponents,\n    rootDir\n  );\n  const copiesDir = path.join(rootDir, 'node_modules/.bit_components');\n  await Promise.all(\n    Array.from(pickedComponents.entries()).map(async ([rootComponentDir, packageJson]) => {\n      const rel = path.relative(rootDir, rootComponentDir);\n      const targetDir = path.join(copiesDir, rel);\n      const modulesDir = path.join(rootComponentDir, 'node_modules');\n      await fs.copy(rootComponentDir, targetDir, {\n        filter: (src) => src !== modulesDir,\n        overwrite: true,\n      });\n      await fs.writeJson(path.join(targetDir, 'package.json'), packageJson, { spaces: 2 });\n    })\n  );\n  const newManifestsByPaths: Record<string, object> = {};\n  for (const rootComponentDir of deps) {\n    const rel = path.relative(rootDir, rootComponentDir);\n    const targetDir = path.join(copiesDir, rel);\n    const pkgJson = pickedComponents.get(rootComponentDir);\n    if (pkgJson) {\n      const compDir = path.join(rootDir, 'node_modules', pkgJson.name);\n      newManifestsByPaths[compDir] = {\n        name: pkgJson.name,\n        dependencies: {\n          [pkgJson.name]: `file:${path.relative(compDir, targetDir)}`,\n          ...pkgJson.peerDependencies,\n          ...pkgJson['defaultPeerDependencies'], // eslint-disable-line\n        },\n        // is it needed?\n        installConfig: {\n          hoistingLimits: 'dependencies',\n        },\n      };\n    }\n  }\n  return newManifestsByPaths;\n}\n\n/**\n * This function generates a `package.json` for each component in the workspace.\n * Any component dependencies that are present in the workspace are added to the dependencies\n * as local `file:` dependencies.\n */\nasync function pickComponentsAndAllDeps(\n  depResolver: DependencyResolverMain,\n  rootComponentIds: string[],\n  componentDirectoryMap: ComponentMap<string>,\n  pickedComponents: Map<string, Record<string, any>>,\n  rootDir: string\n) {\n  const dependencies: string[] = [];\n  await Promise.all(\n    rootComponentIds.map(async (rootComponentId) => {\n      const component = componentDirectoryMap.hashMap.get(rootComponentId);\n      if (component) {\n        dependencies.push(component[1]);\n        let packageJsonObject = pickedComponents.get(component[1]);\n        if (!packageJsonObject) {\n          const pkgName = depResolver.getPackageName(component[0]);\n          packageJsonObject = JSON.parse(\n            await fs.readFile(path.join(rootDir, 'node_modules', pkgName, 'package.json'), 'utf-8')\n          ) as Record<string, any>;\n          pickedComponents.set(component[1], packageJsonObject);\n        }\n        const depsList = await depResolver.getDependencies(component[0]);\n        const deps = await pickComponentsAndAllDeps(\n          depResolver,\n          depsList.dependencies\n            .filter((dep) => dep instanceof ComponentDependency)\n            .map((dep: any) => dep.componentId.toString()),\n          componentDirectoryMap,\n          pickedComponents,\n          rootDir\n        );\n        for (const dep of deps) {\n          const pkgJson = pickedComponents.get(dep);\n          if (pkgJson) {\n            packageJsonObject.dependencies[pkgJson.name] = `file:${path.relative(component[1], dep)}`;\n          }\n        }\n      }\n    })\n  );\n  return dependencies;\n}\n"],"mappings":"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"}