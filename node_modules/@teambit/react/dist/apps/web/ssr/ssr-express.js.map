{"version":3,"names":["MAGIC_FOLDER","createExpressSsr","name","workdir","port","app","assets","logger","express","Express","publicFolder","resolve","calcOutputPath","use","PUBLIC_PATH","static","request","response","next","query","_rendering","sendFile","info","url","browser","browserFromExpress","session","console","error","consoleError","status","send","serverError","loadSsrApp","appName","entryFile","SSR_ENTRY_FILE","fs","existsSync","Error","entry","default","parseAssets","publicPath","deadAssets","filter","x","length","css","map","endsWith","urlJoin","js"],"sources":["ssr-express.ts"],"sourcesContent":["import { Asset } from '@teambit/bundler';\nimport { Logger } from '@teambit/logger';\nimport { serverError } from '@teambit/ui-foundation.ui.pages.static-error';\nimport { browserFromExpress } from '@teambit/react.rendering.ssr';\nimport type { HtmlAssets, SsrSession } from '@teambit/react.rendering.ssr';\n\nimport Express from 'express';\nimport * as fs from 'fs-extra';\nimport { resolve } from 'path';\nimport urlJoin from 'url-join';\n\nimport { calcOutputPath, PUBLIC_PATH, SSR_ENTRY_FILE } from '../webpack/webpack.app.ssr.config';\n\nconst MAGIC_FOLDER = 'public'; // idk where this is comping from\n\ntype ExpressSsrOptions = {\n  name: string;\n  workdir: string;\n  port: number;\n  app: any;\n  assets: HtmlAssets;\n  logger?: Logger;\n};\n\nexport function createExpressSsr({ name, workdir, port, app, assets, logger }: ExpressSsrOptions) {\n  const express = Express();\n\n  const publicFolder = resolve(workdir, calcOutputPath(name, 'browser'), MAGIC_FOLDER);\n\n  express.use(PUBLIC_PATH, Express.static(publicFolder));\n  express.use((request, response, next) => {\n    if (request.query._rendering !== 'client') {\n      next();\n      return;\n    }\n    response.sendFile(resolve(workdir, calcOutputPath(name, 'browser'), MAGIC_FOLDER, 'index.html'));\n  });\n  express.use(async (request, response) => {\n    logger?.info(`[react.application] [ssr] handling \"${request.url}\"`);\n    const browser = browserFromExpress(request, port);\n    const session: SsrSession = { assets, browser, request, response };\n\n    try {\n      // the app itself controls the response\n      await app(session);\n      logger?.console(`[react.application] [ssr] success \"${request.url}\"`);\n    } catch (error: any) {\n      logger?.consoleError(`[react.application] [ssr] error at \"${request.url}\"`, error);\n      response.status(500).send(serverError());\n    }\n  });\n\n  return express;\n}\n\nexport async function loadSsrApp(workdir: string, appName: string) {\n  const entryFile = resolve(workdir, calcOutputPath(appName, 'ssr'), MAGIC_FOLDER, SSR_ENTRY_FILE);\n  if (!fs.existsSync(entryFile)) throw new Error(`expected ssr bundle entry file at \"${entryFile}\"`);\n\n  const entry = await import(entryFile);\n  const app = entry?.default;\n  if (!app) throw new Error(`bundle entry file has no default export (at \"${entryFile}\")`);\n\n  return app;\n}\n\nexport function parseAssets(assets: Asset[], publicPath = PUBLIC_PATH): HtmlAssets {\n  const deadAssets = assets.filter((x) => !x.name);\n  if (deadAssets.length > 0) throw new Error('missing some build assets (maybe need to turn on cachedAssets, etc)');\n\n  return {\n    css: assets\n      .map((x) => x.name)\n      .filter((name) => name?.endsWith('.css'))\n      .map((name) => urlJoin(publicPath, name)),\n    js: assets\n      .map((x) => x.name)\n      .filter((name) => name?.endsWith('.js'))\n      .map((name) => urlJoin(publicPath, name)),\n  };\n}\n"],"mappings":"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"}