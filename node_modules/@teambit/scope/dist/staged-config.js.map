{"version":3,"names":["STAGED_CONFIG_DIR","StagedConfig","constructor","filePath","componentsConfig","load","scopePath","laneId","lanePath","path","join","scope","name","DEFAULT_LANE","fileContent","fs","readJson","map","item","id","ComponentID","fromObject","config","err","code","toObject","write","hasChanged","outputFile","JSON","stringify","getConfigPerId","find","c","isEqual","ignoreVersion","getAll","addComponentConfig","exists","push","removeComponentConfig","filter"],"sources":["staged-config.ts"],"sourcesContent":["import fs from 'fs-extra';\nimport path from 'path';\nimport { ComponentID } from '@teambit/component-id';\nimport { DEFAULT_LANE, LaneId } from '@teambit/lane-id';\n\nconst STAGED_CONFIG_DIR = 'staged-config';\n\ntype Config = Record<string, any> | undefined;\ntype ComponentConfig = { id: ComponentID; config: Config };\n\nexport class StagedConfig {\n  hasChanged = false;\n  constructor(private filePath: string, private componentsConfig: ComponentConfig[]) {}\n\n  static async load(scopePath: string, laneId?: LaneId): Promise<StagedConfig> {\n    const lanePath = laneId ? path.join(laneId.scope, laneId.name) : DEFAULT_LANE;\n    const filePath = path.join(scopePath, STAGED_CONFIG_DIR, `${lanePath}.json`);\n    let componentsConfig: ComponentConfig[] = [];\n    try {\n      const fileContent = await fs.readJson(filePath);\n      componentsConfig = fileContent.map((item) => ({ id: ComponentID.fromObject(item.id), config: item.config }));\n    } catch (err: any) {\n      if (err.code === 'ENOENT') {\n        componentsConfig = [];\n      } else {\n        throw err;\n      }\n    }\n    return new StagedConfig(filePath, componentsConfig);\n  }\n\n  toObject() {\n    return this.componentsConfig.map(({ id, config }) => ({ id: id.toObject(), config }));\n  }\n\n  async write() {\n    if (!this.hasChanged) return;\n    await fs.outputFile(this.filePath, JSON.stringify(this.toObject(), null, 2));\n  }\n\n  getConfigPerId(id: ComponentID): Config {\n    return this.componentsConfig.find((c) => c.id.isEqual(id, { ignoreVersion: true }))?.config;\n  }\n\n  getAll() {\n    return this.componentsConfig;\n  }\n\n  addComponentConfig(id: ComponentID, config: Config) {\n    const exists = this.componentsConfig.find((c) => c.id.isEqual(id, { ignoreVersion: true }));\n    if (exists) {\n      exists.config = config;\n    } else {\n      this.componentsConfig.push({ id, config });\n    }\n    this.hasChanged = true;\n  }\n\n  removeComponentConfig(id: ComponentID) {\n    this.componentsConfig = this.componentsConfig.filter((c) => !c.id.isEqual(id, { ignoreVersion: true }));\n    this.hasChanged = true;\n  }\n}\n"],"mappings":"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"}