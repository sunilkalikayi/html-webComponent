{"version":3,"names":["configFactory","target","context","truthyEntries","Array","isArray","entries","length","filter","Boolean","dev","development","htmlConfig","html","compress","htmlPlugins","generateHtmlPlugins","undefined","splitChunks","chunking","config","mode","bail","entry","infrastructureLogging","level","output","path","outputPath","sep","stats","errorDetails","resolve","alias","fallbacksAliases","fallback","fallbacks","plugins","webpack","ProvidePlugin","fallbacksProvidePluginConfig","getAssetManifestPlugin","filename","chunkFilename","runtimeChunkName","optimization","runtimeChunk","name","chunks","concat","CompressionPlugin","WebpackAssetsManifest","entrypoints","configs","map","generateHtmlPlugin","baseConfig","chunksSortMode","chunkOrder","title","templateContent","minify","cache","favicon","filteredConfig","omitBy","isUndefined","HtmlWebpackPlugin"],"sources":["webpack.config.ts"],"sourcesContent":["/* eslint-disable complexity */\nimport webpack, { Configuration } from 'webpack';\nimport { isUndefined, omitBy } from 'lodash';\nimport CompressionPlugin from 'compression-webpack-plugin';\nimport { sep } from 'path';\nimport type { BundlerContext, BundlerHtmlConfig, Target } from '@teambit/bundler';\nimport HtmlWebpackPlugin from 'html-webpack-plugin';\nimport WebpackAssetsManifest from 'webpack-assets-manifest';\nimport { fallbacks } from './webpack-fallbacks';\nimport { fallbacksProvidePluginConfig } from './webpack-fallbacks-provide-plugin-config';\nimport { fallbacksAliases } from './webpack-fallbacks-aliases';\n\nexport function configFactory(target: Target, context: BundlerContext): Configuration {\n  let truthyEntries =\n    Array.isArray(target.entries) && target.entries.length ? target.entries.filter(Boolean) : target.entries || {};\n  if (Array.isArray(truthyEntries) && !truthyEntries.length) {\n    truthyEntries = {};\n  }\n\n  const dev = Boolean(context.development);\n  const htmlConfig = target.html ?? context.html;\n  const compress = target.compress ?? context.compress;\n  const htmlPlugins = htmlConfig ? generateHtmlPlugins(htmlConfig) : undefined;\n  const splitChunks = target.chunking?.splitChunks;\n\n  const config: Configuration = {\n    mode: dev ? 'development' : 'production',\n    // Stop compilation early in production\n    bail: true,\n    // These are the \"entry points\" to our application.\n    // This means they will be the \"root\" imports that are included in JS bundle.\n    // @ts-ignore\n    entry: truthyEntries,\n\n    infrastructureLogging: {\n      level: 'error',\n    },\n\n    output: {\n      // The build folder.\n      path: `${target.outputPath}${sep}public`,\n    },\n    stats: {\n      errorDetails: true,\n    },\n\n    resolve: {\n      // TODO - check - we should not need both fallbacks and alias and provider plugin\n      alias: fallbacksAliases,\n\n      fallback: fallbacks,\n    },\n\n    plugins: [new webpack.ProvidePlugin(fallbacksProvidePluginConfig), getAssetManifestPlugin()],\n  };\n\n  if (target.filename) {\n    config.output = config.output || {};\n    config.output.filename = target.filename;\n  }\n\n  if (target.chunkFilename) {\n    config.output = config.output || {};\n    config.output.chunkFilename = target.chunkFilename;\n  }\n\n  if (target.runtimeChunkName) {\n    config.optimization = config.optimization || {};\n    config.optimization.runtimeChunk = {\n      name: target.runtimeChunkName,\n    };\n  }\n\n  if (splitChunks) {\n    config.optimization = config.optimization || {};\n    config.optimization.splitChunks = {\n      chunks: 'all',\n      name: false,\n    };\n  }\n\n  if (htmlPlugins && htmlPlugins.length) {\n    if (!config.plugins) {\n      config.plugins = [];\n    }\n    config.plugins = config.plugins.concat(htmlPlugins);\n  }\n  if (compress) {\n    if (!config.plugins) {\n      config.plugins = [];\n    }\n    config.plugins = config.plugins.concat(new CompressionPlugin());\n  }\n  return config;\n}\n\nfunction getAssetManifestPlugin() {\n  return new WebpackAssetsManifest({ entrypoints: true });\n}\n\nfunction generateHtmlPlugins(configs: BundlerHtmlConfig[]) {\n  return configs.map((config) => generateHtmlPlugin(config));\n}\n\nfunction generateHtmlPlugin(config: BundlerHtmlConfig) {\n  const baseConfig: HtmlWebpackPlugin.Options = {\n    filename: config.filename,\n    chunks: config.chunks,\n    chunksSortMode: config.chunkOrder,\n    title: config.title,\n    templateContent: config.templateContent,\n    minify: config.minify,\n    cache: false,\n    favicon: config.favicon,\n  };\n\n  const filteredConfig = omitBy(baseConfig, isUndefined);\n  return new HtmlWebpackPlugin(filteredConfig);\n}\n"],"mappings":"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"}