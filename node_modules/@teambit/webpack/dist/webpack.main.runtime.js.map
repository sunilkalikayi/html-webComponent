{"version":3,"names":["WebpackMain","constructor","pubsub","workspace","bundler","logger","createDevServer","context","transformers","config","createDevServerConfig","entry","path","id","rootPath","publicPath","title","configMutator","WebpackConfigMutator","transformerContext","Object","assign","mode","internalTransformers","generateTransformers","undefined","afterMutation","runTransformersWithContext","clone","WebpackDevServer","raw","webpack","WsDevServer","mergeConfig","target","source","merge","createBundler","initialConfigs","webpackInstance","configs","createConfigs","targets","baseConfigFactory","WebpackBundler","metaData","factory","bundlerContext","map","baseConfig","_bundlerContext","devServerContext","hostDeps","hostDependencies","aliasHostDependencies","peerAliasesTransformer","generateAddAliasesFromPeersTransformer","push","externalizeHostDependencies","externalsTransformer","generateExternalsTransformer","devServerID","publicRoot","devServerConfigFactory","provider","logPublisher","createLogger","WebpackAspect","MainRuntime","PubsubAspect","WorkspaceAspect","BundlerAspect","LoggerAspect","addRuntime","Array","isArray","newConfig","reduce","acc","transformer"],"sources":["webpack.main.runtime.ts"],"sourcesContent":["import webpack, { Configuration } from 'webpack';\nimport PubsubAspect, { PubsubMain } from '@teambit/pubsub';\nimport {\n  BundlerAspect,\n  BundlerContext,\n  BundlerMain,\n  DevServer,\n  DevServerContext,\n  BundlerMode,\n  Target,\n} from '@teambit/bundler';\nimport { MainRuntime } from '@teambit/cli';\nimport { Logger, LoggerAspect, LoggerMain } from '@teambit/logger';\nimport { Workspace, WorkspaceAspect } from '@teambit/workspace';\nimport { merge } from 'webpack-merge';\nimport WsDevServer from 'webpack-dev-server';\nimport { WebpackConfigMutator } from '@teambit/webpack.modules.config-mutator';\n\nimport { generateAddAliasesFromPeersTransformer, generateExternalsTransformer } from './transformers';\nimport { configFactory as devServerConfigFactory } from './config/webpack.dev.config';\nimport { configFactory as baseConfigFactory } from './config/webpack.config';\n\nimport { WebpackAspect } from './webpack.aspect';\nimport { WebpackBundler } from './webpack.bundler';\nimport { WebpackDevServer } from './webpack.dev-server';\n\nexport type WebpackConfigTransformContext = GlobalWebpackConfigTransformContext & {\n  target: Target;\n};\n\nexport type WebpackConfigDevServerTransformContext = GlobalWebpackConfigTransformContext & DevServerContext;\n\nexport type GlobalWebpackConfigTransformContext = {\n  mode: BundlerMode;\n  /**\n   * A path for the host root dir\n   * Host root dir is usually the env root dir\n   * This can be used in different bundle options which run require.resolve\n   * for example when configuring webpack aliases or webpack expose loader on the peers deps\n   */\n  hostRootDir?: string;\n};\n\nexport type WebpackConfigTransformer = (\n  config: WebpackConfigMutator,\n  context: WebpackConfigTransformContext\n) => WebpackConfigMutator;\n\nexport type WebpackConfigDevServerTransformer = (\n  config: WebpackConfigMutator,\n  context: WebpackConfigDevServerTransformContext\n) => WebpackConfigMutator;\n\nexport class WebpackMain {\n  constructor(\n    /**\n     * Pubsub extension.\n     */\n    public pubsub: PubsubMain,\n\n    /**\n     * workspace extension.\n     */\n    private workspace: Workspace,\n\n    /**\n     * bundler extension.\n     */\n    private bundler: BundlerMain,\n\n    /**\n     * Logger extension\n     */\n    public logger: Logger\n  ) {}\n\n  /**\n   * create an instance of bit-compliant webpack dev server for a set of components\n   */\n  createDevServer(context: DevServerContext, transformers: WebpackConfigTransformer[] = []): DevServer {\n    const config = this.createDevServerConfig(\n      context.entry,\n      this.workspace.path,\n      context.id,\n      context.rootPath,\n      context.publicPath,\n      context.title\n    ) as any;\n    const configMutator = new WebpackConfigMutator(config);\n    const transformerContext: WebpackConfigDevServerTransformContext = Object.assign(context, { mode: 'dev' as const });\n    const internalTransformers = this.generateTransformers(undefined, transformerContext);\n\n    const afterMutation = runTransformersWithContext(\n      configMutator.clone(),\n      [...internalTransformers, ...transformers],\n      transformerContext\n    );\n    // @ts-ignore - fix this\n    return new WebpackDevServer(afterMutation.raw, webpack, WsDevServer);\n  }\n\n  mergeConfig(target: any, source: any): any {\n    return merge(target, source);\n  }\n\n  createBundler(\n    context: BundlerContext,\n    transformers: WebpackConfigTransformer[] = [],\n    initialConfigs?: webpack.Configuration[],\n    webpackInstance?: any\n  ) {\n    const transformerContext: GlobalWebpackConfigTransformContext = { mode: 'prod' };\n    // eslint-disable-next-line max-len\n    const configs =\n      initialConfigs ||\n      this.createConfigs(context.targets, baseConfigFactory, transformers, transformerContext, context);\n    return new WebpackBundler(context.targets, configs, this.logger, webpackInstance || webpack, context.metaData);\n  }\n\n  private createConfigs(\n    targets: Target[],\n    factory: (target: Target, context: BundlerContext) => Configuration,\n    transformers: WebpackConfigTransformer[] = [],\n    transformerContext: GlobalWebpackConfigTransformContext,\n    bundlerContext: BundlerContext\n  ) {\n    return targets.map((target) => {\n      const baseConfig = factory(target, bundlerContext);\n      const configMutator = new WebpackConfigMutator(baseConfig);\n      const context = Object.assign({}, transformerContext, { target });\n      const internalTransformers = this.generateTransformers(context, undefined, target);\n      const afterMutation = runTransformersWithContext(\n        configMutator.clone(),\n        [...internalTransformers, ...transformers],\n        context\n      );\n      return afterMutation.raw;\n    });\n  }\n\n  private generateTransformers(\n    _bundlerContext?: WebpackConfigTransformContext,\n    devServerContext?: WebpackConfigDevServerTransformContext,\n    target?: Target\n  ): Array<WebpackConfigTransformer> {\n    const transformers: WebpackConfigTransformer[] = [];\n    // TODO: handle dev server\n    const hostDeps = target?.hostDependencies || devServerContext?.hostDependencies;\n    if (hostDeps) {\n      if (target?.aliasHostDependencies || devServerContext?.aliasHostDependencies) {\n        const peerAliasesTransformer = generateAddAliasesFromPeersTransformer(hostDeps, this.logger);\n        transformers.push(peerAliasesTransformer);\n      }\n      if (target?.externalizeHostDependencies || devServerContext?.externalizeHostDependencies) {\n        const externalsTransformer = generateExternalsTransformer(hostDeps);\n        transformers.push(externalsTransformer);\n      }\n    }\n    return transformers;\n  }\n\n  private createDevServerConfig(\n    entry: string[],\n    rootPath: string,\n    devServerID: string,\n    publicRoot: string,\n    publicPath: string,\n    title?: string\n  ) {\n    return devServerConfigFactory(devServerID, rootPath, entry, publicRoot, publicPath, this.pubsub, title);\n  }\n\n  static slots = [];\n\n  static runtime = MainRuntime;\n  static dependencies = [PubsubAspect, WorkspaceAspect, BundlerAspect, LoggerAspect];\n\n  static async provider([pubsub, workspace, bundler, logger]: [PubsubMain, Workspace, BundlerMain, LoggerMain]) {\n    const logPublisher = logger.createLogger(WebpackAspect.id);\n    return new WebpackMain(pubsub, workspace, bundler, logPublisher);\n  }\n}\n\nWebpackAspect.addRuntime(WebpackMain);\n\nexport function runTransformersWithContext(\n  config: WebpackConfigMutator,\n  transformers: Array<WebpackConfigTransformer | WebpackConfigDevServerTransformer> = [],\n  // context: WebpackConfigTransformContext | WebpackConfigDevServerTransformContext\n  context: any\n): WebpackConfigMutator {\n  if (!Array.isArray(transformers)) return config;\n  const newConfig = transformers.reduce((acc, transformer) => {\n    // @ts-ignore\n    return transformer(acc, context);\n  }, config);\n  return newConfig;\n}\n"],"mappings":"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"}