{"version":3,"names":["WebpackBundler","constructor","targets","configs","logger","webpack","metaData","run","startTime","Date","now","compilers","map","config","initiator","envId","initiatorMessage","envIdMessage","longProcessLogger","createLongProcessLogger","length","componentOutput","mapSeries","compiler","components","getComponents","outputPath","componentsLengthMessage","fullMessage","ids","component","id","toString","join","logProgress","debug","Promise","resolve","err","stats","error","errors","stack","BitError","info","toJson","all","entrypoints","warnings","assets","chunkGroupAuxiliary","relatedAssets","cachedAssets","assetsMap","getAssets","entriesAssetsMap","getEntriesAssetsMap","Object","values","assetsByChunkName","getErrors","compilation","outputOptions","path","endTime","end","fieldsToShow","webpackError","lines","fieldName","undefined","errorMessage","compact","reduce","acc","asset","name","size","compressedSize","getCompressedSize","entriesMap","keys","entries","forEach","entryVal","compressedAssetsSize","compressedAuxiliaryAssetsSize","auxiliaryAssets","related","isEmpty","gzipped","find","relatedAsset","type","substring","lastIndexOf","sep","target","targetCandidate","Error"],"sources":["webpack.bundler.ts"],"sourcesContent":["import { BitError } from '@teambit/bit-error';\nimport type { Bundler, BundlerResult, Asset, Target, EntriesAssetsMap, BundlerContextMetaData } from '@teambit/bundler';\nimport type { Logger } from '@teambit/logger';\nimport { compact, isEmpty } from 'lodash';\nimport mapSeries from 'p-map-series';\nimport type { Compiler, Configuration, StatsCompilation, StatsAsset } from 'webpack';\nimport { sep } from 'path';\n\ntype AssetsMap = { [assetId: string]: Asset };\nexport class WebpackBundler implements Bundler {\n  constructor(\n    /**\n     * targets to bundle.\n     */\n    private targets: Target[],\n\n    /**\n     * webpack configuration.\n     */\n    private configs: Configuration[],\n\n    private logger: Logger,\n\n    private webpack,\n\n    private metaData?: BundlerContextMetaData | undefined\n  ) {}\n\n  async run(): Promise<BundlerResult[]> {\n    const startTime = Date.now();\n    const compilers = this.configs.map((config: any) => this.webpack(config));\n    const initiator = this.metaData?.initiator;\n    const envId = this.metaData?.envId;\n    const initiatorMessage = initiator ? `process initiated by: ${initiator}.` : '';\n    const envIdMessage = envId ? `config created by env: ${envId}.` : '';\n\n    const longProcessLogger = this.logger.createLongProcessLogger('running Webpack bundler', compilers.length);\n    const componentOutput = await mapSeries(compilers, (compiler: Compiler) => {\n      const components = this.getComponents(compiler.outputPath);\n      const componentsLengthMessage = `running on ${components.length} components`;\n      const fullMessage = `${initiatorMessage} ${envIdMessage} ${componentsLengthMessage}`;\n      const ids = components.map((component) => component.id.toString()).join(', ');\n      longProcessLogger.logProgress(`${fullMessage}`);\n      this.logger.debug(`${fullMessage}\\ncomponents ids: ${ids}`);\n      return new Promise((resolve) => {\n        // TODO: split to multiple processes to reduce time and configure concurrent builds.\n        // @see https://github.com/trivago/parallel-webpack\n        return compiler.run((err, stats) => {\n          if (err) {\n            this.logger.error('get error from webpack compiler, full error:', err);\n\n            return resolve({\n              errors: [`${err.toString()}\\n${err.stack}`],\n              components,\n            });\n          }\n          if (!stats) throw new BitError('unknown build error');\n          // const info = stats.toJson();\n\n          const info = stats.toJson({\n            all: false,\n            entrypoints: true,\n            warnings: true,\n            errors: true,\n            assets: true,\n            chunkGroupAuxiliary: true,\n            relatedAssets: true,\n            cachedAssets: true,\n          });\n          const assetsMap = this.getAssets(info);\n          const entriesAssetsMap = this.getEntriesAssetsMap(info, assetsMap);\n\n          return resolve({\n            assets: Object.values(assetsMap),\n            assetsByChunkName: info.assetsByChunkName,\n            entriesAssetsMap,\n            errors: this.getErrors(info),\n            outputPath: stats.compilation.outputOptions.path,\n            components,\n            warnings: info.warnings,\n            startTime,\n            endTime: Date.now(),\n          });\n        });\n      });\n    });\n    longProcessLogger.end();\n    return componentOutput as BundlerResult[];\n  }\n\n  private getErrors(stats: StatsCompilation): Error[] {\n    if (!stats.errors) return [];\n    const fieldsToShow = ['message', 'moduleId', 'moduleName', 'moduleIdentifier', 'loc'];\n    return stats.errors.map((webpackError) => {\n      const lines = fieldsToShow.map((fieldName) => {\n        if (webpackError[fieldName]) {\n          return `${fieldName}: ${webpackError[fieldName]}`;\n        }\n        return undefined;\n      });\n      const errorMessage = compact(lines).join('\\n');\n      return new BitError(errorMessage);\n    });\n  }\n\n  private getAssets(stats: StatsCompilation): AssetsMap {\n    if (!stats.assets) return {};\n    return stats.assets.reduce((acc, asset) => {\n      acc[asset.name] = {\n        name: asset.name,\n        size: asset.size,\n        compressedSize: this.getCompressedSize(asset),\n      };\n      return acc;\n    }, {});\n  }\n\n  private getEntriesAssetsMap(stats: StatsCompilation, assetsMap: AssetsMap): EntriesAssetsMap {\n    const entriesMap = stats.entrypoints;\n    if (!entriesMap || !Object.keys(assetsMap).length) return {};\n    Object.entries(entriesMap).forEach(([, entryVal]) => {\n      let compressedAssetsSize = 0;\n      let compressedAuxiliaryAssetsSize = 0;\n      entryVal.assets?.forEach((asset) => {\n        const compressedSize = assetsMap[asset.name]?.compressedSize;\n        if (compressedSize) {\n          // @ts-ignore\n          asset.compressedSize = compressedSize;\n          compressedAssetsSize += compressedSize;\n        }\n      });\n      entryVal.auxiliaryAssets?.forEach((asset) => {\n        const compressedSize = assetsMap[asset.name]?.compressedSize;\n        if (compressedSize) {\n          // @ts-ignore\n          asset.compressedSize = compressedSize;\n          compressedAuxiliaryAssetsSize += compressedSize;\n        }\n      });\n      entryVal.compressedAssetsSize = compressedAssetsSize;\n      entryVal.compressedAuxiliaryAssetsSize = compressedAuxiliaryAssetsSize;\n    });\n    return entriesMap as any as EntriesAssetsMap;\n  }\n\n  private getCompressedSize(asset: StatsAsset): number | undefined {\n    if (!asset.related || isEmpty(asset.related)) return undefined;\n    const gzipped = asset.related.find((relatedAsset) => {\n      return relatedAsset.type === 'gzipped';\n    });\n    if (!gzipped) return undefined;\n    return gzipped.size;\n  }\n\n  private getComponents(outputPath: string) {\n    const path = outputPath.substring(0, outputPath.lastIndexOf(sep));\n    const target = this.targets.find((targetCandidate) => path === targetCandidate.outputPath);\n\n    if (!target) throw new Error(`Could not find component id for path \"${path}\"`);\n    return target.components;\n  }\n}\n"],"mappings":"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"}