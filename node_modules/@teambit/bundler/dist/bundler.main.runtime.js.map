{"version":3,"names":["BundlerMain","constructor","config","pubsub","envs","devService","runtimeSlot","devServer","components","envRuntime","createEnvironment","servers","runOnce","dedicatedEnvDevServers","_componentServers","indexByComponent","getComponentServer","component","undefined","envId","getEnvId","server","find","componentServer","context","relatedContexts","includes","id","computeEntries","slotEntries","Promise","all","values","map","browserRuntime","entry","slotPaths","reduce","acc","current","concat","registerTarget","runtime","register","provider","graphql","dependencyResolver","devServerService","DevServerService","bundler","registerService","devServerSchema","Slot","withType","MainRuntime","PubsubAspect","EnvsAspect","GraphqlAspect","DependencyResolverAspect","ComponentAspect","BundlerAspect","addRuntime"],"sources":["bundler.main.runtime.ts"],"sourcesContent":["import PubsubAspect, { PubsubMain } from '@teambit/pubsub';\nimport { MainRuntime } from '@teambit/cli';\nimport { Component, ComponentAspect } from '@teambit/component';\nimport { DependencyResolverAspect, DependencyResolverMain } from '@teambit/dependency-resolver';\nimport { EnvsAspect, EnvsMain } from '@teambit/envs';\nimport { GraphqlAspect, GraphqlMain } from '@teambit/graphql';\nimport { Slot, SlotRegistry } from '@teambit/harmony';\nimport { BrowserRuntime } from './browser-runtime';\nimport { BundlerAspect } from './bundler.aspect';\nimport { ComponentServer } from './component-server';\nimport { BundlerContext } from './bundler-context';\nimport { devServerSchema } from './dev-server.graphql';\nimport { DevServerService } from './dev-server.service';\n\nexport type BrowserRuntimeSlot = SlotRegistry<BrowserRuntime>;\n\nexport type BundlerConfig = {\n  dedicatedEnvDevServers: string[];\n};\n\n/**\n * bundler extension.\n */\nexport class BundlerMain {\n  constructor(\n    readonly config: BundlerConfig,\n    /**\n     * Pubsub extension.\n     */\n    private pubsub: PubsubMain,\n\n    /**\n     * environments extension.\n     */\n    private envs: EnvsMain,\n\n    /**\n     * dev server service.\n     */\n    private devService: DevServerService,\n\n    /**\n     * browser runtime slot.\n     */\n    private runtimeSlot: BrowserRuntimeSlot\n  ) {}\n\n  /**\n   * load all given components in corresponding dev servers.\n   * @param components defaults to all components in the workspace.\n   */\n  async devServer(components: Component[]): Promise<ComponentServer[]> {\n    const envRuntime = await this.envs.createEnvironment(components);\n    // TODO: this must be refactored away from here. this logic should be in the Preview.\n    const servers: ComponentServer[] = await envRuntime.runOnce<ComponentServer[]>(this.devService, {\n      dedicatedEnvDevServers: this.config.dedicatedEnvDevServers,\n    });\n    this._componentServers = servers;\n\n    this.indexByComponent();\n\n    return this._componentServers;\n  }\n\n  /**\n   * get a dev server instance containing a component.\n   * @param component\n   */\n  getComponentServer(component: Component): undefined | ComponentServer {\n    if (!this._componentServers) return undefined;\n    const envId = this.envs.getEnvId(component);\n    const server = this._componentServers.find(\n      (componentServer) =>\n        componentServer.context.relatedContexts.includes(envId) || componentServer.context.id === envId\n    );\n\n    return server;\n  }\n\n  /**\n   * compute entry files for bundling components in a given execution context.\n   */\n  async computeEntries(context: BundlerContext) {\n    const slotEntries = await Promise.all(\n      this.runtimeSlot.values().map(async (browserRuntime) => browserRuntime.entry(context))\n    );\n\n    const slotPaths = slotEntries.reduce((acc, current) => {\n      acc = acc.concat(current);\n      return acc;\n    });\n\n    return slotPaths;\n  }\n\n  /**\n   * register a new browser runtime environment.\n   * @param browserRuntime\n   */\n  registerTarget(browserRuntime: BrowserRuntime[]) {\n    browserRuntime.map((runtime) => {\n      return this.runtimeSlot.register(runtime);\n    });\n\n    return this;\n  }\n\n  /**\n   * component servers.\n   */\n  private _componentServers: null | ComponentServer[];\n\n  private indexByComponent() {}\n\n  static slots = [Slot.withType<BrowserRuntime>()];\n\n  static runtime = MainRuntime;\n  static dependencies = [PubsubAspect, EnvsAspect, GraphqlAspect, DependencyResolverAspect, ComponentAspect];\n\n  static defaultConfig = {\n    dedicatedEnvDevServers: [],\n  };\n\n  static async provider(\n    [pubsub, envs, graphql, dependencyResolver]: [PubsubMain, EnvsMain, GraphqlMain, DependencyResolverMain],\n    config,\n    [runtimeSlot]: [BrowserRuntimeSlot]\n  ) {\n    const devServerService = new DevServerService(pubsub, dependencyResolver, runtimeSlot);\n    const bundler = new BundlerMain(config, pubsub, envs, devServerService, runtimeSlot);\n    envs.registerService(devServerService);\n\n    graphql.register(devServerSchema(bundler));\n\n    return bundler;\n  }\n}\n\nBundlerAspect.addRuntime(BundlerMain);\n"],"mappings":"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"}