{"version":3,"names":["ComponentServer","constructor","pubsub","context","portRange","devServer","componentsServer","hostname","port","ComponentsServerStartedEvent","Date","now","hasComponent","component","components","find","contextComponent","equals","_port","listen","selectPort","server","address","getHostname","BindError","pub","BundlerAspect","id","createComponentsServerStartedEvent","onChange","url","envRuntime"],"sources":["component-server.ts"],"sourcesContent":["import { Component } from '@teambit/component';\nimport { ExecutionContext } from '@teambit/envs';\nimport { PubsubMain } from '@teambit/pubsub';\n\nimport { AddressInfo } from 'net';\n\nimport { DevServer } from './dev-server';\nimport { BindError } from './exceptions';\nimport { ComponentsServerStartedEvent } from './events';\nimport { BundlerAspect } from './bundler.aspect';\nimport { selectPort } from './select-port';\n\nexport class ComponentServer {\n  // why is this here\n  errors?: Error[];\n  constructor(\n    /**\n     * browser runtime slot\n     */\n    private pubsub: PubsubMain,\n\n    /**\n     * components contained in the existing component server.\n     */\n    readonly context: ExecutionContext,\n\n    /**\n     * port range of the component server.\n     */\n    readonly portRange: number[],\n\n    /**\n     * env dev server.\n     */\n    readonly devServer: DevServer\n  ) {}\n\n  hostname: string | undefined;\n\n  /**\n   * determine whether component server contains a component.\n   */\n  hasComponent(component: Component) {\n    return this.context.components.find((contextComponent) => contextComponent.equals(component));\n  }\n\n  get port() {\n    return this._port;\n  }\n\n  _port: number;\n  async listen() {\n    const port = await selectPort(this.portRange);\n    this._port = port;\n    const server = await this.devServer.listen(port);\n    const address = server.address();\n    const hostname = this.getHostname(address);\n    if (!address) throw new BindError();\n    this.hostname = hostname;\n\n    this.pubsub.pub(BundlerAspect.id, this.createComponentsServerStartedEvent(server, this.context, hostname, port));\n  }\n\n  private getHostname(address: string | AddressInfo | null) {\n    if (address === null) throw new BindError();\n    if (typeof address === 'string') return address;\n\n    let hostname = address.address;\n    if (hostname === '::') {\n      hostname = 'localhost';\n    }\n\n    return hostname;\n  }\n\n  private onChange() {}\n\n  private createComponentsServerStartedEvent: (\n    DevServer,\n    ExecutionContext,\n    string,\n    number\n  ) => ComponentsServerStartedEvent = (componentsServer, context, hostname, port) => {\n    return new ComponentsServerStartedEvent(Date.now(), componentsServer, context, hostname, port);\n  };\n\n  /**\n   * get the url of the component server.\n   */\n  get url() {\n    // tailing `/` is required!\n    return `/preview/${this.context.envRuntime.id}/`;\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAKA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAEO,MAAMA,eAAe,CAAC;EAC3B;;EAEAC,WAAW;EACT;AACJ;AACA;EACYC,MAAkB;EAE1B;AACJ;AACA;EACaC,OAAyB;EAElC;AACJ;AACA;EACaC,SAAmB;EAE5B;AACJ;AACA;EACaC,SAAoB,EAC7B;IAAA,KAhBQH,MAAkB,GAAlBA,MAAkB;IAAA,KAKjBC,OAAyB,GAAzBA,OAAyB;IAAA,KAKzBC,SAAmB,GAAnBA,SAAmB;IAAA,KAKnBC,SAAoB,GAApBA,SAAoB;IAAA;IAAA;IAAA;IAAA,4EAgDK,CAACC,gBAAgB,EAAEH,OAAO,EAAEI,QAAQ,EAAEC,IAAI,KAAK;MACjF,OAAO,KAAIC,sCAA4B,EAACC,IAAI,CAACC,GAAG,EAAE,EAAEL,gBAAgB,EAAEH,OAAO,EAAEI,QAAQ,EAAEC,IAAI,CAAC;IAChG,CAAC;EAjDE;EAIH;AACF;AACA;EACEI,YAAY,CAACC,SAAoB,EAAE;IACjC,OAAO,IAAI,CAACV,OAAO,CAACW,UAAU,CAACC,IAAI,CAAEC,gBAAgB,IAAKA,gBAAgB,CAACC,MAAM,CAACJ,SAAS,CAAC,CAAC;EAC/F;EAEA,IAAIL,IAAI,GAAG;IACT,OAAO,IAAI,CAACU,KAAK;EACnB;EAGA,MAAMC,MAAM,GAAG;IACb,MAAMX,IAAI,GAAG,MAAM,IAAAY,wBAAU,EAAC,IAAI,CAAChB,SAAS,CAAC;IAC7C,IAAI,CAACc,KAAK,GAAGV,IAAI;IACjB,MAAMa,MAAM,GAAG,MAAM,IAAI,CAAChB,SAAS,CAACc,MAAM,CAACX,IAAI,CAAC;IAChD,MAAMc,OAAO,GAAGD,MAAM,CAACC,OAAO,EAAE;IAChC,MAAMf,QAAQ,GAAG,IAAI,CAACgB,WAAW,CAACD,OAAO,CAAC;IAC1C,IAAI,CAACA,OAAO,EAAE,MAAM,KAAIE,uBAAS,GAAE;IACnC,IAAI,CAACjB,QAAQ,GAAGA,QAAQ;IAExB,IAAI,CAACL,MAAM,CAACuB,GAAG,CAACC,wBAAa,CAACC,EAAE,EAAE,IAAI,CAACC,kCAAkC,CAACP,MAAM,EAAE,IAAI,CAAClB,OAAO,EAAEI,QAAQ,EAAEC,IAAI,CAAC,CAAC;EAClH;EAEQe,WAAW,CAACD,OAAoC,EAAE;IACxD,IAAIA,OAAO,KAAK,IAAI,EAAE,MAAM,KAAIE,uBAAS,GAAE;IAC3C,IAAI,OAAOF,OAAO,KAAK,QAAQ,EAAE,OAAOA,OAAO;IAE/C,IAAIf,QAAQ,GAAGe,OAAO,CAACA,OAAO;IAC9B,IAAIf,QAAQ,KAAK,IAAI,EAAE;MACrBA,QAAQ,GAAG,WAAW;IACxB;IAEA,OAAOA,QAAQ;EACjB;EAEQsB,QAAQ,GAAG,CAAC;EAWpB;AACF;AACA;EACE,IAAIC,GAAG,GAAG;IACR;IACA,OAAQ,YAAW,IAAI,CAAC3B,OAAO,CAAC4B,UAAU,CAACJ,EAAG,GAAE;EAClD;AACF;AAAC"}