{"version":3,"names":["PackageManager","constructor","packageManagerName","logger","EventEmitter","name","checkIfFileExistsInCapsule","capsule","file","pathToFile","join","wrkDir","fs","promises","access","e","removeLockFilesInCapsule","safeUnlink","toRemove","unlink","capsulesInstall","capsules","opts","packageManager","longProcessLogger","createLongProcessLogger","length","mapSeries","componentId","component","id","toString","logProgress","execOptions","cwd","getExecCall","execa","Error","installProc","info","stdout","on","d","stderr","warn","console","log","error","linkBitLegacyInCapsule","end","runInstallInFolder","folder","child","stdio","pipeOutput","Promise","resolve","reject","exitStatus","bitLegacyPath","path","getLocalBitLegacyPath","pathOutsideNodeModules","__dirname","endsWith","sep","localBitLegacyPath","mkdirSync","removeSync","createSymlinkOrCopy"],"sources":["package-manager-legacy.ts"],"sourcesContent":["/* eslint-disable no-empty */\n/* eslint-disable @typescript-eslint/no-unused-vars */\n/* eslint-disable @typescript-eslint/no-non-null-assertion */\nimport { Capsule } from '@teambit/isolator';\nimport { Logger } from '@teambit/logger';\nimport { pipeOutput } from '@teambit/legacy/dist/utils/child_process';\nimport createSymlinkOrCopy from '@teambit/legacy/dist/utils/fs/create-symlink-or-copy';\nimport { EventEmitter } from 'events';\nimport execa from 'execa';\nimport fs from 'fs-extra';\nimport mapSeries from 'p-map-series';\nimport path, { join } from 'path';\n\nexport default class PackageManager {\n  private emitter = new EventEmitter();\n  constructor(readonly packageManagerName: string, readonly logger: Logger) {}\n\n  get name() {\n    return this.packageManagerName;\n  }\n  async checkIfFileExistsInCapsule(capsule: Capsule, file: string) {\n    const pathToFile = join(capsule.wrkDir, file);\n    try {\n      await capsule.fs.promises.access(pathToFile);\n      return true;\n    } catch (e: any) {}\n    return false;\n  }\n\n  async removeLockFilesInCapsule(capsule: Capsule) {\n    async function safeUnlink(toRemove: string) {\n      try {\n        await capsule.fs.promises.unlink(join(capsule.wrkDir, toRemove));\n      } catch (e: any) {}\n    }\n    await safeUnlink('yarn.lock');\n    await safeUnlink('package-lock.json');\n  }\n  async capsulesInstall(capsules: Capsule[], opts: {} = {}) {\n    const packageManager = this.packageManagerName;\n    const longProcessLogger = this.logger.createLongProcessLogger('installing capsules', capsules.length);\n    if (packageManager === 'npm' || packageManager === 'yarn' || packageManager === 'pnpm') {\n      // Don't run them in parallel (Promise.all), the package-manager doesn't handle it well.\n      await mapSeries(capsules, async (capsule) => {\n        const componentId = capsule.component.id.toString();\n        longProcessLogger.logProgress(componentId);\n        // TODO: remove this hack once harmony supports ownExtensionName\n        const execOptions = { cwd: capsule.wrkDir };\n        const getExecCall = () => {\n          switch (packageManager) {\n            case 'npm':\n              return execa('npm', ['install', '--no-package-lock'], execOptions);\n            case 'yarn':\n              return execa('yarn', [], execOptions);\n            case 'pnpm':\n              return execa('pnpm', ['install'], execOptions);\n            default:\n              throw new Error(`unsupported package manager ${packageManager}`);\n          }\n        };\n        const installProc = getExecCall();\n        this.logger.info(`${componentId}, ${packageManager === 'npm' ? '$ npm install --no-package-lock' : '$ yarn'}`); // TODO: better\n        installProc.stdout!.on('data', (d) => this.logger.info(`${componentId}, ${d.toString()}`));\n        installProc.stderr!.on('data', (d) => this.logger.warn(`${componentId}, ${d.toString()}`));\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\n        installProc.on('error', (e) => {\n          console.log('error:', e); // eslint-disable-line no-console\n          this.logger.error(`${componentId}, ${e}`);\n        });\n        await installProc;\n        linkBitLegacyInCapsule(capsule);\n      });\n    } else {\n      throw new Error(`unsupported package manager ${packageManager}`);\n    }\n    longProcessLogger.end();\n    return null;\n  }\n\n  async runInstallInFolder(folder: string, opts: {} = {}): Promise<void> {\n    const packageManager = this.packageManagerName;\n    if (packageManager === 'yarn') {\n      const child = execa('yarn', [], { cwd: folder, stdio: 'pipe' });\n      pipeOutput(child);\n      await child;\n      return;\n    }\n    if (packageManager === 'npm') {\n      const child = execa('npm', ['install'], { cwd: folder, stdio: 'pipe' });\n      this.logger.info(`${folder} $ npm install`);\n      await new Promise((resolve, reject) => {\n        // @ts-ignore\n        child.stdout.on('data', (d) => this.logger.info(`${folder} ${d.toString()}`));\n        // @ts-ignore\n        child.stderr.on('data', (d) => this.logger.warn(`${folder} ${d.toString()}`));\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\n        child.on('error', (e) => {\n          reject(e);\n        });\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\n        child.on('close', (exitStatus) => {\n          if (exitStatus) {\n            reject(new Error(`${folder}`));\n          } else {\n            resolve(null);\n          }\n        });\n      });\n      return;\n    }\n    throw new Error(`unsupported package manager ${packageManager}`);\n  }\n}\n\nfunction linkBitLegacyInCapsule(capsule) {\n  const bitLegacyPath = path.join(capsule.wrkDir, './node_modules/@teambit/legacy');\n  const getLocalBitLegacyPath = () => {\n    const pathOutsideNodeModules = path.join(__dirname, '../..');\n    if (pathOutsideNodeModules.endsWith(`${path.sep}dist`)) {\n      return pathOutsideNodeModules;\n    }\n    throw new Error('unable to link @teambit/legacy to the capsule, the location of @teambit/legacy is unknown');\n  };\n  const localBitLegacyPath = getLocalBitLegacyPath();\n  // if there are no deps, sometimes the node_modules folder is not created\n  // and we need it in order to perform the linking\n  try {\n    capsule.fs.mkdirSync('node_modules');\n  } catch (e: any) {\n    // fail silently - we only need to create it if it doesn't already exist\n  }\n  // we use fs directly here rather than the capsule.fs because there are some edge cases\n  // that the capusle fs does not deal with well (eg. identifying and deleting\n  // a symlink rather than the what the symlink links to)\n  fs.removeSync(bitLegacyPath);\n  createSymlinkOrCopy(localBitLegacyPath, bitLegacyPath);\n}\n"],"mappings":"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"}