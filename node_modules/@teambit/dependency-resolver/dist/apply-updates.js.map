{"version":3,"names":["applyUpdates","outdatedPkgs","variantPoliciesByPatterns","componentPoliciesById","updatedWorkspacePolicyEntries","updatedVariants","Set","updatedComponents","outdatedPkg","source","push","dependencyId","name","value","version","latestRange","lifecycleType","targetField","variantPattern","add","componentId","Error","Array","from"],"sources":["apply-updates.ts"],"sourcesContent":["import { OutdatedPkg } from './get-all-policy-pkgs';\nimport { VariantPolicyConfigObject, WorkspacePolicyEntry } from './policy';\n\n/**\n * Applies updates to policies.\n */\nexport function applyUpdates(\n  outdatedPkgs: Array<Omit<OutdatedPkg, 'currentRange'>>,\n  {\n    variantPoliciesByPatterns,\n    componentPoliciesById,\n  }: {\n    variantPoliciesByPatterns: Record<string, VariantPolicyConfigObject>;\n    componentPoliciesById: Record<string, any>;\n  }\n): {\n  updatedVariants: string[];\n  updatedComponents: string[];\n  updatedWorkspacePolicyEntries: WorkspacePolicyEntry[];\n} {\n  const updatedWorkspacePolicyEntries: WorkspacePolicyEntry[] = [];\n  const updatedVariants = new Set<string>();\n  const updatedComponents = new Set<string>();\n\n  for (const outdatedPkg of outdatedPkgs) {\n    switch (outdatedPkg.source) {\n      case 'rootPolicy':\n      case 'component-model':\n        updatedWorkspacePolicyEntries.push({\n          dependencyId: outdatedPkg.name,\n          value: {\n            version: outdatedPkg.latestRange,\n          },\n          lifecycleType: outdatedPkg.targetField === 'peerDependencies' ? 'peer' : 'runtime',\n        });\n        break;\n      case 'variants':\n        if (outdatedPkg.variantPattern) {\n          const { variantPattern, targetField, name } = outdatedPkg;\n          updatedVariants.add(outdatedPkg.variantPattern);\n          // eslint-disable-next-line dot-notation\n          if (variantPoliciesByPatterns[variantPattern]?.[targetField]?.[name]?.['version']) {\n            // eslint-disable-line\n            variantPoliciesByPatterns[variantPattern][targetField]![name]['version'] = outdatedPkg.latestRange; // eslint-disable-line\n          } else {\n            variantPoliciesByPatterns[variantPattern][targetField]![name] = outdatedPkg.latestRange; // eslint-disable-line\n          }\n        }\n        break;\n      case 'component':\n        if (outdatedPkg.componentId) {\n          updatedComponents.add(outdatedPkg.componentId);\n          if (componentPoliciesById[outdatedPkg.componentId][outdatedPkg.targetField][outdatedPkg.name].version) {\n            componentPoliciesById[outdatedPkg.componentId][outdatedPkg.targetField][outdatedPkg.name].version =\n              outdatedPkg.latestRange;\n          } else {\n            componentPoliciesById[outdatedPkg.componentId][outdatedPkg.targetField][outdatedPkg.name] =\n              outdatedPkg.latestRange;\n          }\n        }\n        break;\n      default:\n        throw new Error(`Unsupported policy source for update: ${outdatedPkg.source}`);\n    }\n  }\n  return {\n    updatedVariants: Array.from(updatedVariants),\n    updatedComponents: Array.from(updatedComponents),\n    updatedWorkspacePolicyEntries,\n  };\n}\n"],"mappings":";;;;;;;AAGA;AACA;AACA;AACO,SAASA,YAAY,CAC1BC,YAAsD,EACtD;EACEC,yBAAyB;EACzBC;AAIF,CAAC,EAKD;EACA,MAAMC,6BAAqD,GAAG,EAAE;EAChE,MAAMC,eAAe,GAAG,IAAIC,GAAG,EAAU;EACzC,MAAMC,iBAAiB,GAAG,IAAID,GAAG,EAAU;EAE3C,KAAK,MAAME,WAAW,IAAIP,YAAY,EAAE;IACtC,QAAQO,WAAW,CAACC,MAAM;MACxB,KAAK,YAAY;MACjB,KAAK,iBAAiB;QACpBL,6BAA6B,CAACM,IAAI,CAAC;UACjCC,YAAY,EAAEH,WAAW,CAACI,IAAI;UAC9BC,KAAK,EAAE;YACLC,OAAO,EAAEN,WAAW,CAACO;UACvB,CAAC;UACDC,aAAa,EAAER,WAAW,CAACS,WAAW,KAAK,kBAAkB,GAAG,MAAM,GAAG;QAC3E,CAAC,CAAC;QACF;MACF,KAAK,UAAU;QACb,IAAIT,WAAW,CAACU,cAAc,EAAE;UAAA;UAC9B,MAAM;YAAEA,cAAc;YAAED,WAAW;YAAEL;UAAK,CAAC,GAAGJ,WAAW;UACzDH,eAAe,CAACc,GAAG,CAACX,WAAW,CAACU,cAAc,CAAC;UAC/C;UACA,6BAAIhB,yBAAyB,CAACgB,cAAc,CAAC,4EAAzC,sBAA4CD,WAAW,CAAC,6EAAxD,uBAA2DL,IAAI,CAAC,mDAAhE,uBAAmE,SAAS,CAAC,EAAE;YACjF;YACAV,yBAAyB,CAACgB,cAAc,CAAC,CAACD,WAAW,CAAC,CAAEL,IAAI,CAAC,CAAC,SAAS,CAAC,GAAGJ,WAAW,CAACO,WAAW,CAAC,CAAC;UACtG,CAAC,MAAM;YACLb,yBAAyB,CAACgB,cAAc,CAAC,CAACD,WAAW,CAAC,CAAEL,IAAI,CAAC,GAAGJ,WAAW,CAACO,WAAW,CAAC,CAAC;UAC3F;QACF;;QACA;MACF,KAAK,WAAW;QACd,IAAIP,WAAW,CAACY,WAAW,EAAE;UAC3Bb,iBAAiB,CAACY,GAAG,CAACX,WAAW,CAACY,WAAW,CAAC;UAC9C,IAAIjB,qBAAqB,CAACK,WAAW,CAACY,WAAW,CAAC,CAACZ,WAAW,CAACS,WAAW,CAAC,CAACT,WAAW,CAACI,IAAI,CAAC,CAACE,OAAO,EAAE;YACrGX,qBAAqB,CAACK,WAAW,CAACY,WAAW,CAAC,CAACZ,WAAW,CAACS,WAAW,CAAC,CAACT,WAAW,CAACI,IAAI,CAAC,CAACE,OAAO,GAC/FN,WAAW,CAACO,WAAW;UAC3B,CAAC,MAAM;YACLZ,qBAAqB,CAACK,WAAW,CAACY,WAAW,CAAC,CAACZ,WAAW,CAACS,WAAW,CAAC,CAACT,WAAW,CAACI,IAAI,CAAC,GACvFJ,WAAW,CAACO,WAAW;UAC3B;QACF;QACA;MACF;QACE,MAAM,IAAIM,KAAK,CAAE,yCAAwCb,WAAW,CAACC,MAAO,EAAC,CAAC;IAAC;EAErF;EACA,OAAO;IACLJ,eAAe,EAAEiB,KAAK,CAACC,IAAI,CAAClB,eAAe,CAAC;IAC5CE,iBAAiB,EAAEe,KAAK,CAACC,IAAI,CAAChB,iBAAiB,CAAC;IAChDH;EACF,CAAC;AACH"}