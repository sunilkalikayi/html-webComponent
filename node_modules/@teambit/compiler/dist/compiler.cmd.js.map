{"version":3,"names":["CompileCmd","constructor","compile","logger","pubsub","name","description","report","components","compilerOptions","startTimestamp","process","hrtime","setStatusLine","sub","CompilerAspect","id","onComponentCompilationDone","bind","outputString","compileComponents","initiator","CompilationInitiator","CmdReport","compileTimeLength","chalk","underline","formatCompileResults","componentsStatus","verbose","getStatusLine","clearStatusLine","data","code","getExitCode","json","deleteDistDir","compileResults","CmdJson","failedComponents","filter","component","errors","length","getSummaryIcon","green","red","yellow","numberOfComponents","numberOfFailingComponents","numberOfSuccessfulComponents","icon","summaryLine","prettyTime","event","type","ComponentCompilationOnDoneEvent","TYPE","push"],"sources":["compiler.cmd.ts"],"sourcesContent":["import { Command, CommandOptions } from '@teambit/cli';\nimport { Logger } from '@teambit/logger';\nimport type { PubsubMain, BitBaseEvent } from '@teambit/pubsub';\nimport chalk from 'chalk';\nimport prettyTime from 'pretty-time';\nimport { Component } from '@teambit/component';\nimport { formatCompileResults } from './output-formatter';\nimport { CompileError, WorkspaceCompiler, CompileOptions } from './workspace-compiler';\nimport { CompilationInitiator } from './types';\n\n// IDs & events\nimport { CompilerAspect } from './compiler.aspect';\nimport { ComponentCompilationOnDoneEvent } from './events';\n\nexport type ComponentsStatus = {\n  buildResults: string[];\n  component: Component;\n  errors: CompileError[];\n};\n\nexport class CompileCmd implements Command {\n  componentsStatus: ComponentsStatus[] = [];\n  name = 'compile [component-names...]';\n  description = 'compile components in the workspace';\n  arguments = [\n    {\n      name: 'component-names...',\n      description: 'a list of component names or component IDs (defaults to all components)',\n    },\n  ];\n  alias = '';\n  group = 'development';\n  options = [\n    ['c', 'changed', 'compile only new and modified components'],\n    ['v', 'verbose', 'show more data, such as, dist paths'],\n    ['j', 'json', 'return the compile results in json format'],\n    ['d', 'delete-dist-dir', 'delete existing dist folder before writing new compiled files'],\n  ] as CommandOptions;\n\n  constructor(private compile: WorkspaceCompiler, private logger: Logger, private pubsub: PubsubMain) {}\n\n  async report([components = []]: [string[]], compilerOptions: CompileOptions) {\n    const startTimestamp = process.hrtime();\n    this.logger.setStatusLine('Compiling your components, hold tight.');\n    this.pubsub.sub(CompilerAspect.id, this.onComponentCompilationDone.bind(this));\n\n    let outputString = '';\n    await this.compile.compileComponents(components, {\n      ...compilerOptions,\n      initiator: CompilationInitiator.CmdReport,\n    });\n    const compileTimeLength = process.hrtime(startTimestamp);\n\n    outputString += '\\n';\n    outputString += `  ${chalk.underline('STATUS')}\\t${chalk.underline('COMPONENT ID')}\\n`;\n    outputString += formatCompileResults(this.componentsStatus, !!compilerOptions.verbose);\n    outputString += '\\n';\n\n    outputString += this.getStatusLine(this.componentsStatus, compileTimeLength);\n\n    this.logger.clearStatusLine();\n\n    return {\n      data: outputString,\n      code: this.getExitCode(this.componentsStatus),\n    };\n  }\n\n  async json([components]: [string[]], compilerOptions: CompileOptions) {\n    compilerOptions.deleteDistDir = true;\n    // @ts-ignore\n    const compileResults = await this.compile.compileComponents(components, {\n      ...compilerOptions,\n      initiator: CompilationInitiator.CmdJson,\n    });\n    return {\n      data: compileResults,\n      // @todo: fix the code once compile is ready.\n      code: 0,\n    };\n  }\n\n  private failedComponents(componentsStatus: ComponentsStatus[]): ComponentsStatus[] {\n    return componentsStatus.filter((component) => component.errors.length);\n  }\n\n  private getSummaryIcon(componentsStatus: ComponentsStatus[]) {\n    switch (this.failedComponents(componentsStatus).length) {\n      case 0:\n        return chalk.green('✔');\n      case componentsStatus.length:\n        return chalk.red('✗');\n      default:\n        return chalk.yellow('⍻');\n    }\n  }\n\n  private getExitCode(componentsStatus: ComponentsStatus[]) {\n    return this.failedComponents(componentsStatus).length ? 1 : 0;\n  }\n\n  private getStatusLine(componentsStatus: ComponentsStatus[], compileTimeLength) {\n    const numberOfComponents = componentsStatus.length;\n    const numberOfFailingComponents = this.failedComponents(componentsStatus).length;\n    const numberOfSuccessfulComponents = componentsStatus.filter((component) => !component.errors.length).length;\n\n    const icon = this.getSummaryIcon(componentsStatus);\n    const summaryLine = numberOfFailingComponents\n      ? `${icon} ${numberOfFailingComponents}/${numberOfComponents} components failed to compile.`\n      : `${icon} ${numberOfSuccessfulComponents}/${numberOfComponents} components compiled successfully.`;\n\n    return `${summaryLine}\\nFinished. (${prettyTime(compileTimeLength)})`;\n  }\n\n  private onComponentCompilationDone(event: BitBaseEvent<any>) {\n    if (event.type === ComponentCompilationOnDoneEvent.TYPE) {\n      this.componentsStatus.push(event.data);\n    }\n  }\n}\n"],"mappings":"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"}