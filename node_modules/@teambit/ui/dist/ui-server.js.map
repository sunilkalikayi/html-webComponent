{"version":3,"names":["UIServer","constructor","graphql","expressExtension","ui","uiRoot","uiRootExtension","logger","publicDir","plugins","Promise","resolve","setReady","getName","name","port","_port","host","fullUrl","buildOptions","getDevConfig","aspects","resolveAspects","UIRuntime","devConfig","path","generateRoot","whenReady","all","startPromise","map","x","start","portRange","app","createApp","root","join","server","createServer","configureProxy","use","express","static","index","Port","getPortFromRange","setupServerSideRendering","fallback","listen","info","getPluginsComponents","plugin","render","ssr","ssrMiddleware","createSsrMiddleware","title","warn","get","debug","proxServer","httpProxy","createProxyServer","on","e","error","message","proxyEntries","getProxyFromPlugins","req","socket","head","entry","find","proxy","context","some","item","url","ws","target","forEach","route","res","web","originalUrl","dev","devServerPort","selectPort","expressAppPort","config","compiler","webpack","devServerConfig","getDevServerConfig","devServer","WebpackDevServer","proxiesByPlugin","getProxy","flatten","gqlProxies","changeOrigin","concat","appPort","gqlPort","devServerConf","create","props","startPlugins"],"sources":["ui-server.ts"],"sourcesContent":["import { flatten } from 'lodash';\nimport { ExpressMain } from '@teambit/express';\nimport { GraphqlMain } from '@teambit/graphql';\nimport { Logger } from '@teambit/logger';\nimport express, { Express } from 'express';\nimport fallback from 'express-history-api-fallback';\nimport { Port } from '@teambit/toolbox.network.get-port';\nimport { Server } from 'http';\nimport httpProxy from 'http-proxy';\nimport { join } from 'path';\nimport webpack from 'webpack';\nimport WebpackDevServer, { Configuration as WdsConfiguration } from 'webpack-dev-server';\nimport { createSsrMiddleware } from './ssr-middleware';\nimport { StartPlugin } from './start-plugin';\nimport { ProxyEntry, UIRoot } from './ui-root';\nimport { UIRuntime } from './ui.aspect';\nimport { UiMain } from './ui.main.runtime';\n\nimport { devConfig } from './webpack/webpack.dev.config';\n\nexport type UIServerProps = {\n  graphql: GraphqlMain;\n  express: ExpressMain;\n  ui: UiMain;\n  uiRoot: UIRoot;\n  uiRootExtension: string;\n  logger: Logger;\n  publicDir: string;\n  startPlugins: StartPlugin[];\n};\n\nexport type StartOptions = {\n  /**\n   * port range for the UI server to bind. default is a port range of 4000-4200.\n   */\n  portRange?: number[] | number;\n};\n\nexport class UIServer {\n  constructor(\n    private graphql: GraphqlMain,\n    private expressExtension: ExpressMain,\n    private ui: UiMain,\n    private uiRoot: UIRoot,\n    private uiRootExtension: string,\n    private logger: Logger,\n    private publicDir: string,\n    private plugins: StartPlugin[]\n  ) {}\n\n  getName() {\n    return this.uiRoot.name;\n  }\n\n  private _port = 0;\n\n  get port() {\n    return this._port;\n  }\n\n  /** the hostname for the server to listen at. Currently statically 'localhost' */\n  get host() {\n    return 'localhost';\n  }\n\n  /** the server listens at this url */\n  get fullUrl() {\n    const port = this.port !== 80 ? `:${this.port}` : '';\n    return `http://${this.host}${port}`;\n  }\n\n  get buildOptions() {\n    return this.uiRoot.buildOptions;\n  }\n\n  /**\n   * get the webpack configuration of the UI server.\n   */\n  async getDevConfig() {\n    const aspects = await this.uiRoot.resolveAspects(UIRuntime.name);\n\n    return devConfig(this.uiRoot.path, [await this.ui.generateRoot(aspects, this.uiRootExtension)], this.uiRoot.name);\n  }\n\n  private setReady: () => void;\n  private startPromise = new Promise<void>((resolve) => (this.setReady = resolve));\n  get whenReady() {\n    return Promise.all([this.startPromise, ...this.plugins.map((x) => x?.whenReady)]);\n  }\n\n  /**\n   * start a UI server.\n   */\n  async start({ portRange }: StartOptions = {}) {\n    const app = this.expressExtension.createApp();\n    const publicDir = `/${this.publicDir}`;\n    const root = join(this.uiRoot.path, publicDir);\n    const server = await this.graphql.createServer({ app });\n\n    // set up proxy, for things like preview, e.g. '/preview/teambit.react/react'\n    await this.configureProxy(app, server);\n\n    // pass through files from public /folder:\n    // setting `index: false` so index.html will be served by the fallback() middleware\n    app.use(express.static(root, { index: false }));\n\n    const port = await Port.getPortFromRange(portRange || [3100, 3200]);\n\n    await this.setupServerSideRendering({ root, port, app });\n\n    // in any and all other cases, serve index.html.\n    // No any other endpoints past this will execute\n    app.use(fallback('index.html', { root }));\n\n    server.listen(port);\n    this._port = port;\n\n    // important: we use the string of the following message for the http.e2e.ts. if you change the message,\n    // please make sure you change the `HTTP_SERVER_READY_MSG` const.\n    this.logger.info(`UI server of ${this.uiRootExtension} is listening to port ${port}`);\n\n    this.setReady();\n  }\n\n  getPluginsComponents() {\n    return this.plugins.map((plugin) => plugin.render);\n  }\n\n  private async setupServerSideRendering({ root, port, app }: { root: string; port: number; app: Express }) {\n    if (!this.buildOptions?.ssr) return;\n\n    const ssrMiddleware = await createSsrMiddleware({\n      root,\n      port,\n      title: this.uiRoot.name,\n      logger: this.logger,\n    });\n\n    if (!ssrMiddleware) {\n      this.logger.warn('[ssr] middleware failed setup');\n      return;\n    }\n\n    // eslint-disable-next-line @typescript-eslint/no-misused-promises\n    app.get('*', ssrMiddleware);\n    this.logger.debug('[ssr] serving for \"*\"');\n  }\n\n  private async configureProxy(app: Express, server: Server) {\n    const proxServer = httpProxy.createProxyServer();\n    proxServer.on('error', (e) => this.logger.error(e.message));\n    const proxyEntries = await this.getProxyFromPlugins();\n\n    // TODO - should use https://github.com/chimurai/http-proxy-middleware\n    server.on('upgrade', function (req, socket, head) {\n      const entry = proxyEntries.find((proxy) => proxy.context.some((item) => item === req.url));\n      if (!entry) return;\n      proxServer.ws(req, socket, head, {\n        target: entry.target,\n      });\n    });\n\n    proxyEntries.forEach((entry) => {\n      entry.context.forEach((route) => {\n        app.use(`${route}/*`, (req, res) => {\n          proxServer.web(req, res, { ...entry, target: `${entry.target}/${req.originalUrl}` });\n        });\n      });\n    });\n  }\n\n  /**\n   * start a UI dev server.\n   */\n  async dev({ portRange }: StartOptions = {}) {\n    const devServerPort = await this.selectPort(portRange);\n    await this.start({ portRange: [4100, 4200] });\n    const expressAppPort = this._port;\n\n    const config = await this.getDevConfig();\n    const compiler = webpack(config);\n    const devServerConfig = await this.getDevServerConfig(devServerPort, expressAppPort, config.devServer);\n    // @ts-ignore in the capsules it throws an error about compatibilities issues between webpack.compiler and webpackDevServer/webpack/compiler\n    const devServer = new WebpackDevServer(devServerConfig, compiler);\n\n    await devServer.start();\n    this._port = devServerPort;\n    return devServer;\n  }\n\n  private async selectPort(portRange?: number[] | number) {\n    return Port.getPortFromRange(portRange || [3100, 3200]);\n  }\n\n  private async getProxyFromPlugins(): Promise<ProxyEntry[]> {\n    const proxiesByPlugin = this.plugins.map((plugin) => {\n      return plugin.getProxy ? plugin.getProxy() : [];\n    });\n\n    return flatten(await Promise.all(proxiesByPlugin));\n  }\n\n  private async getProxy(port = 4000) {\n    const proxyEntries = await this.getProxyFromPlugins();\n\n    const gqlProxies: ProxyEntry[] = [\n      {\n        context: ['/graphql', '/api'],\n        target: `http://${this.host}:${port}`,\n        changeOrigin: true,\n      },\n      {\n        context: ['/subscriptions'],\n        target: `ws://${this.host}:${port}`,\n        ws: true,\n      },\n    ];\n\n    return gqlProxies.concat(proxyEntries);\n  }\n\n  private async getDevServerConfig(\n    appPort: number,\n    gqlPort: number,\n    config?: WdsConfiguration\n  ): Promise<WdsConfiguration> {\n    const proxy = await this.getProxy(gqlPort);\n    const devServerConf = { ...config, proxy, port: appPort };\n\n    return devServerConf;\n  }\n\n  static create(props: UIServerProps) {\n    return new UIServer(\n      props.graphql,\n      props.express,\n      props.ui,\n      props.uiRoot,\n      props.uiRootExtension,\n      props.logger,\n      props.publicDir,\n      props.startPlugins\n    );\n  }\n}\n"],"mappings":"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"}