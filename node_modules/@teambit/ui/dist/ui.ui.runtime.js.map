{"version":3,"names":["UiUI","constructor","router","uiRootSlot","hudSlot","renderPluginsSlot","element","register","render","rootExtension","rootFactory","getRoot","Error","uiRoot","routes","renderRoutes","hudItems","values","lifecyclePlugins","getLifecyclePlugins","reactSsr","BrowserRenderer","renderSsr","ssrContent","ServerRenderer","fullHtml","registerContext","context","reactContext","registerRoot","registerRenderHooks","plugin","toArray","map","key","unshift","renderPlugin","get","provider","GraphqlUi","config","renderLifecycleSlot","uiUi","renderPlugins","Slot","withType","GraphqlAspect","ReactRouterAspect","UIRuntime","UIAspect","addRuntime"],"sources":["ui.ui.runtime.tsx"],"sourcesContent":["import type { GraphqlUI } from '@teambit/graphql';\nimport { GraphqlAspect } from '@teambit/graphql';\nimport { Slot, SlotRegistry } from '@teambit/harmony';\nimport type { ReactRouterUI } from '@teambit/react-router';\nimport { ReactRouterAspect } from '@teambit/react-router';\nimport { ServerRenderer, BrowserRenderer } from '@teambit/react.rendering.ssr';\nimport type { SsrSession, RenderPlugin, ContextProps } from '@teambit/react.rendering.ssr';\n\nimport React, { ReactNode, ComponentType } from 'react';\n\nimport { UIRootFactory } from './ui-root.ui';\nimport { UIAspect, UIRuntime } from './ui.aspect';\nimport { ClientContext } from './ui/client-context';\n\ntype HudSlot = SlotRegistry<ReactNode>;\ntype RenderPluginsSlot = SlotRegistry<RenderPlugin<any, any>>;\ntype UIRootRegistry = SlotRegistry<UIRootFactory>;\n\n/**\n * extension\n */\nexport class UiUI {\n  constructor(\n    /**\n     * react-router extension.\n     */\n    private router: ReactRouterUI,\n    /**\n     * ui root registry.\n     */\n    private uiRootSlot: UIRootRegistry,\n    /** slot for overlay ui elements */\n    private hudSlot: HudSlot,\n    /** hooks into the ssr render process */\n    private renderPluginsSlot: RenderPluginsSlot\n  ) {}\n\n  /** render and rehydrate client-side */\n  async render(rootExtension: string): Promise<void> {\n    const rootFactory = this.getRoot(rootExtension);\n    if (!rootFactory) throw new Error(`root: ${rootExtension} was not found`);\n    const uiRoot = rootFactory();\n    const routes = this.router.renderRoutes(uiRoot.routes);\n    const hudItems = this.hudSlot.values();\n    const lifecyclePlugins = this.getLifecyclePlugins();\n\n    const reactSsr = new BrowserRenderer(lifecyclePlugins);\n    await reactSsr.render(\n      <ClientContext>\n        {hudItems}\n        {routes}\n      </ClientContext>\n    );\n  }\n\n  /** render dehydrated server-side */\n  async renderSsr(rootExtension: string, ssrContent: SsrSession): Promise<string> {\n    const rootFactory = this.getRoot(rootExtension);\n    if (!rootFactory) throw new Error(`root: ${rootExtension} was not found`);\n\n    const uiRoot = rootFactory();\n    const routes = this.router.renderRoutes(uiRoot.routes);\n    const hudItems = this.hudSlot.values();\n    const lifecyclePlugins = this.getLifecyclePlugins();\n\n    const reactSsr = new ServerRenderer(lifecyclePlugins);\n    const fullHtml = await reactSsr.render(\n      <ClientContext>\n        {hudItems}\n        {routes}\n      </ClientContext>,\n      ssrContent\n    );\n\n    return fullHtml;\n  }\n\n  /** adds elements to the Heads Up Display */\n  registerHudItem = (element: ReactNode) => {\n    this.hudSlot.register(element);\n  };\n\n  /**\n   * adds global context at the ui root\n   * @deprecated replace with `.registerRenderHooks({ reactContext })`.\n   */\n  registerContext<T>(context: ComponentType<ContextProps<T>>) {\n    this.renderPluginsSlot.register({ reactContext: context });\n  }\n\n  registerRoot(uiRoot: UIRootFactory) {\n    return this.uiRootSlot.register(uiRoot);\n  }\n\n  registerRenderHooks<T, Y>(plugin: RenderPlugin<T, Y>) {\n    return this.renderPluginsSlot.register(plugin);\n  }\n\n  private getLifecyclePlugins() {\n    const lifecyclePlugins = this.renderPluginsSlot.toArray().map(([key, plugin]) => {\n      if (plugin.key) return plugin;\n\n      // for backward compatibility\n      return { ...plugin, key };\n    });\n\n    // react-router should register its plugin, when we can reverse it's dependency to depend on Ui\n    lifecyclePlugins.unshift(this.router.renderPlugin);\n\n    return lifecyclePlugins;\n  }\n\n  private getRoot(rootExtension: string) {\n    return this.uiRootSlot.get(rootExtension);\n  }\n\n  static slots = [Slot.withType<UIRootFactory>(), Slot.withType<ReactNode>(), Slot.withType<RenderPlugin>()];\n\n  static dependencies = [GraphqlAspect, ReactRouterAspect];\n\n  static runtime = UIRuntime;\n\n  static async provider(\n    [GraphqlUi, router]: [GraphqlUI, ReactRouterUI],\n    config,\n    [uiRootSlot, hudSlot, renderLifecycleSlot]: [UIRootRegistry, HudSlot, RenderPluginsSlot]\n  ) {\n    const uiUi = new UiUI(router, uiRootSlot, hudSlot, renderLifecycleSlot);\n\n    if (GraphqlUi) uiUi.registerRenderHooks(GraphqlUi.renderPlugins);\n\n    return uiUi;\n  }\n}\n\nUIAspect.addRuntime(UiUI);\n"],"mappings":"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"}