{"version":3,"names":["denyList","createSsrMiddleware","root","port","title","logger","runtime","loadRuntime","undefined","render","assets","serverRenderMiddleware","request","response","next","query","url","browser","browserFromExpress","test","debug","rendering","method","server","props","rendered","set","send","e","error","entryFilepath","path","join","fs","existsSync","warn","manifestFilepath","parseManifest","imported","default","filepath","file","readFile","contents","toString","parsed","JSON","parse","getAssets","process","exit","manifest","css","js","entrypoints","filter","x","endsWith","map"],"sources":["ssr-middleware.ts"],"sourcesContent":["import { browserFromExpress } from '@teambit/react.rendering.ssr';\nimport type { HtmlAssets, SsrSession } from '@teambit/react.rendering.ssr';\nimport type { Logger } from '@teambit/logger';\nimport type { Request, Response, NextFunction } from 'express';\nimport path from 'path';\nimport * as fs from 'fs-extra';\n\nconst denyList = /^\\/favicon.ico$/;\n\ntype ssrRenderProps = {\n  root: string;\n  port: number;\n  title: string;\n  logger: Logger;\n};\n\ntype ManifestFile = {\n  files?: Record<string, string>;\n  entrypoints?: string[];\n};\n\nexport async function createSsrMiddleware({ root, port, title, logger }: ssrRenderProps) {\n  const runtime = await loadRuntime(root, { logger });\n  if (!runtime) return undefined;\n\n  const { render } = runtime;\n  const assets = { ...runtime.assets, title };\n\n  return async function serverRenderMiddleware(request: Request, response: Response, next: NextFunction) {\n    const { query, url } = request;\n\n    const browser = browserFromExpress(request, port);\n\n    if (denyList.test(url)) {\n      logger.debug(`[ssr] skipping static denyList file ${url}`);\n      next();\n      return;\n    }\n\n    if (query.rendering === 'client') {\n      logger.debug(`[ssr] skipping ${url}`);\n      next();\n      return;\n    }\n\n    logger.debug(`[ssr] ${request.method} ${url}`);\n    const server = { port, request, response };\n    const props: SsrSession = { assets, browser, request, response, server };\n\n    try {\n      const rendered = await render(props);\n      response.set('Cache-Control', 'no-cache');\n      response.send(rendered);\n      logger.debug(`[ssr] success '${url}'`);\n    } catch (e: any) {\n      logger.error(`[ssr] failed at '${url}'`, e);\n      next();\n    }\n  };\n}\n\nasync function loadRuntime(root: string, { logger }: { logger: Logger }) {\n  let render: (...arg: any[]) => any;\n  let assets: HtmlAssets | undefined;\n\n  try {\n    const entryFilepath = path.join(root, 'ssr', 'index.js');\n    if (!fs.existsSync(entryFilepath)) {\n      logger.warn(`[ssr] - Skipping setup - failed finding ssr bundle at \"${entryFilepath}\"`);\n      return undefined;\n    }\n\n    const manifestFilepath = path.join(root, 'asset-manifest.json');\n    if (!fs.existsSync(manifestFilepath)) {\n      logger.warn('[ssr] - Skipping setup (cannot find asset manifest file)');\n      return undefined;\n    }\n\n    assets = await parseManifest(manifestFilepath);\n    if (!assets) {\n      logger.warn('[ssr] - Skipping setup (failed parsing assets manifest)');\n      return undefined;\n    }\n\n    const imported = await import(entryFilepath);\n    render = imported?.default || imported?.render;\n\n    if (!render || typeof render !== 'function') {\n      logger.warn('[ssr] - index file does not export a render() function. Skipping setup.');\n      return undefined;\n    }\n  } catch (e: any) {\n    logger.error(e);\n    return undefined;\n  }\n\n  return {\n    render,\n    assets,\n  };\n}\n\nasync function parseManifest(filepath: string, logger?: Logger) {\n  try {\n    const file = await fs.readFile(filepath);\n    logger?.debug('[ssr] - ✓ aread manifest file');\n    const contents = file.toString();\n    const parsed: ManifestFile = JSON.parse(contents);\n    logger?.debug('[ssr] - ✓ prased manifest file', parsed);\n    const assets = getAssets(parsed);\n    logger?.debug('[ssr] - ✓ extracted data from manifest file', assets);\n\n    return assets;\n  } catch (e: any) {\n    logger?.error('[ssr] - error parsing asset manifest', e);\n    process.exit();\n    return undefined;\n  }\n}\n\nfunction getAssets(manifest: ManifestFile) {\n  const assets: HtmlAssets = { css: [], js: [] };\n\n  assets.css = manifest.entrypoints?.filter((x) => x.endsWith('css')).map((x) => path.join('/', x));\n  assets.js = manifest.entrypoints?.filter((x) => x.endsWith('js')).map((x) => path.join('/', x));\n\n  return assets;\n}\n"],"mappings":"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"}