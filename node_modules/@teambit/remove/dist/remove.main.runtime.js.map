{"version":3,"names":["BEFORE_REMOVE","RemoveMain","constructor","workspace","logger","remove","componentsPattern","force","remote","track","deleteFiles","fromLane","setStatusLine","bitIds","getRemoteBitIdsToRemove","getLocalBitIdsToRemove","consumer","removeResults","removeComponents","ids","BitIds","fromArray","onDestroy","softRemove","ConsumerNotFound","componentIds","idsByPattern","components","getMany","newComps","filter","c","id","hasVersion","length","BitError","map","toString","join","removeComponentsFromNodeModules","state","_consumer","compId","bitMap","addComponentConfig","RemoveAspect","removed","write","_legacy","deleteComponentsFiles","getRemoveInfo","component","data","config","extensions","findExtension","isRemoved","getRemovedStaged","stagedConfig","scope","getStagedConfig","getAll","compConfig","hasWildcard","getRemoteBitIdsByWildcards","BitId","parse","provider","cli","loggerMain","componentAspect","createLogger","removeMain","registerShowFragments","RemoveFragment","register","RemoveCmd","WorkspaceAspect","CLIAspect","LoggerAspect","ComponentAspect","MainRuntime","addRuntime"],"sources":["remove.main.runtime.ts"],"sourcesContent":["import { CLIAspect, CLIMain, MainRuntime } from '@teambit/cli';\nimport { Logger, LoggerAspect, LoggerMain } from '@teambit/logger';\nimport WorkspaceAspect, { Workspace } from '@teambit/workspace';\nimport { BitId } from '@teambit/legacy-bit-id';\nimport { BitIds } from '@teambit/legacy/dist/bit-id';\nimport removeComponents from '@teambit/legacy/dist/consumer/component-ops/remove-components';\nimport { ConsumerNotFound } from '@teambit/legacy/dist/consumer/exceptions';\nimport hasWildcard from '@teambit/legacy/dist/utils/string/has-wildcard';\nimport { getRemoteBitIdsByWildcards } from '@teambit/legacy/dist/api/consumer/lib/list-scope';\nimport { ComponentID } from '@teambit/component-id';\nimport { BitError } from '@teambit/bit-error';\nimport deleteComponentsFiles from '@teambit/legacy/dist/consumer/component-ops/delete-component-files';\nimport ComponentAspect, { Component, ComponentMain } from '@teambit/component';\nimport { removeComponentsFromNodeModules } from '@teambit/legacy/dist/consumer/component/package-json-utils';\nimport { RemoveCmd } from './remove-cmd';\nimport { RemoveAspect } from './remove.aspect';\nimport { RemoveFragment } from './remove.fragment';\n\nconst BEFORE_REMOVE = 'removing components';\n\nexport type RemoveInfo = {\n  removed: boolean;\n};\n\nexport class RemoveMain {\n  constructor(private workspace: Workspace, private logger: Logger) {}\n\n  async remove({\n    componentsPattern,\n    force,\n    remote,\n    track,\n    deleteFiles,\n    fromLane,\n  }: {\n    componentsPattern: string;\n    force: boolean;\n    remote: boolean;\n    track: boolean;\n    deleteFiles: boolean;\n    fromLane: boolean;\n  }): Promise<any> {\n    this.logger.setStatusLine(BEFORE_REMOVE);\n    const bitIds = remote\n      ? await this.getRemoteBitIdsToRemove(componentsPattern)\n      : await this.getLocalBitIdsToRemove(componentsPattern);\n    this.logger.setStatusLine(BEFORE_REMOVE); // again because the loader might changed when talking to the remote\n    const consumer = this.workspace?.consumer;\n    const removeResults = await removeComponents({\n      consumer,\n      ids: BitIds.fromArray(bitIds),\n      force,\n      remote,\n      track,\n      deleteFiles,\n      fromLane,\n    });\n    if (consumer) await consumer.onDestroy();\n    return removeResults;\n  }\n\n  async softRemove(componentsPattern: string): Promise<ComponentID[]> {\n    if (!this.workspace) throw new ConsumerNotFound();\n    const componentIds = await this.workspace.idsByPattern(componentsPattern);\n    const components = await this.workspace.getMany(componentIds);\n    const newComps = components.filter((c) => !c.id.hasVersion());\n    if (newComps.length) {\n      throw new BitError(\n        `unable to soft-remove the following new component(s), please remove them without --soft\\n${newComps\n          .map((c) => c.id.toString())\n          .join('\\n')}`\n      );\n    }\n    await removeComponentsFromNodeModules(\n      this.workspace.consumer,\n      components.map((c) => c.state._consumer)\n    );\n    // don't use `this.workspace.addSpecificComponentConfig`, if the component has component.json it will be deleted\n    // during this removal along with the entire component dir.\n    componentIds.map((compId) =>\n      this.workspace.bitMap.addComponentConfig(compId, RemoveAspect.id, {\n        removed: true,\n      })\n    );\n    await this.workspace.bitMap.write();\n    const bitIds = BitIds.fromArray(componentIds.map((id) => id._legacy));\n    await deleteComponentsFiles(this.workspace.consumer, bitIds);\n\n    return componentIds;\n  }\n\n  getRemoveInfo(component: Component): RemoveInfo {\n    const data = component.config.extensions.findExtension(RemoveAspect.id)?.config as RemoveInfo | undefined;\n    return {\n      removed: data?.removed || false,\n    };\n  }\n\n  isRemoved(component: Component): boolean {\n    return this.getRemoveInfo(component).removed;\n  }\n\n  /**\n   * get components that were soft-removed and tagged/snapped but not exported yet.\n   */\n  async getRemovedStaged(): Promise<ComponentID[]> {\n    const stagedConfig = await this.workspace.scope.getStagedConfig();\n    return stagedConfig\n      .getAll()\n      .filter((compConfig) => compConfig.config?.[RemoveAspect.id]?.removed)\n      .map((compConfig) => compConfig.id);\n  }\n\n  private async getLocalBitIdsToRemove(componentsPattern: string): Promise<BitId[]> {\n    if (!this.workspace) throw new ConsumerNotFound();\n    const componentIds = await this.workspace.idsByPattern(componentsPattern);\n    return componentIds.map((id) => id._legacy);\n  }\n\n  private async getRemoteBitIdsToRemove(componentsPattern: string): Promise<BitId[]> {\n    if (hasWildcard(componentsPattern)) {\n      return getRemoteBitIdsByWildcards(componentsPattern);\n    }\n    return [BitId.parse(componentsPattern, true)];\n  }\n\n  static slots = [];\n  static dependencies = [WorkspaceAspect, CLIAspect, LoggerAspect, ComponentAspect];\n  static runtime = MainRuntime;\n\n  static async provider([workspace, cli, loggerMain, componentAspect]: [\n    Workspace,\n    CLIMain,\n    LoggerMain,\n    ComponentMain\n  ]) {\n    const logger = loggerMain.createLogger(RemoveAspect.id);\n    const removeMain = new RemoveMain(workspace, logger);\n    componentAspect.registerShowFragments([new RemoveFragment(removeMain)]);\n    cli.register(new RemoveCmd(removeMain));\n    return new RemoveMain(workspace, logger);\n  }\n}\n\nRemoveAspect.addRuntime(RemoveMain);\n\nexport default RemoveMain;\n"],"mappings":"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"}