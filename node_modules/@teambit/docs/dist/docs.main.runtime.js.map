{"version":3,"names":["DocsMain","constructor","patterns","preview","pkg","compiler","workspace","logger","devFiles","envs","docPropSlot","docReaderSlot","getDocsMap","components","ComponentMap","as","component","getDocsFiles","computeDevFiles","docFiles","get","DocsAspect","id","state","filesystem","files","filter","file","includes","relative","getDescription","componentDoc","getDoc","desc","description","consumerComponent","_consumer","fromJsDocs","docs","find","doc","getTemplate","env","getDocsTemplate","getDocReader","extension","values","docReader","isFormatSupported","computeDoc","length","docFile","extname","FileExtensionNotSupported","read","contents","err","debug","message","docData","data","Doc","filePath","DocPropList","props","getPatterns","getComponentDevPatterns","calculateEnv","componentEnvDocsDevPatterns","getDocsDevPatterns","componentPatterns","concat","getDevPatternToRegister","bind","registerDocReader","register","provider","graphql","loggerAspect","config","createLogger","DefaultDocReader","registerDevPattern","onComponentLoad","opts","loadDocs","undefined","toObject","docsSchema","registerDefinition","DocsPreviewDefinition","Slot","withType","MainRuntime","PreviewAspect","GraphqlAspect","WorkspaceAspect","PkgAspect","CompilerAspect","LoggerAspect","DevFilesAspect","EnvsAspect","addRuntime"],"sources":["docs.main.runtime.ts"],"sourcesContent":["import { Slot, SlotRegistry } from '@teambit/harmony';\nimport { MainRuntime } from '@teambit/cli';\nimport { LoggerAspect, LoggerMain, Logger } from '@teambit/logger';\nimport { CompilerAspect, CompilerMain } from '@teambit/compiler';\nimport { Component, ComponentMap, IComponent } from '@teambit/component';\nimport { PkgAspect, PkgMain } from '@teambit/pkg';\nimport type { Environment } from '@teambit/envs';\nimport { GraphqlAspect, GraphqlMain } from '@teambit/graphql';\nimport { PreviewAspect, PreviewMain } from '@teambit/preview';\nimport DevFilesAspect, { DevFilesMain } from '@teambit/dev-files';\nimport { AbstractVinyl } from '@teambit/legacy/dist/consumer/component/sources';\nimport ConsumerComponent from '@teambit/legacy/dist/consumer/component';\nimport { Workspace, WorkspaceAspect } from '@teambit/workspace';\nimport { Doc, DocPropList } from '@teambit/docs.entities.doc';\nimport { EnvsAspect, EnvsMain } from '@teambit/envs';\nimport { DocsAspect } from './docs.aspect';\nimport { DocsPreviewDefinition } from './docs.preview-definition';\nimport { docsSchema } from './docs.graphql';\nimport { DocReader } from './doc-reader';\nimport { DefaultDocReader } from './default-doc-reader';\nimport { FileExtensionNotSupported } from './exceptions';\n\nexport type ComponentDocs = {\n  files: string[];\n  component: Component;\n};\n\nexport type DocProp = {};\n\nexport type DocPropSlot = SlotRegistry<DocProp>;\n\nexport type DocReaderSlot = SlotRegistry<DocReader>;\n\nexport type DocsConfig = {\n  /**\n   * glob patterns to identify doc files.\n   */\n  patterns: string[];\n};\n\n/**\n * the component documentation extension.\n */\nexport class DocsMain {\n  constructor(\n    private patterns: string[],\n    /**\n     * envs extension.\n     */\n    private preview: PreviewMain,\n\n    private pkg: PkgMain,\n\n    private compiler: CompilerMain,\n\n    private workspace: Workspace,\n\n    private logger: Logger,\n\n    private devFiles: DevFilesMain,\n\n    private envs: EnvsMain,\n\n    private docPropSlot: DocPropSlot,\n\n    private docReaderSlot: DocReaderSlot\n  ) {}\n\n  /**\n   * returns an array of doc file paths for a set of components.\n   */\n  getDocsMap(components: Component[]): ComponentMap<AbstractVinyl[]> {\n    return ComponentMap.as<AbstractVinyl[]>(components, (component) => {\n      return this.getDocsFiles(component);\n    });\n  }\n\n  getDocsFiles(component: Component): AbstractVinyl[] {\n    const devFiles = this.devFiles.computeDevFiles(component);\n    const docFiles = devFiles.get(DocsAspect.id);\n    return component.state.filesystem.files.filter((file) => docFiles.includes(file.relative));\n  }\n\n  /**\n   * compute the description of the component from its source code and docs file.\n   */\n  async getDescription(component: Component): Promise<string> {\n    const componentDoc = this.getDoc(component);\n    const desc = componentDoc?.description;\n    if (desc) return desc;\n    const consumerComponent: ConsumerComponent = component.state._consumer;\n    const fromJsDocs = consumerComponent.docs?.find((doc) => doc.description);\n\n    return fromJsDocs?.description || '';\n  }\n\n  async getTemplate(env: Environment) {\n    return env.getDocsTemplate();\n  }\n\n  getDocReader(extension: string) {\n    return this.docReaderSlot.values().find((docReader) => docReader.isFormatSupported(extension));\n  }\n\n  /**\n   * compute a doc for a component.\n   */\n  async computeDoc(component: Component) {\n    const docFiles = this.getDocsFiles(component);\n    if (docFiles.length) {\n      // currently taking the the first docs file found with an abstract. (we support only one)\n      const docFile = docFiles[0];\n\n      try {\n        const docReader = this.getDocReader(docFile.extname);\n        if (!docReader) throw new FileExtensionNotSupported(docFile.relative, docFile.extname);\n        const doc = await docReader.read(docFile.relative, docFile.contents, component);\n        return doc;\n      } catch (err: any) {\n        // it's ok to fail here.\n        this.logger.debug(`docs.main.runtime.computeDoc caught an error: ${err.message}`);\n        return null;\n      }\n    }\n\n    return null;\n  }\n\n  getDoc(component: IComponent) {\n    const docData = component.get(DocsAspect.id)?.data?.doc;\n    if (!docData) return null;\n    return new Doc(docData.filePath, new DocPropList(docData.props));\n  }\n\n  getPatterns() {\n    return this.patterns;\n  }\n\n  getComponentDevPatterns(component: Component) {\n    const env = this.envs.calculateEnv(component).env;\n    const componentEnvDocsDevPatterns: string[] = env.getDocsDevPatterns ? env.getDocsDevPatterns(component) : [];\n    const componentPatterns = componentEnvDocsDevPatterns.concat(this.getPatterns());\n    return componentPatterns;\n  }\n\n  getDevPatternToRegister() {\n    return this.getComponentDevPatterns.bind(this);\n  }\n  /**\n   * register a new doc reader. this allows to support further\n   * documentation file formats.\n   */\n  registerDocReader(docReader: DocReader) {\n    this.docReaderSlot.register(docReader);\n    return this;\n  }\n\n  static slots = [Slot.withType<DocProp>(), Slot.withType<DocReader>()];\n\n  static runtime = MainRuntime;\n  static dependencies = [\n    PreviewAspect,\n    GraphqlAspect,\n    WorkspaceAspect,\n    PkgAspect,\n    CompilerAspect,\n    LoggerAspect,\n    DevFilesAspect,\n    EnvsAspect,\n  ];\n\n  static defaultConfig = {\n    patterns: ['**/*.docs.*'],\n  };\n\n  static async provider(\n    [preview, graphql, workspace, pkg, compiler, loggerAspect, devFiles, envs]: [\n      PreviewMain,\n      GraphqlMain,\n      Workspace,\n      PkgMain,\n      CompilerMain,\n      LoggerMain,\n      DevFilesMain,\n      EnvsMain\n    ],\n    config: DocsConfig,\n    [docPropSlot, docReaderSlot]: [DocPropSlot, DocReaderSlot]\n  ) {\n    const logger = loggerAspect.createLogger(DocsAspect.id);\n    const docs = new DocsMain(\n      config.patterns,\n\n      preview,\n\n      pkg,\n\n      compiler,\n\n      workspace,\n\n      logger,\n\n      devFiles,\n\n      envs,\n\n      docPropSlot,\n\n      docReaderSlot\n    );\n    docs.registerDocReader(new DefaultDocReader(pkg, compiler, workspace));\n    devFiles.registerDevPattern(docs.getDevPatternToRegister());\n\n    if (workspace) {\n      workspace.onComponentLoad(async (component, opts) => {\n        if (opts?.loadDocs === false) return undefined;\n        const doc = await docs.computeDoc(component);\n\n        return {\n          doc: doc?.toObject(),\n        };\n      });\n    }\n\n    graphql.register(docsSchema(docs));\n\n    preview.registerDefinition(new DocsPreviewDefinition(docs));\n    return docs;\n  }\n}\n\nDocsAspect.addRuntime(DocsMain);\n"],"mappings":"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"}