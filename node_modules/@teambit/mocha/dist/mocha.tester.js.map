{"version":3,"names":["MochaTester","constructor","id","logger","mochaConfig","babelConfig","MochaModule","test","context","specsPerComp","specFiles","toArray","allSpecsFiles","map","specFile","path","flat","babelRegister","only","filePath","includes","extensions","componentsResults","pMapSeries","component","files","testsFiles","file","runMochaOnOneFile","err","errMsg","message","error","consoleFailure","TestsFiles","relative","undefined","allComponentErrors","testFile","tests","failureErrOrStr","componentId","results","TestsResult","errors","compact","Tests","watch","_callback","onTestRunComplete","callback","mocha","addFile","testResults","Promise","resolve","runner","run","on","state","Error","title","push","TestResult","titlePath","duration","stats","testsFile","passes","failures","pending","version","Mocha","prototype"],"sources":["mocha.tester.ts"],"sourcesContent":["import { Logger } from '@teambit/logger';\nimport { ComponentsResults, Tester, CallbackFn, TesterContext, Tests } from '@teambit/tester';\nimport Mocha from 'mocha';\nimport babelRegister from '@babel/register';\nimport type { TransformOptions } from '@babel/core';\nimport { TestResult, TestsFiles, TestsResult } from '@teambit/tests-results';\nimport pMapSeries from 'p-map-series';\nimport { AbstractVinyl } from '@teambit/legacy/dist/consumer/component/sources';\nimport { compact } from 'lodash';\n\nexport class MochaTester implements Tester {\n  _callback: CallbackFn | undefined;\n  displayName = 'Mocha';\n  constructor(\n    readonly id: string,\n    private logger: Logger,\n    readonly mochaConfig: Mocha.MochaOptions,\n    /**\n     * babel config are needed when the spec files are not native javascript and need to be compiled.\n     * pass the same config you pass to your babel compiler if you're using one.\n     */\n    private babelConfig: TransformOptions,\n    private MochaModule: typeof Mocha\n  ) {}\n  async test(context: TesterContext): Promise<Tests> {\n    const specsPerComp = context.specFiles.toArray();\n    const allSpecsFiles = specsPerComp.map(([, specFiles]) => specFiles.map((specFile) => specFile.path)).flat();\n    babelRegister({\n      only: [(filePath: string) => allSpecsFiles.includes(filePath)],\n      extensions: ['.es6', '.es', '.jsx', '.js', '.mjs', '.ts', '.tsx'],\n      ...(this.babelConfig || {}),\n    });\n    const componentsResults: ComponentsResults[] = await pMapSeries(specsPerComp, async ([component, files]) => {\n      const testsFiles: TestsFiles[] = await pMapSeries(files, async (file) => {\n        try {\n          return await this.runMochaOnOneFile(file);\n        } catch (err: any) {\n          const errMsg = `Mocha found an error while working on \"${file.path}\". ${err.message}`;\n          this.logger.error(errMsg, err);\n          this.logger.consoleFailure(errMsg);\n          return new TestsFiles(file.relative, [], 0, 0, 0, undefined, undefined, err);\n        }\n      });\n      const allComponentErrors = testsFiles\n        .map((testFile) => testFile.error || testFile.tests.map((test) => test.failureErrOrStr as Error))\n        .flat();\n      return {\n        componentId: component.id,\n        results: new TestsResult(testsFiles),\n        errors: compact(allComponentErrors),\n      };\n    });\n    return new Tests(componentsResults);\n  }\n\n  /**\n   * @todo: make this work. currently, it doesn't update the UI upon changes.\n   */\n  async watch(context: TesterContext): Promise<Tests> {\n    const results = await this.test(context);\n    if (this._callback) {\n      this._callback(results);\n    }\n    return results;\n  }\n\n  async onTestRunComplete(callback: CallbackFn) {\n    this._callback = callback;\n  }\n\n  private async runMochaOnOneFile(file: AbstractVinyl): Promise<TestsFiles> {\n    const mocha = new this.MochaModule(this.mochaConfig);\n    mocha.addFile(file.path);\n    const testResults: TestResult[] = [];\n    return new Promise((resolve) => {\n      const runner = mocha\n        .run()\n        .on('test end', function (test) {\n          const state = test.state;\n          if (!state)\n            throw new Error(`the test.state of \"${test.title}\", file \"${file.path}\" is neither passed nor failed`);\n          testResults.push(new TestResult(test.titlePath(), test.title, state, test.duration, undefined, test.err));\n        })\n        .on('end', function () {\n          const stats = runner.stats;\n          if (!stats) throw new Error('stats is missing');\n          const testsFile = new TestsFiles(\n            file.relative,\n            testResults,\n            stats.passes,\n            stats.failures,\n            stats.pending,\n            stats.duration\n          );\n          resolve(testsFile);\n        });\n    });\n  }\n\n  version(): string {\n    // @ts-ignore\n    return Mocha.prototype.version || 'N/A';\n  }\n}\n"],"mappings":"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"}