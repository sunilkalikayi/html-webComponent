{"version":3,"names":["ENV_STRATEGY_ARTIFACT_NAME","EnvBundlingStrategy","constructor","preview","pkg","dependencyResolver","computeTargets","context","previewDefs","outputPath","getOutputPath","existsSync","mkdirpSync","htmlConfig","generateHtmlConfig","dev","peers","getPeerDependenciesListFromEnv","env","entries","computePaths","html","components","hostDependencies","aliasHostDependencies","options","config","title","templateContent","cache","minify","computeResults","results","result","componentsResults","map","component","errors","err","message","warning","warnings","startTime","endTime","artifacts","getArtifactDef","rootDir","getDirName","name","globPatterns","envName","id","replace","resolve","capsuleNetwork","capsulesRootDir","getPaths","files","capsule","compiler","getCompiler","file","join","path","getDistPathBySrcPath","relative","defs","previewMain","writePreviewRuntime","moduleMapsPromise","previewDef","moduleMap","getModuleMap","paths","ComponentMap","as","graphCapsules","getCapsule","maybeFiles","get","compiledPaths","template","renderTemplatePath","link","writeLink","prefix","undefined","flatten","toArray","concat","moduleMaps","Promise","all"],"sources":["env-strategy.ts"],"sourcesContent":["import { join, resolve } from 'path';\nimport { existsSync, mkdirpSync } from 'fs-extra';\nimport { flatten } from 'lodash';\nimport { ComponentMap } from '@teambit/component';\nimport { Compiler } from '@teambit/compiler';\nimport { AbstractVinyl } from '@teambit/legacy/dist/consumer/component/sources';\nimport { Capsule } from '@teambit/isolator';\nimport { ComponentResult } from '@teambit/builder';\nimport { BundlerContext, BundlerHtmlConfig, BundlerResult } from '@teambit/bundler';\nimport { DependencyResolverMain } from '@teambit/dependency-resolver';\nimport { PkgMain } from '@teambit/pkg';\nimport type { BundlingStrategy, ComputeTargetsContext } from '../bundling-strategy';\nimport { PreviewDefinition } from '../preview-definition';\nimport { PreviewMain } from '../preview.main.runtime';\nimport { html } from '../bundler/html-template';\n\nexport const ENV_STRATEGY_ARTIFACT_NAME = 'preview';\n\n/**\n * bundles all components in a given env into the same bundle.\n */\nexport class EnvBundlingStrategy implements BundlingStrategy {\n  name = 'env';\n\n  constructor(private preview: PreviewMain, private pkg: PkgMain, private dependencyResolver: DependencyResolverMain) {}\n\n  async computeTargets(context: ComputeTargetsContext, previewDefs: PreviewDefinition[]) {\n    const outputPath = this.getOutputPath(context);\n    if (!existsSync(outputPath)) mkdirpSync(outputPath);\n    const htmlConfig = this.generateHtmlConfig({ dev: context.dev });\n    const peers = await this.dependencyResolver.getPeerDependenciesListFromEnv(context.env);\n\n    return [\n      {\n        entries: await this.computePaths(outputPath, previewDefs, context),\n        html: [htmlConfig],\n        components: context.components,\n        outputPath,\n        /* It's a path to the root of the host component. */\n        // hostRootDir, handle this\n        hostDependencies: peers,\n        aliasHostDependencies: true,\n      },\n    ];\n  }\n\n  private generateHtmlConfig(options: { dev?: boolean }): BundlerHtmlConfig {\n    const config = {\n      title: 'Preview',\n      templateContent: html('Preview'),\n      cache: false,\n      minify: options?.dev ?? true,\n    };\n    return config;\n  }\n\n  async computeResults(context: BundlerContext, results: BundlerResult[]) {\n    const result = results[0];\n\n    const componentsResults: ComponentResult[] = result.components.map((component) => {\n      return {\n        component,\n        errors: result.errors.map((err) => (typeof err === 'string' ? err : err.message)),\n        warning: result.warnings,\n        startTime: result.startTime,\n        endTime: result.endTime,\n      };\n    });\n\n    const artifacts = this.getArtifactDef(context);\n\n    return {\n      componentsResults,\n      artifacts,\n    };\n  }\n\n  private getArtifactDef(context: ComputeTargetsContext) {\n    // eslint-disable-next-line @typescript-eslint/prefer-as-const\n    const env: 'env' = 'env';\n    const rootDir = this.getDirName(context);\n\n    return [\n      {\n        name: ENV_STRATEGY_ARTIFACT_NAME,\n        globPatterns: ['public/**'],\n        rootDir,\n        context: env,\n      },\n    ];\n  }\n\n  getDirName(context: ComputeTargetsContext) {\n    const envName = context.id.replace('/', '__');\n    return `${envName}-preview`;\n  }\n\n  private getOutputPath(context: ComputeTargetsContext) {\n    return resolve(`${context.capsuleNetwork.capsulesRootDir}/${this.getDirName(context)}`);\n  }\n\n  private getPaths(context: ComputeTargetsContext, files: AbstractVinyl[], capsule: Capsule) {\n    const compiler: Compiler = context.env.getCompiler();\n    return files.map((file) => join(capsule.path, compiler.getDistPathBySrcPath(file.relative)));\n  }\n\n  private async computePaths(\n    outputPath: string,\n    defs: PreviewDefinition[],\n    context: ComputeTargetsContext\n  ): Promise<string[]> {\n    const previewMain = await this.preview.writePreviewRuntime(context);\n    const moduleMapsPromise = defs.map(async (previewDef) => {\n      const moduleMap = await previewDef.getModuleMap(context.components);\n\n      const paths = ComponentMap.as(context.components, (component) => {\n        const capsule = context.capsuleNetwork.graphCapsules.getCapsule(component.id);\n        const maybeFiles = moduleMap.get(component);\n        if (!maybeFiles || !capsule) return [];\n        const [, files] = maybeFiles;\n        const compiledPaths = this.getPaths(context, files, capsule);\n        return compiledPaths;\n      });\n\n      const template = previewDef.renderTemplatePath ? await previewDef.renderTemplatePath(context) : 'undefined';\n\n      const link = this.preview.writeLink(\n        previewDef.prefix,\n        paths,\n        previewDef.renderTemplatePath ? await previewDef.renderTemplatePath(context) : undefined,\n        outputPath,\n        false\n      );\n\n      const files = flatten(paths.toArray().map(([, file]) => file)).concat([link]);\n\n      if (template) return files.concat([template]);\n      return files;\n    });\n\n    const moduleMaps = await Promise.all(moduleMapsPromise);\n\n    return flatten(moduleMaps.concat([previewMain]));\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;AAAA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAWA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAEO,MAAMA,0BAA0B,GAAG,SAAS;;AAEnD;AACA;AACA;AAFA;AAGO,MAAMC,mBAAmB,CAA6B;EAG3DC,WAAW,CAASC,OAAoB,EAAUC,GAAY,EAAUC,kBAA0C,EAAE;IAAA,KAAhGF,OAAoB,GAApBA,OAAoB;IAAA,KAAUC,GAAY,GAAZA,GAAY;IAAA,KAAUC,kBAA0C,GAA1CA,kBAA0C;IAAA,8CAF3G,KAAK;EAEyG;EAErH,MAAMC,cAAc,CAACC,OAA8B,EAAEC,WAAgC,EAAE;IACrF,MAAMC,UAAU,GAAG,IAAI,CAACC,aAAa,CAACH,OAAO,CAAC;IAC9C,IAAI,CAAC,IAAAI,qBAAU,EAACF,UAAU,CAAC,EAAE,IAAAG,qBAAU,EAACH,UAAU,CAAC;IACnD,MAAMI,UAAU,GAAG,IAAI,CAACC,kBAAkB,CAAC;MAAEC,GAAG,EAAER,OAAO,CAACQ;IAAI,CAAC,CAAC;IAChE,MAAMC,KAAK,GAAG,MAAM,IAAI,CAACX,kBAAkB,CAACY,8BAA8B,CAACV,OAAO,CAACW,GAAG,CAAC;IAEvF,OAAO,CACL;MACEC,OAAO,EAAE,MAAM,IAAI,CAACC,YAAY,CAACX,UAAU,EAAED,WAAW,EAAED,OAAO,CAAC;MAClEc,IAAI,EAAE,CAACR,UAAU,CAAC;MAClBS,UAAU,EAAEf,OAAO,CAACe,UAAU;MAC9Bb,UAAU;MACV;MACA;MACAc,gBAAgB,EAAEP,KAAK;MACvBQ,qBAAqB,EAAE;IACzB,CAAC,CACF;EACH;EAEQV,kBAAkB,CAACW,OAA0B,EAAqB;IAAA;IACxE,MAAMC,MAAM,GAAG;MACbC,KAAK,EAAE,SAAS;MAChBC,eAAe,EAAE,IAAAP,oBAAI,EAAC,SAAS,CAAC;MAChCQ,KAAK,EAAE,KAAK;MACZC,MAAM,kBAAEL,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEV,GAAG,uDAAI;IAC1B,CAAC;IACD,OAAOW,MAAM;EACf;EAEA,MAAMK,cAAc,CAACxB,OAAuB,EAAEyB,OAAwB,EAAE;IACtE,MAAMC,MAAM,GAAGD,OAAO,CAAC,CAAC,CAAC;IAEzB,MAAME,iBAAoC,GAAGD,MAAM,CAACX,UAAU,CAACa,GAAG,CAAEC,SAAS,IAAK;MAChF,OAAO;QACLA,SAAS;QACTC,MAAM,EAAEJ,MAAM,CAACI,MAAM,CAACF,GAAG,CAAEG,GAAG,IAAM,OAAOA,GAAG,KAAK,QAAQ,GAAGA,GAAG,GAAGA,GAAG,CAACC,OAAQ,CAAC;QACjFC,OAAO,EAAEP,MAAM,CAACQ,QAAQ;QACxBC,SAAS,EAAET,MAAM,CAACS,SAAS;QAC3BC,OAAO,EAAEV,MAAM,CAACU;MAClB,CAAC;IACH,CAAC,CAAC;IAEF,MAAMC,SAAS,GAAG,IAAI,CAACC,cAAc,CAACtC,OAAO,CAAC;IAE9C,OAAO;MACL2B,iBAAiB;MACjBU;IACF,CAAC;EACH;EAEQC,cAAc,CAACtC,OAA8B,EAAE;IACrD;IACA,MAAMW,GAAU,GAAG,KAAK;IACxB,MAAM4B,OAAO,GAAG,IAAI,CAACC,UAAU,CAACxC,OAAO,CAAC;IAExC,OAAO,CACL;MACEyC,IAAI,EAAEhD,0BAA0B;MAChCiD,YAAY,EAAE,CAAC,WAAW,CAAC;MAC3BH,OAAO;MACPvC,OAAO,EAAEW;IACX,CAAC,CACF;EACH;EAEA6B,UAAU,CAACxC,OAA8B,EAAE;IACzC,MAAM2C,OAAO,GAAG3C,OAAO,CAAC4C,EAAE,CAACC,OAAO,CAAC,GAAG,EAAE,IAAI,CAAC;IAC7C,OAAQ,GAAEF,OAAQ,UAAS;EAC7B;EAEQxC,aAAa,CAACH,OAA8B,EAAE;IACpD,OAAO,IAAA8C,eAAO,EAAE,GAAE9C,OAAO,CAAC+C,cAAc,CAACC,eAAgB,IAAG,IAAI,CAACR,UAAU,CAACxC,OAAO,CAAE,EAAC,CAAC;EACzF;EAEQiD,QAAQ,CAACjD,OAA8B,EAAEkD,KAAsB,EAAEC,OAAgB,EAAE;IACzF,MAAMC,QAAkB,GAAGpD,OAAO,CAACW,GAAG,CAAC0C,WAAW,EAAE;IACpD,OAAOH,KAAK,CAACtB,GAAG,CAAE0B,IAAI,IAAK,IAAAC,YAAI,EAACJ,OAAO,CAACK,IAAI,EAAEJ,QAAQ,CAACK,oBAAoB,CAACH,IAAI,CAACI,QAAQ,CAAC,CAAC,CAAC;EAC9F;EAEA,MAAc7C,YAAY,CACxBX,UAAkB,EAClByD,IAAyB,EACzB3D,OAA8B,EACX;IACnB,MAAM4D,WAAW,GAAG,MAAM,IAAI,CAAChE,OAAO,CAACiE,mBAAmB,CAAC7D,OAAO,CAAC;IACnE,MAAM8D,iBAAiB,GAAGH,IAAI,CAAC/B,GAAG,CAAC,MAAOmC,UAAU,IAAK;MACvD,MAAMC,SAAS,GAAG,MAAMD,UAAU,CAACE,YAAY,CAACjE,OAAO,CAACe,UAAU,CAAC;MAEnE,MAAMmD,KAAK,GAAGC,yBAAY,CAACC,EAAE,CAACpE,OAAO,CAACe,UAAU,EAAGc,SAAS,IAAK;QAC/D,MAAMsB,OAAO,GAAGnD,OAAO,CAAC+C,cAAc,CAACsB,aAAa,CAACC,UAAU,CAACzC,SAAS,CAACe,EAAE,CAAC;QAC7E,MAAM2B,UAAU,GAAGP,SAAS,CAACQ,GAAG,CAAC3C,SAAS,CAAC;QAC3C,IAAI,CAAC0C,UAAU,IAAI,CAACpB,OAAO,EAAE,OAAO,EAAE;QACtC,MAAM,GAAGD,KAAK,CAAC,GAAGqB,UAAU;QAC5B,MAAME,aAAa,GAAG,IAAI,CAACxB,QAAQ,CAACjD,OAAO,EAAEkD,KAAK,EAAEC,OAAO,CAAC;QAC5D,OAAOsB,aAAa;MACtB,CAAC,CAAC;MAEF,MAAMC,QAAQ,GAAGX,UAAU,CAACY,kBAAkB,GAAG,MAAMZ,UAAU,CAACY,kBAAkB,CAAC3E,OAAO,CAAC,GAAG,WAAW;MAE3G,MAAM4E,IAAI,GAAG,IAAI,CAAChF,OAAO,CAACiF,SAAS,CACjCd,UAAU,CAACe,MAAM,EACjBZ,KAAK,EACLH,UAAU,CAACY,kBAAkB,GAAG,MAAMZ,UAAU,CAACY,kBAAkB,CAAC3E,OAAO,CAAC,GAAG+E,SAAS,EACxF7E,UAAU,EACV,KAAK,CACN;MAED,MAAMgD,KAAK,GAAG,IAAA8B,iBAAO,EAACd,KAAK,CAACe,OAAO,EAAE,CAACrD,GAAG,CAAC,CAAC,GAAG0B,IAAI,CAAC,KAAKA,IAAI,CAAC,CAAC,CAAC4B,MAAM,CAAC,CAACN,IAAI,CAAC,CAAC;MAE7E,IAAIF,QAAQ,EAAE,OAAOxB,KAAK,CAACgC,MAAM,CAAC,CAACR,QAAQ,CAAC,CAAC;MAC7C,OAAOxB,KAAK;IACd,CAAC,CAAC;IAEF,MAAMiC,UAAU,GAAG,MAAMC,OAAO,CAACC,GAAG,CAACvB,iBAAiB,CAAC;IAEvD,OAAO,IAAAkB,iBAAO,EAACG,UAAU,CAACD,MAAM,CAAC,CAACtB,WAAW,CAAC,CAAC,CAAC;EAClD;AACF;AAAC"}