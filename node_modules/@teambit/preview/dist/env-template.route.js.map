{"version":3,"names":["CACHE_MAX_AGE","getCacheControl","_filePath","_contents","mimeType","undefined","EnvTemplateRoute","constructor","preview","logger","req","res","next","artifact","componentId","envId","params","getEnvTemplateByEnvId","e","error","status","send","noPreview","isLegacyPath","serverError","getArtifactFileMiddleware"],"sources":["env-template.route.ts"],"sourcesContent":["import type { NextFunction, Request, Response } from '@teambit/express';\nimport type { ComponentUrlParams, RegisteredComponentRoute } from '@teambit/component';\nimport { noPreview, serverError } from '@teambit/ui-foundation.ui.pages.static-error';\nimport type { Logger } from '@teambit/logger';\n\nimport type { PreviewMain } from './preview.main.runtime';\nimport type { PreviewArtifact } from './preview-artifact';\nimport { getArtifactFileMiddleware, GetCacheControlFunc } from './artifact-file-middleware';\n\ntype UrlParams = ComponentUrlParams & {\n  filePath?: string;\n};\n\n// Week for now\nconst CACHE_MAX_AGE = 60 * 60 * 24 * 7;\n\nconst getCacheControl: GetCacheControlFunc = (_filePath: string, _contents: string, mimeType?: string | null) => {\n  // Do not cache the html files\n  if (mimeType && mimeType === 'text/html') {\n    return undefined;\n  }\n  return `private, max-age=${CACHE_MAX_AGE}`;\n};\n\nexport class EnvTemplateRoute implements RegisteredComponentRoute {\n  constructor(\n    /**\n     * preview extension.\n     */\n    private preview: PreviewMain,\n    private logger: Logger\n  ) {}\n\n  route = `/env-template/:previewName/:filePath(*)`;\n  method = 'get';\n\n  // Since we might give it a core env id\n  // Then in the component route when we do host.get(id) it will fail, as we don't have the core envs in the scope/workspace\n  resolveComponent = false;\n\n  // @ts-ignore\n  middlewares = [\n    async (req: Request<UrlParams>, res: Response, next: NextFunction) => {\n      try {\n        // @ts-ignore TODO: @guy please fix.\n        // const component = req.component as Component | undefined;\n        // if (!component) return res.status(404).send(noPreview());\n\n        let artifact: PreviewArtifact | undefined;\n        // TODO - prevent error `getVinylsAndImportIfMissing is not a function` #4680\n        try {\n          const { componentId: envId } = req.params;\n          artifact = await this.preview.getEnvTemplateByEnvId(envId);\n        } catch (e: any) {\n          this.logger.error(`getEnvTemplateByEnvId has failed`, e);\n          return res.status(404).send(noPreview());\n        }\n\n        // @ts-ignore\n        req.artifact = artifact;\n        // @ts-ignore\n        req.isLegacyPath = false;\n\n        return next();\n      } catch (e: any) {\n        this.logger.error('failed getting preview', e);\n        return res.status(500).send(serverError());\n      }\n    },\n    getArtifactFileMiddleware(this.logger, getCacheControl),\n  ];\n}\n"],"mappings":";;;;;;;;;;;;;;;AAEA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAKA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAMA;AACA,MAAMA,aAAa,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,CAAC;AAEtC,MAAMC,eAAoC,GAAG,CAACC,SAAiB,EAAEC,SAAiB,EAAEC,QAAwB,KAAK;EAC/G;EACA,IAAIA,QAAQ,IAAIA,QAAQ,KAAK,WAAW,EAAE;IACxC,OAAOC,SAAS;EAClB;EACA,OAAQ,oBAAmBL,aAAc,EAAC;AAC5C,CAAC;AAEM,MAAMM,gBAAgB,CAAqC;EAChEC,WAAW;EACT;AACJ;AACA;EACYC,OAAoB,EACpBC,MAAc,EACtB;IAAA,KAFQD,OAAoB,GAApBA,OAAoB;IAAA,KACpBC,MAAc,GAAdA,MAAc;IAAA,+CAGf,yCAAwC;IAAA,gDACxC,KAAK;IAAA,0DAIK,KAAK;IAAA,qDAGV,CACZ,OAAOC,GAAuB,EAAEC,GAAa,EAAEC,IAAkB,KAAK;MACpE,IAAI;QACF;QACA;QACA;;QAEA,IAAIC,QAAqC;QACzC;QACA,IAAI;UACF,MAAM;YAAEC,WAAW,EAAEC;UAAM,CAAC,GAAGL,GAAG,CAACM,MAAM;UACzCH,QAAQ,GAAG,MAAM,IAAI,CAACL,OAAO,CAACS,qBAAqB,CAACF,KAAK,CAAC;QAC5D,CAAC,CAAC,OAAOG,CAAM,EAAE;UACf,IAAI,CAACT,MAAM,CAACU,KAAK,CAAE,kCAAiC,EAAED,CAAC,CAAC;UACxD,OAAOP,GAAG,CAACS,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC,IAAAC,gCAAS,GAAE,CAAC;QAC1C;;QAEA;QACAZ,GAAG,CAACG,QAAQ,GAAGA,QAAQ;QACvB;QACAH,GAAG,CAACa,YAAY,GAAG,KAAK;QAExB,OAAOX,IAAI,EAAE;MACf,CAAC,CAAC,OAAOM,CAAM,EAAE;QACf,IAAI,CAACT,MAAM,CAACU,KAAK,CAAC,wBAAwB,EAAED,CAAC,CAAC;QAC9C,OAAOP,GAAG,CAACS,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC,IAAAG,kCAAW,GAAE,CAAC;MAC5C;IACF,CAAC,EACD,IAAAC,mDAAyB,EAAC,IAAI,CAAChB,MAAM,EAAER,eAAe,CAAC,CACxD;EAvCE;AAwCL;AAAC"}