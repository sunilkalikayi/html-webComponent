{"version":3,"names":["PREVIEW_TASK_NAME","PreviewTask","constructor","bundler","preview","dependencyResolver","logger","execute","context","defs","getDefs","url","envRuntime","id","bundlingStrategy","getBundlingStrategy","env","envPreviewConfig","getEnvPreviewConfig","splitComponentBundle","computeTargetsContext","Object","assign","targets","computeTargets","bundlerContext","compress","name","entry","publicPath","getPreviewDirectory","rootPath","development","dev","metaData","initiator","envId","getBundler","bundlerResults","run","results","computeResults","getLinkFileDirectory","join","CAPSULE_ARTIFACTS_DIR","outputPath","resolve","getPathsFromMap","capsule","moduleMap","compiler","getCompiler","map","files","file","path","getDistPathBySrcPath","relative"],"sources":["preview.task.ts"],"sourcesContent":["import { resolve, join } from 'path';\nimport { ExecutionContext } from '@teambit/envs';\nimport { BuildContext, BuiltTaskResult, BuildTask, TaskLocation, CAPSULE_ARTIFACTS_DIR } from '@teambit/builder';\nimport { Bundler, BundlerContext, BundlerMain, Target } from '@teambit/bundler';\nimport { Compiler } from '@teambit/compiler';\nimport { ComponentMap } from '@teambit/component';\nimport { Capsule } from '@teambit/isolator';\nimport { AbstractVinyl } from '@teambit/legacy/dist/consumer/component/sources';\nimport { DependencyResolverMain } from '@teambit/dependency-resolver';\nimport { Logger } from '@teambit/logger';\nimport { PreviewMain } from './preview.main.runtime';\n\nexport const PREVIEW_TASK_NAME = 'GeneratePreview';\nexport class PreviewTask implements BuildTask {\n  constructor(\n    /**\n     * bundler extension.\n     */\n    private bundler: BundlerMain,\n\n    /**\n     * preview extension.\n     */\n    private preview: PreviewMain,\n\n    private dependencyResolver: DependencyResolverMain,\n    private logger: Logger\n  ) {}\n\n  aspectId = 'teambit.preview/preview';\n  name = PREVIEW_TASK_NAME;\n  location: TaskLocation = 'end';\n  // readonly dependencies = [CompilerAspect.id];\n\n  async execute(context: BuildContext): Promise<BuiltTaskResult> {\n    const defs = this.preview.getDefs();\n    const url = `/preview/${context.envRuntime.id}`;\n    const bundlingStrategy = this.preview.getBundlingStrategy(context.env);\n    const envPreviewConfig = this.preview.getEnvPreviewConfig(context.env);\n    const splitComponentBundle = envPreviewConfig.splitComponentBundle ?? false;\n    const computeTargetsContext = Object.assign(context, { splitComponentBundle });\n\n    const targets: Target[] = await bundlingStrategy.computeTargets(computeTargetsContext, defs, this);\n\n    const bundlerContext: BundlerContext = Object.assign(context, {\n      targets,\n      compress: bundlingStrategy.name !== 'env' && splitComponentBundle,\n      entry: [],\n      publicPath: this.getPreviewDirectory(context),\n      rootPath: url,\n      development: context.dev,\n      metaData: {\n        initiator: `${PREVIEW_TASK_NAME} task`,\n        envId: context.id,\n      },\n    });\n\n    const bundler: Bundler = await context.env.getBundler(bundlerContext);\n    const bundlerResults = await bundler.run();\n\n    const results = bundlingStrategy.computeResults(bundlerContext, bundlerResults, this);\n    return results;\n  }\n\n  getLinkFileDirectory() {\n    return join(CAPSULE_ARTIFACTS_DIR, 'preview-links');\n  }\n\n  getPreviewDirectory(context: ExecutionContext) {\n    const outputPath = resolve(`${context.id}/public`);\n    return outputPath;\n  }\n\n  getPathsFromMap(\n    capsule: Capsule,\n    moduleMap: ComponentMap<AbstractVinyl[]>,\n    context: BuildContext\n  ): ComponentMap<string[]> {\n    const compiler: Compiler = context.env.getCompiler(context);\n    return moduleMap.map((files) => {\n      return files.map((file) => join(capsule.path, compiler.getDistPathBySrcPath(file.relative)));\n    });\n  }\n}\n"],"mappings":"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"}