{"version":3,"names":["getArtifactFileMiddleware","logger","getCacheControlFunc","req","res","artifact","isLegacyPath","file","getEnvTemplateFile","params","previewName","filePath","getPreviewFile","status","send","noPreview","contents","str","cwd","path","contentType","mime","getType","set","cacheControl","e","error","serverError","prevName","finalFilePath","matchedFile","getFileEndsWith","parts","filter","x","join"],"sources":["artifact-file-middleware.ts"],"sourcesContent":["import mime from 'mime';\nimport type { Request, Response } from '@teambit/express';\nimport { noPreview, serverError } from '@teambit/ui-foundation.ui.pages.static-error';\nimport type { Logger } from '@teambit/logger';\nimport type { PreviewArtifact } from './preview-artifact';\n\nexport type PreviewUrlParams = {\n  /**\n   * preview name like overview or composition\n   */\n  previewName?: string;\n  /** `/preview/:filePath(*)` */\n  filePath?: string;\n};\n\nexport type GetCacheControlFunc = (filePath: string, contents: string, mimeType?: string | null) => string | undefined;\n\nexport function getArtifactFileMiddleware(logger: Logger, getCacheControlFunc?: GetCacheControlFunc) {\n  return async (req: Request<PreviewUrlParams>, res: Response) => {\n    try {\n      // @ts-ignore\n      const artifact: PreviewArtifact = req.artifact;\n      // @ts-ignore\n      const isLegacyPath = req.isLegacyPath;\n      let file;\n      if (!isLegacyPath) {\n        file = getEnvTemplateFile(artifact, req.params.previewName, req.params.filePath);\n      } else {\n        file = getPreviewFile(artifact, req.params.previewName, req.params.filePath);\n      }\n      if (!file) return res.status(404).send(noPreview());\n\n      const contents = file.contents;\n      const str = `${file.cwd}/${file.path}`;\n      const contentType = mime.getType(str);\n      if (contentType) res.set('Content-Type', contentType);\n      if (getCacheControlFunc) {\n        const cacheControl = getCacheControlFunc(str, contents, contentType);\n        if (cacheControl) {\n          res.set('Cache-control', cacheControl);\n        }\n      }\n      return res.send(contents);\n    } catch (e: any) {\n      logger.error('failed getting preview', e);\n      return res.status(500).send(serverError());\n    }\n  };\n}\n\nfunction getEnvTemplateFile(artifact: PreviewArtifact, previewName?: string, filePath?: string) {\n  const prevName = previewName || 'overview';\n  const finalFilePath = filePath || `${prevName}.html`;\n  const matchedFile = artifact?.getFileEndsWith(finalFilePath);\n  return matchedFile;\n}\n\nfunction getPreviewFile(artifact: PreviewArtifact, previewName?: string, filePath?: string) {\n  let finalFilePath = 'index.html';\n  if (previewName || filePath) {\n    const parts = [previewName, filePath].filter((x) => x);\n    finalFilePath = parts.join('/');\n  }\n  const matchedFile = artifact?.getFileEndsWith(finalFilePath);\n  return matchedFile;\n}\n"],"mappings":";;;;;;;;AAAA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAEA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAeO,SAASA,yBAAyB,CAACC,MAAc,EAAEC,mBAAyC,EAAE;EACnG,OAAO,OAAOC,GAA8B,EAAEC,GAAa,KAAK;IAC9D,IAAI;MACF;MACA,MAAMC,QAAyB,GAAGF,GAAG,CAACE,QAAQ;MAC9C;MACA,MAAMC,YAAY,GAAGH,GAAG,CAACG,YAAY;MACrC,IAAIC,IAAI;MACR,IAAI,CAACD,YAAY,EAAE;QACjBC,IAAI,GAAGC,kBAAkB,CAACH,QAAQ,EAAEF,GAAG,CAACM,MAAM,CAACC,WAAW,EAAEP,GAAG,CAACM,MAAM,CAACE,QAAQ,CAAC;MAClF,CAAC,MAAM;QACLJ,IAAI,GAAGK,cAAc,CAACP,QAAQ,EAAEF,GAAG,CAACM,MAAM,CAACC,WAAW,EAAEP,GAAG,CAACM,MAAM,CAACE,QAAQ,CAAC;MAC9E;MACA,IAAI,CAACJ,IAAI,EAAE,OAAOH,GAAG,CAACS,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC,IAAAC,gCAAS,GAAE,CAAC;MAEnD,MAAMC,QAAQ,GAAGT,IAAI,CAACS,QAAQ;MAC9B,MAAMC,GAAG,GAAI,GAAEV,IAAI,CAACW,GAAI,IAAGX,IAAI,CAACY,IAAK,EAAC;MACtC,MAAMC,WAAW,GAAGC,eAAI,CAACC,OAAO,CAACL,GAAG,CAAC;MACrC,IAAIG,WAAW,EAAEhB,GAAG,CAACmB,GAAG,CAAC,cAAc,EAAEH,WAAW,CAAC;MACrD,IAAIlB,mBAAmB,EAAE;QACvB,MAAMsB,YAAY,GAAGtB,mBAAmB,CAACe,GAAG,EAAED,QAAQ,EAAEI,WAAW,CAAC;QACpE,IAAII,YAAY,EAAE;UAChBpB,GAAG,CAACmB,GAAG,CAAC,eAAe,EAAEC,YAAY,CAAC;QACxC;MACF;MACA,OAAOpB,GAAG,CAACU,IAAI,CAACE,QAAQ,CAAC;IAC3B,CAAC,CAAC,OAAOS,CAAM,EAAE;MACfxB,MAAM,CAACyB,KAAK,CAAC,wBAAwB,EAAED,CAAC,CAAC;MACzC,OAAOrB,GAAG,CAACS,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC,IAAAa,kCAAW,GAAE,CAAC;IAC5C;EACF,CAAC;AACH;AAEA,SAASnB,kBAAkB,CAACH,QAAyB,EAAEK,WAAoB,EAAEC,QAAiB,EAAE;EAC9F,MAAMiB,QAAQ,GAAGlB,WAAW,IAAI,UAAU;EAC1C,MAAMmB,aAAa,GAAGlB,QAAQ,IAAK,GAAEiB,QAAS,OAAM;EACpD,MAAME,WAAW,GAAGzB,QAAQ,aAARA,QAAQ,uBAARA,QAAQ,CAAE0B,eAAe,CAACF,aAAa,CAAC;EAC5D,OAAOC,WAAW;AACpB;AAEA,SAASlB,cAAc,CAACP,QAAyB,EAAEK,WAAoB,EAAEC,QAAiB,EAAE;EAC1F,IAAIkB,aAAa,GAAG,YAAY;EAChC,IAAInB,WAAW,IAAIC,QAAQ,EAAE;IAC3B,MAAMqB,KAAK,GAAG,CAACtB,WAAW,EAAEC,QAAQ,CAAC,CAACsB,MAAM,CAAEC,CAAC,IAAKA,CAAC,CAAC;IACtDL,aAAa,GAAGG,KAAK,CAACG,IAAI,CAAC,GAAG,CAAC;EACjC;EACA,MAAML,WAAW,GAAGzB,QAAQ,aAARA,QAAQ,uBAARA,QAAQ,CAAE0B,eAAe,CAACF,aAAa,CAAC;EAC5D,OAAOC,WAAW;AACpB"}