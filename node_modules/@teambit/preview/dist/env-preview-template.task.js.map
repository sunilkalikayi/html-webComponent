{"version":3,"names":["GENERATE_ENV_TEMPLATE_TASK_NAME","EnvPreviewTemplateTask","constructor","preview","envs","aspectLoader","dependencyResolver","logger","execute","context","previewDefs","getDefs","htmlConfig","map","previewModule","generateHtmlConfig","dev","originalSeedersIds","capsuleNetwork","originalSeedersCapsules","c","component","id","toString","grouped","Promise","all","components","length","includes","undefined","envDef","getEnvFromComponent","env","bundlingStrategy","getBundlingStrategy","name","target","getEnvTargetFromComponent","shouldUseDefaultBundler","envToGetBundler","getEnvsEnvDefinition","groupEnvId","targets","push","isEmpty","componentsResults","runBundlerForGroups","groups","bundlerContext","Object","assign","entry","development","metaData","initiator","envId","bundlerResults","mapSeries","entries","targetsGroup","bundler","getTemplateBundler","bundlerResult","run","results","computeResults","flatten","isCoreEnv","envComponent","envPreviewConfig","getEnvPreviewConfig","peers","getPeerDependenciesListFromEnv","capsule","graphCapsules","getCapsule","Error","previewRoot","writePreviewRuntime","generateEntries","splitComponentBundle","workDir","path","outputPath","computeOutputPath","existsSync","mkdirpSync","resolvedEnvAspects","resolveAspects","MainRuntime","requestedOnly","resolvedEnv","hostRootDir","aspectPath","warn","html","chunking","splitChunks","hostDependencies","aliasHostDependencies","previewModules","getPreviewModules","previewEntries","rest","linkFile","writeLink","ComponentMap","create","peerLink","writePeerLink","generateTemplateEntries","previewRootPath","allResults","result","errors","err","message","warning","warnings","startTime","endTime","artifacts","getArtifactDef","modules","compact","def","renderTemplatePathByEnv","prefix","include","join","getArtifactDirectory","CAPSULE_ARTIFACTS_DIR","globPatterns","rootDir"],"sources":["env-preview-template.task.ts"],"sourcesContent":["import {\n  BuildContext,\n  BuiltTaskResult,\n  BuildTask,\n  TaskLocation,\n  ComponentResult,\n  CAPSULE_ARTIFACTS_DIR,\n} from '@teambit/builder';\nimport { MainRuntime } from '@teambit/cli';\nimport mapSeries from 'p-map-series';\nimport { Component, ComponentMap } from '@teambit/component';\nimport { AspectLoaderMain } from '@teambit/aspect-loader';\nimport { Bundler, BundlerContext, BundlerHtmlConfig, BundlerResult, Target } from '@teambit/bundler';\nimport type { EnvDefinition, Environment, EnvsMain } from '@teambit/envs';\nimport { join } from 'path';\nimport { compact, flatten, isEmpty } from 'lodash';\nimport { Logger } from '@teambit/logger';\nimport { DependencyResolverMain } from '@teambit/dependency-resolver';\nimport { existsSync, mkdirpSync } from 'fs-extra';\nimport type { PreviewMain } from './preview.main.runtime';\nimport { generateTemplateEntries } from './bundler/chunks';\nimport { generateHtmlConfig } from './bundler/html-plugin';\nimport { writePeerLink } from './bundler/create-peers-link';\n\nexport type ModuleExpose = {\n  name: string;\n  path: string;\n  include?: string[];\n};\n\ntype TargetsGroup = {\n  env: Environment;\n  envToGetBundler: Environment;\n  targets: Target[];\n};\ntype TargetsGroupMap = {\n  [envId: string]: TargetsGroup;\n};\n\nexport const GENERATE_ENV_TEMPLATE_TASK_NAME = 'GenerateEnvTemplate';\n\nexport class EnvPreviewTemplateTask implements BuildTask {\n  aspectId = 'teambit.preview/preview';\n  name = GENERATE_ENV_TEMPLATE_TASK_NAME;\n  location: TaskLocation = 'end';\n  // readonly dependencies = [CompilerAspect.id];\n\n  constructor(\n    private preview: PreviewMain,\n    private envs: EnvsMain,\n    private aspectLoader: AspectLoaderMain,\n    private dependencyResolver: DependencyResolverMain,\n    private logger: Logger\n  ) {}\n\n  async execute(context: BuildContext): Promise<BuiltTaskResult> {\n    const previewDefs = this.preview.getDefs();\n    const htmlConfig = previewDefs.map((previewModule) => generateHtmlConfig(previewModule, { dev: context.dev }));\n    const originalSeedersIds = context.capsuleNetwork.originalSeedersCapsules.map((c) => c.component.id.toString());\n    const grouped: TargetsGroupMap = {};\n    await Promise.all(\n      context.components.map(async (component) => {\n        // Do not run over other components in the graph. it make the process much longer with no need\n        if (originalSeedersIds && originalSeedersIds.length && !originalSeedersIds.includes(component.id.toString())) {\n          return undefined;\n        }\n        const envDef = this.envs.getEnvFromComponent(component);\n        if (!envDef) return undefined;\n        const env = envDef.env;\n        const bundlingStrategy = this.preview.getBundlingStrategy(envDef.env);\n        if (bundlingStrategy.name === 'env') {\n          return undefined;\n        }\n        const target = await this.getEnvTargetFromComponent(context, component, envDef, htmlConfig);\n        if (!target) return undefined;\n        const shouldUseDefaultBundler = this.shouldUseDefaultBundler(envDef);\n        let envToGetBundler = this.envs.getEnvsEnvDefinition().env;\n        let groupEnvId = 'default';\n        if (!shouldUseDefaultBundler) {\n          envToGetBundler = env;\n          groupEnvId = envDef.id;\n        }\n        if (!grouped[groupEnvId]) {\n          grouped[groupEnvId] = {\n            env,\n            envToGetBundler,\n            targets: [target],\n          };\n        } else {\n          grouped[groupEnvId].targets.push(target);\n        }\n        return undefined;\n      })\n    );\n    if (isEmpty(grouped)) {\n      return { componentsResults: [] };\n    }\n\n    return this.runBundlerForGroups(context, grouped);\n  }\n\n  private async runBundlerForGroups(context: BuildContext, groups: TargetsGroupMap): Promise<BuiltTaskResult> {\n    const bundlerContext: BundlerContext = Object.assign(context, {\n      targets: [],\n      entry: [],\n      development: context.dev,\n      metaData: {\n        initiator: `${GENERATE_ENV_TEMPLATE_TASK_NAME} task`,\n        envId: context.id,\n      },\n    });\n    const bundlerResults = await mapSeries(Object.entries(groups), async ([, targetsGroup]) => {\n      bundlerContext.targets = targetsGroup.targets;\n      const bundler: Bundler = await targetsGroup.envToGetBundler.getTemplateBundler(bundlerContext);\n      const bundlerResult = await bundler.run();\n      return bundlerResult;\n    });\n\n    const results = await this.computeResults(bundlerContext, flatten(bundlerResults));\n    return results;\n  }\n\n  private shouldUseDefaultBundler(envDef: EnvDefinition): boolean {\n    if (this.aspectLoader.isCoreEnv(envDef.id) && envDef.id !== 'teambit.react/react-native') return true;\n    const env = envDef.env;\n    if (env.getTemplateBundler && typeof env.getTemplateBundler === 'function') return false;\n    return true;\n  }\n\n  private async getEnvTargetFromComponent(\n    context: BuildContext,\n    envComponent: Component,\n    envDef: EnvDefinition,\n    htmlConfig: BundlerHtmlConfig[]\n  ): Promise<Target | undefined> {\n    const env = envDef.env;\n    const envPreviewConfig = this.preview.getEnvPreviewConfig(envDef.env);\n\n    const peers = await this.dependencyResolver.getPeerDependenciesListFromEnv(env);\n    // const module = await this.getPreviewModule(envComponent);\n    // const entries = Object.keys(module).map((key) => module.exposes[key]);\n    const capsule = context.capsuleNetwork.graphCapsules.getCapsule(envComponent.id);\n    if (!capsule) throw new Error('no capsule found');\n    // Passing here the env itself to make sure it's preview runtime will be part of the preview root file\n    // that's needed to make sure the providers register there are running correctly\n    const previewRoot = await this.preview.writePreviewRuntime(context, [envComponent.id.toString()]);\n    const entries = await this.generateEntries({\n      envDef,\n      splitComponentBundle: envPreviewConfig.splitComponentBundle ?? false,\n      workDir: capsule.path,\n      peers,\n      previewRoot,\n    });\n\n    const outputPath = this.computeOutputPath(context, envComponent);\n    if (!existsSync(outputPath)) mkdirpSync(outputPath);\n    const resolvedEnvAspects = await this.preview.resolveAspects(MainRuntime.name, [envComponent.id], undefined, {\n      requestedOnly: true,\n    });\n    const resolvedEnv = resolvedEnvAspects[0];\n    const hostRootDir = resolvedEnv?.aspectPath;\n\n    if (!hostRootDir) {\n      this.logger.warn(`env preview template task, hostRootDir is not defined, for env ${envComponent.id.toString()}`);\n    }\n\n    return {\n      peers,\n      html: htmlConfig,\n      entries,\n      chunking: { splitChunks: true },\n      components: [envComponent],\n      outputPath,\n      /* It's a path to the root of the host component. */\n      hostRootDir,\n      hostDependencies: peers,\n      aliasHostDependencies: true,\n    };\n  }\n\n  private async generateEntries({\n    previewRoot,\n    workDir,\n    peers,\n    envDef,\n    splitComponentBundle,\n  }: {\n    previewRoot: string;\n    workDir: string;\n    peers: string[];\n    envDef: EnvDefinition;\n    splitComponentBundle: boolean;\n  }) {\n    const previewModules = await this.getPreviewModules(envDef);\n    const previewEntries = previewModules.map(({ name, path, ...rest }) => {\n      const linkFile = this.preview.writeLink(name, ComponentMap.create([]), path, workDir, splitComponentBundle);\n\n      return { name, path, ...rest, entry: linkFile };\n    });\n    const peerLink = await writePeerLink(peers, workDir);\n\n    const entries = generateTemplateEntries({\n      peers: peerLink,\n      previewRootPath: previewRoot,\n      previewModules: previewEntries,\n    });\n    return entries;\n  }\n\n  async computeResults(context: BundlerContext, results: BundlerResult[]) {\n    const allResults = results.map((result) => {\n      const componentsResults: ComponentResult[] = result.components.map((component) => {\n        return {\n          component,\n          errors: result.errors.map((err) => (typeof err === 'string' ? err : err.message)),\n          warning: result.warnings,\n          startTime: result.startTime,\n          endTime: result.endTime,\n        };\n      });\n      return componentsResults;\n    });\n\n    const componentsResults = flatten(allResults);\n\n    const artifacts = getArtifactDef();\n\n    return {\n      componentsResults,\n      artifacts,\n    };\n  }\n\n  private async getPreviewModules(envDef: EnvDefinition): Promise<ModuleExpose[]> {\n    const previewDefs = this.preview.getDefs();\n\n    const modules = compact(\n      await Promise.all(\n        previewDefs.map(async (def) => {\n          if (!def.renderTemplatePathByEnv) return undefined;\n          return {\n            name: def.prefix,\n            path: await def.renderTemplatePathByEnv(envDef.env),\n            include: def.include,\n          };\n        })\n      )\n    );\n\n    return modules;\n  }\n\n  private computeOutputPath(context: BuildContext, component: Component) {\n    const capsule = context.capsuleNetwork.graphCapsules.getCapsule(component.id);\n    if (!capsule) throw new Error('no capsule found');\n    return join(capsule.path, getArtifactDirectory());\n  }\n}\n\nexport function getArtifactDirectory() {\n  return join(CAPSULE_ARTIFACTS_DIR, 'env-template');\n}\n\nexport function getArtifactDef() {\n  return [\n    {\n      name: 'env-template',\n      globPatterns: ['**'],\n      rootDir: getArtifactDirectory(),\n    },\n  ];\n}\n"],"mappings":"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"}