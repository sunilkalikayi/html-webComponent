{"version":3,"names":["NodeApp","constructor","name","entry","portRange","nodeEnv","logger","deploy","run","from","to","port","Port","getPort","child","execFile","toString","error","stdout","on","data","console","build","context","base","parse","distDir","getCompiler","mainFile","join","_context","Object","assign"],"sources":["node.application.ts"],"sourcesContent":["import { execFile } from 'child_process';\nimport { parse, join } from 'path';\nimport { Logger } from '@teambit/logger';\nimport { ReactEnv } from '@teambit/react';\nimport { Application, DeployFn, AppBuildContext } from '@teambit/application';\nimport { Port } from '@teambit/toolbox.network.get-port';\nimport { NodeEnv } from './node.env';\nimport { DeployContext } from './node-app-options';\n\nexport class NodeApp implements Application {\n  constructor(\n    readonly name: string,\n    readonly entry: string,\n    readonly portRange: number[],\n    readonly nodeEnv: NodeEnv & ReactEnv,\n    readonly logger: Logger,\n    readonly deploy?: DeployFn\n  ) {}\n\n  applicationType = 'node';\n\n  async run(): Promise<number | undefined> {\n    const logger = this.logger;\n    const [from, to] = this.portRange;\n    const port = await Port.getPort(from, to);\n    const child = execFile('node', [this.entry, port.toString()], (error) => {\n      if (error) {\n        // @todo: this is causing uncaughtException in the main process. a better way to handle this would be to use promise.\n        // however, since it expects to return a number, it would require a bigger refactor.\n        throw error;\n      }\n    });\n    child.stdout?.on('data', function (data) {\n      logger.console(data.toString());\n    });\n    return port;\n  }\n\n  async build(context: AppBuildContext): Promise<DeployContext> {\n    const { base } = parse(this.entry);\n    const { distDir } = this.nodeEnv.getCompiler();\n    const mainFile = join(distDir, base);\n    const _context = Object.assign(context, { mainFile });\n    return _context;\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;AAAA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAIA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAIO,MAAMA,OAAO,CAAwB;EAC1CC,WAAW,CACAC,IAAY,EACZC,KAAa,EACbC,SAAmB,EACnBC,OAA2B,EAC3BC,MAAc,EACdC,MAAiB,EAC1B;IAAA,KANSL,IAAY,GAAZA,IAAY;IAAA,KACZC,KAAa,GAAbA,KAAa;IAAA,KACbC,SAAmB,GAAnBA,SAAmB;IAAA,KACnBC,OAA2B,GAA3BA,OAA2B;IAAA,KAC3BC,MAAc,GAAdA,MAAc;IAAA,KACdC,MAAiB,GAAjBA,MAAiB;IAAA,yDAGV,MAAM;EAFrB;EAIH,MAAMC,GAAG,GAAgC;IAAA;IACvC,MAAMF,MAAM,GAAG,IAAI,CAACA,MAAM;IAC1B,MAAM,CAACG,IAAI,EAAEC,EAAE,CAAC,GAAG,IAAI,CAACN,SAAS;IACjC,MAAMO,IAAI,GAAG,MAAMC,sBAAI,CAACC,OAAO,CAACJ,IAAI,EAAEC,EAAE,CAAC;IACzC,MAAMI,KAAK,GAAG,IAAAC,yBAAQ,EAAC,MAAM,EAAE,CAAC,IAAI,CAACZ,KAAK,EAAEQ,IAAI,CAACK,QAAQ,EAAE,CAAC,EAAGC,KAAK,IAAK;MACvE,IAAIA,KAAK,EAAE;QACT;QACA;QACA,MAAMA,KAAK;MACb;IACF,CAAC,CAAC;IACF,iBAAAH,KAAK,CAACI,MAAM,kDAAZ,cAAcC,EAAE,CAAC,MAAM,EAAE,UAAUC,IAAI,EAAE;MACvCd,MAAM,CAACe,OAAO,CAACD,IAAI,CAACJ,QAAQ,EAAE,CAAC;IACjC,CAAC,CAAC;IACF,OAAOL,IAAI;EACb;EAEA,MAAMW,KAAK,CAACC,OAAwB,EAA0B;IAC5D,MAAM;MAAEC;IAAK,CAAC,GAAG,IAAAC,aAAK,EAAC,IAAI,CAACtB,KAAK,CAAC;IAClC,MAAM;MAAEuB;IAAQ,CAAC,GAAG,IAAI,CAACrB,OAAO,CAACsB,WAAW,EAAE;IAC9C,MAAMC,QAAQ,GAAG,IAAAC,YAAI,EAACH,OAAO,EAAEF,IAAI,CAAC;IACpC,MAAMM,QAAQ,GAAGC,MAAM,CAACC,MAAM,CAACT,OAAO,EAAE;MAAEK;IAAS,CAAC,CAAC;IACrD,OAAOE,QAAQ;EACjB;AACF;AAAC"}