{"version":3,"names":["NodeMain","constructor","react","tsAspect","nodeEnv","envs","overrideTsConfig","bind","overrideJestConfig","overrideBuildPipe","overrideCompiler","overrideCompilerTasks","overrideBuildTsConfig","overridePackageJsonProps","overridePreviewConfig","overrideDevServerConfig","useWebpack","usePrettier","useEslint","overrideMounter","icon","useTypescript","modifiers","tsModule","overrides","devTransformers","devConfig","getCompiler","buildTransformers","buildConfig","buildPipeModifiers","tsModifier","transformers","module","getBuildPipe","override","overrideDependencies","dependencyPolicy","getDependencies","mergeDeepLeft","compose","targetEnv","merge","provider","loggerAspect","application","generator","logger","createLogger","NodeAspect","id","NodeEnv","reactEnv","registerEnv","nodeAppType","NodeAppType","registerAppType","registerComponentTemplate","nodeEnvTemplate","nodeTemplate","expressAppTemplate","expressRouteTemplate","MainRuntime","LoggerAspect","EnvsAspect","ApplicationAspect","ReactAspect","GeneratorAspect","TypescriptAspect","addRuntime"],"sources":["node.main.runtime.ts"],"sourcesContent":["import mergeDeepLeft from 'ramda/src/mergeDeepLeft';\nimport { EnvPolicyConfigObject } from '@teambit/dependency-resolver';\nimport { TsConfigSourceFile } from 'typescript';\nimport { TsCompilerOptionsWithoutTsConfig, TypescriptAspect, TypescriptMain } from '@teambit/typescript';\nimport { ApplicationAspect, ApplicationMain } from '@teambit/application';\nimport { LoggerAspect, LoggerMain } from '@teambit/logger';\nimport { MainRuntime } from '@teambit/cli';\nimport { GeneratorAspect, GeneratorMain } from '@teambit/generator';\nimport { BuildTask } from '@teambit/builder';\nimport { Compiler } from '@teambit/compiler';\nimport { PackageJsonProps } from '@teambit/pkg';\nimport { EnvsAspect, EnvsMain, EnvTransformer, Environment } from '@teambit/envs';\nimport { ReactAspect, ReactEnv, ReactMain, UseTypescriptModifiers } from '@teambit/react';\nimport { NodeAspect } from './node.aspect';\nimport { NodeEnv } from './node.env';\nimport { nodeEnvTemplate } from './templates/node-env';\nimport { nodeTemplate } from './templates/node';\nimport { NodeAppType } from './node.app-type';\nimport { expressAppTemplate } from './templates/express-app';\nimport { expressRouteTemplate } from './templates/express-route';\n\nexport class NodeMain {\n  constructor(\n    private react: ReactMain,\n\n    private tsAspect: TypescriptMain,\n\n    readonly nodeEnv: NodeEnv,\n\n    private envs: EnvsMain\n  ) {}\n\n  icon() {\n    return 'https://static.bit.dev/extensions-icons/nodejs.svg';\n  }\n\n  /**\n   * @deprecated use useTypescript()\n   * override the TS config of the environment.\n   */\n  overrideTsConfig: (\n    tsconfig: TsConfigSourceFile,\n    compilerOptions?: Partial<TsCompilerOptionsWithoutTsConfig>,\n    tsModule?: any\n  ) => EnvTransformer = this.react.overrideTsConfig.bind(this.react);\n\n  /**\n   * override the jest config of the environment.\n   */\n  overrideJestConfig = this.react.overrideJestConfig.bind(this.react);\n\n  /**\n   * override the env build pipeline.\n   */\n  overrideBuildPipe: (tasks: BuildTask[]) => EnvTransformer = this.react.overrideBuildPipe.bind(this.react);\n\n  /**\n   * override the env compilers list.\n   */\n  overrideCompiler: (compiler: Compiler) => EnvTransformer = this.react.overrideCompiler.bind(this.react);\n\n  /**\n   * override the env compilers tasks in the build pipe.\n   */\n  overrideCompilerTasks: (tasks: BuildTask[]) => EnvTransformer = this.react.overrideCompilerTasks.bind(this.react);\n\n  /**\n   * @deprecated use useTypescript()\n   * override the build ts config.\n   */\n  overrideBuildTsConfig: (\n    tsconfig: any,\n    compilerOptions?: Partial<TsCompilerOptionsWithoutTsConfig>\n  ) => EnvTransformer = this.react.overrideBuildTsConfig.bind(this.react);\n\n  /**\n   * override package json properties.\n   */\n  overridePackageJsonProps: (props: PackageJsonProps) => EnvTransformer = this.react.overridePackageJsonProps.bind(\n    this.react\n  );\n\n  /**\n   * @deprecated - use useWebpack\n   * override the preview config in the env.\n   */\n  overridePreviewConfig = this.react.overridePreviewConfig.bind(this.react);\n\n  /**\n   * @deprecated - use useWebpack\n   * override the dev server configuration.\n   */\n  overrideDevServerConfig = this.react.overrideDevServerConfig.bind(this.react);\n\n  /**\n   * override the env's typescript config for both dev and build time.\n   * Replaces both overrideTsConfig (devConfig) and overrideBuildTsConfig (buildConfig)\n   */\n  useTypescript(modifiers?: UseTypescriptModifiers, tsModule?: any) {\n    const overrides: any = {};\n    const devTransformers = modifiers?.devConfig;\n    if (devTransformers) {\n      overrides.getCompiler = () => this.nodeEnv.getCompiler(devTransformers, tsModule);\n    }\n    const buildTransformers = modifiers?.buildConfig;\n    if (buildTransformers) {\n      const buildPipeModifiers = {\n        tsModifier: {\n          transformers: buildTransformers,\n          module: tsModule,\n        },\n      };\n      overrides.getBuildPipe = () => this.nodeEnv.getBuildPipe(buildPipeModifiers);\n    }\n    return this.envs.override(overrides);\n  }\n\n  /**\n   * override the env's dev server and preview webpack configurations.\n   * Replaces both overrideDevServerConfig and overridePreviewConfig\n   */\n  useWebpack = this.react.useWebpack.bind(this.react);\n\n  /**\n   * An API to mutate the prettier config\n   */\n  usePrettier = this.react.usePrettier.bind(this.react);\n\n  /**\n   * An API to mutate the eslint config\n   */\n  useEslint = this.react.useEslint.bind(this.react);\n\n  /**\n   * override the dependency configuration of the component environment.\n   */\n  overrideDependencies(dependencyPolicy: EnvPolicyConfigObject) {\n    return this.envs.override({\n      getDependencies: () => mergeDeepLeft(dependencyPolicy, this.nodeEnv.getDependencies()),\n    });\n  }\n\n  overrideMounter = this.react.overrideMounter.bind(this.react);\n\n  /**\n   * create a new composition of the node environment.\n   */\n  compose(transformers: EnvTransformer[], targetEnv: Environment = {}) {\n    return this.envs.compose(this.envs.merge(targetEnv, this.nodeEnv), transformers);\n  }\n\n  static runtime = MainRuntime;\n  static dependencies = [LoggerAspect, EnvsAspect, ApplicationAspect, ReactAspect, GeneratorAspect, TypescriptAspect];\n\n  static async provider([loggerAspect, envs, application, react, generator, tsAspect]: [\n    LoggerMain,\n    EnvsMain,\n    ApplicationMain,\n    ReactMain,\n    GeneratorMain,\n    TypescriptMain\n  ]) {\n    const logger = loggerAspect.createLogger(NodeAspect.id);\n    const nodeEnv = envs.merge<NodeEnv, ReactEnv>(new NodeEnv(tsAspect, react), react.reactEnv);\n    envs.registerEnv(nodeEnv);\n    const nodeAppType = new NodeAppType('node-app', nodeEnv, logger);\n    application.registerAppType(nodeAppType);\n    generator.registerComponentTemplate([nodeEnvTemplate, nodeTemplate, expressAppTemplate, expressRouteTemplate]);\n    return new NodeMain(react, tsAspect, nodeEnv, envs);\n  }\n}\n\nNodeAspect.addRuntime(NodeMain);\n"],"mappings":";;;;;;;;;;;;;;;;AAAA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAGA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAIA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAEO,MAAMA,QAAQ,CAAC;EACpBC,WAAW,CACDC,KAAgB,EAEhBC,QAAwB,EAEvBC,OAAgB,EAEjBC,IAAc,EACtB;IAAA,KAPQH,KAAgB,GAAhBA,KAAgB;IAAA,KAEhBC,QAAwB,GAAxBA,QAAwB;IAAA,KAEvBC,OAAgB,GAAhBA,OAAgB;IAAA,KAEjBC,IAAc,GAAdA,IAAc;IAAA,0DAeF,IAAI,CAACH,KAAK,CAACI,gBAAgB,CAACC,IAAI,CAAC,IAAI,CAACL,KAAK,CAAC;IAAA,4DAK7C,IAAI,CAACA,KAAK,CAACM,kBAAkB,CAACD,IAAI,CAAC,IAAI,CAACL,KAAK,CAAC;IAAA,2DAKP,IAAI,CAACA,KAAK,CAACO,iBAAiB,CAACF,IAAI,CAAC,IAAI,CAACL,KAAK,CAAC;IAAA,0DAK9C,IAAI,CAACA,KAAK,CAACQ,gBAAgB,CAACH,IAAI,CAAC,IAAI,CAACL,KAAK,CAAC;IAAA,+DAKvC,IAAI,CAACA,KAAK,CAACS,qBAAqB,CAACJ,IAAI,CAAC,IAAI,CAACL,KAAK,CAAC;IAAA,+DAS3F,IAAI,CAACA,KAAK,CAACU,qBAAqB,CAACL,IAAI,CAAC,IAAI,CAACL,KAAK,CAAC;IAAA,kEAKC,IAAI,CAACA,KAAK,CAACW,wBAAwB,CAACN,IAAI,CAC9G,IAAI,CAACL,KAAK,CACX;IAAA,+DAMuB,IAAI,CAACA,KAAK,CAACY,qBAAqB,CAACP,IAAI,CAAC,IAAI,CAACL,KAAK,CAAC;IAAA,iEAM/C,IAAI,CAACA,KAAK,CAACa,uBAAuB,CAACR,IAAI,CAAC,IAAI,CAACL,KAAK,CAAC;IAAA,oDA6BhE,IAAI,CAACA,KAAK,CAACc,UAAU,CAACT,IAAI,CAAC,IAAI,CAACL,KAAK,CAAC;IAAA,qDAKrC,IAAI,CAACA,KAAK,CAACe,WAAW,CAACV,IAAI,CAAC,IAAI,CAACL,KAAK,CAAC;IAAA,mDAKzC,IAAI,CAACA,KAAK,CAACgB,SAAS,CAACX,IAAI,CAAC,IAAI,CAACL,KAAK,CAAC;IAAA,yDAW/B,IAAI,CAACA,KAAK,CAACiB,eAAe,CAACZ,IAAI,CAAC,IAAI,CAACL,KAAK,CAAC;EAhH1D;EAEHkB,IAAI,GAAG;IACL,OAAO,oDAAoD;EAC7D;;EAEA;AACF;AACA;AACA;;EAuDE;AACF;AACA;AACA;EACEC,aAAa,CAACC,SAAkC,EAAEC,QAAc,EAAE;IAChE,MAAMC,SAAc,GAAG,CAAC,CAAC;IACzB,MAAMC,eAAe,GAAGH,SAAS,aAATA,SAAS,uBAATA,SAAS,CAAEI,SAAS;IAC5C,IAAID,eAAe,EAAE;MACnBD,SAAS,CAACG,WAAW,GAAG,MAAM,IAAI,CAACvB,OAAO,CAACuB,WAAW,CAACF,eAAe,EAAEF,QAAQ,CAAC;IACnF;IACA,MAAMK,iBAAiB,GAAGN,SAAS,aAATA,SAAS,uBAATA,SAAS,CAAEO,WAAW;IAChD,IAAID,iBAAiB,EAAE;MACrB,MAAME,kBAAkB,GAAG;QACzBC,UAAU,EAAE;UACVC,YAAY,EAAEJ,iBAAiB;UAC/BK,MAAM,EAAEV;QACV;MACF,CAAC;MACDC,SAAS,CAACU,YAAY,GAAG,MAAM,IAAI,CAAC9B,OAAO,CAAC8B,YAAY,CAACJ,kBAAkB,CAAC;IAC9E;IACA,OAAO,IAAI,CAACzB,IAAI,CAAC8B,QAAQ,CAACX,SAAS,CAAC;EACtC;;EAEA;AACF;AACA;AACA;;EAaE;AACF;AACA;EACEY,oBAAoB,CAACC,gBAAuC,EAAE;IAC5D,OAAO,IAAI,CAAChC,IAAI,CAAC8B,QAAQ,CAAC;MACxBG,eAAe,EAAE,MAAM,IAAAC,wBAAa,EAACF,gBAAgB,EAAE,IAAI,CAACjC,OAAO,CAACkC,eAAe,EAAE;IACvF,CAAC,CAAC;EACJ;EAIA;AACF;AACA;EACEE,OAAO,CAACR,YAA8B,EAAES,SAAsB,GAAG,CAAC,CAAC,EAAE;IACnE,OAAO,IAAI,CAACpC,IAAI,CAACmC,OAAO,CAAC,IAAI,CAACnC,IAAI,CAACqC,KAAK,CAACD,SAAS,EAAE,IAAI,CAACrC,OAAO,CAAC,EAAE4B,YAAY,CAAC;EAClF;EAKA,aAAaW,QAAQ,CAAC,CAACC,YAAY,EAAEvC,IAAI,EAAEwC,WAAW,EAAE3C,KAAK,EAAE4C,SAAS,EAAE3C,QAAQ,CAOjF,EAAE;IACD,MAAM4C,MAAM,GAAGH,YAAY,CAACI,YAAY,CAACC,kBAAU,CAACC,EAAE,CAAC;IACvD,MAAM9C,OAAO,GAAGC,IAAI,CAACqC,KAAK,CAAoB,KAAIS,gBAAO,EAAChD,QAAQ,EAAED,KAAK,CAAC,EAAEA,KAAK,CAACkD,QAAQ,CAAC;IAC3F/C,IAAI,CAACgD,WAAW,CAACjD,OAAO,CAAC;IACzB,MAAMkD,WAAW,GAAG,KAAIC,oBAAW,EAAC,UAAU,EAAEnD,OAAO,EAAE2C,MAAM,CAAC;IAChEF,WAAW,CAACW,eAAe,CAACF,WAAW,CAAC;IACxCR,SAAS,CAACW,yBAAyB,CAAC,CAACC,0BAAe,EAAEC,qBAAY,EAAEC,gCAAkB,EAAEC,oCAAoB,CAAC,CAAC;IAC9G,OAAO,IAAI7D,QAAQ,CAACE,KAAK,EAAEC,QAAQ,EAAEC,OAAO,EAAEC,IAAI,CAAC;EACrD;AACF;AAAC;AAAA,gCArJYL,QAAQ,aAkIF8D,kBAAW;AAAA,gCAlIjB9D,QAAQ,kBAmIG,CAAC+D,sBAAY,EAAEC,kBAAU,EAAEC,gCAAiB,EAAEC,oBAAW,EAAEC,4BAAe,EAAEC,8BAAgB,CAAC;AAoBrHnB,kBAAU,CAACoB,UAAU,CAACrE,QAAQ,CAAC"}