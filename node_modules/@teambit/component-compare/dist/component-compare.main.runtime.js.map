{"version":3,"names":["ComponentCompareMain","constructor","componentAspect","scope","compare","baseIdStr","compareIdStr","host","getHost","baseCompId","compareCompId","resolveMultipleComponentIds","modelComponent","legacyScope","getModelComponentIfExist","_legacy","GeneralError","toString","baseVersion","version","compareVersion","repository","objects","baseVersionObject","loadVersion","compareVersionObject","diff","diffBetweenVersionsObjects","compareResult","id","code","filesDiff","provider","graphql","component","componentCompareMain","register","componentCompareSchema","GraphqlAspect","ComponentAspect","ScopeAspect","MainRuntime","ComponentCompareAspect","addRuntime"],"sources":["component-compare.main.runtime.ts"],"sourcesContent":["import { MainRuntime } from '@teambit/cli';\nimport { ScopeMain, ScopeAspect } from '@teambit/scope';\nimport { GraphqlAspect, GraphqlMain } from '@teambit/graphql';\nimport GeneralError from '@teambit/legacy/dist/error/general-error';\nimport {\n  diffBetweenVersionsObjects,\n  DiffResults,\n  FileDiff,\n} from '@teambit/legacy/dist/consumer/component-ops/components-diff';\nimport ComponentAspect, { ComponentMain } from '@teambit/component';\nimport { componentCompareSchema } from './component-compare.graphql';\nimport { ComponentCompareAspect } from './component-compare.aspect';\n\nexport type ComponentCompareResult = {\n  id: string;\n  code: FileDiff[];\n};\n\nexport class ComponentCompareMain {\n  constructor(private componentAspect: ComponentMain, private scope: ScopeMain) {}\n\n  async compare(baseIdStr: string, compareIdStr: string): Promise<ComponentCompareResult> {\n    const host = this.componentAspect.getHost();\n    const [baseCompId, compareCompId] = await host.resolveMultipleComponentIds([baseIdStr, compareIdStr]);\n    const modelComponent = await this.scope.legacyScope.getModelComponentIfExist(compareCompId._legacy);\n    if (!modelComponent) {\n      throw new GeneralError(`component ${compareCompId.toString()} doesn't have any version yet`);\n    }\n\n    const baseVersion = baseCompId.version as string;\n    const compareVersion = compareCompId.version as string;\n\n    const repository = this.scope.legacyScope.objects;\n    const baseVersionObject = await modelComponent.loadVersion(baseVersion, repository);\n    const compareVersionObject = await modelComponent.loadVersion(compareVersion, repository);\n    const diff: DiffResults = await diffBetweenVersionsObjects(\n      modelComponent,\n      baseVersionObject,\n      compareVersionObject,\n      baseVersion,\n      compareVersion,\n      this.scope.legacyScope,\n      {}\n    );\n\n    const compareResult = {\n      id: `${baseCompId}-${compareCompId}`,\n      code: diff.filesDiff || [],\n    };\n\n    return compareResult;\n  }\n\n  static slots = [];\n  static dependencies = [GraphqlAspect, ComponentAspect, ScopeAspect];\n  static runtime = MainRuntime;\n  static async provider([graphql, component, scope]: [GraphqlMain, ComponentMain, ScopeMain]) {\n    const componentCompareMain = new ComponentCompareMain(component, scope);\n    graphql.register(componentCompareSchema(componentCompareMain));\n    return componentCompareMain;\n  }\n}\n\nComponentCompareAspect.addRuntime(ComponentCompareMain);\n\nexport default ComponentCompareMain;\n"],"mappings":";;;;;;;;;;;;;;;;AAAA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAKA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAOO,MAAMA,oBAAoB,CAAC;EAChCC,WAAW,CAASC,eAA8B,EAAUC,KAAgB,EAAE;IAAA,KAA1DD,eAA8B,GAA9BA,eAA8B;IAAA,KAAUC,KAAgB,GAAhBA,KAAgB;EAAG;EAE/E,MAAMC,OAAO,CAACC,SAAiB,EAAEC,YAAoB,EAAmC;IACtF,MAAMC,IAAI,GAAG,IAAI,CAACL,eAAe,CAACM,OAAO,EAAE;IAC3C,MAAM,CAACC,UAAU,EAAEC,aAAa,CAAC,GAAG,MAAMH,IAAI,CAACI,2BAA2B,CAAC,CAACN,SAAS,EAAEC,YAAY,CAAC,CAAC;IACrG,MAAMM,cAAc,GAAG,MAAM,IAAI,CAACT,KAAK,CAACU,WAAW,CAACC,wBAAwB,CAACJ,aAAa,CAACK,OAAO,CAAC;IACnG,IAAI,CAACH,cAAc,EAAE;MACnB,MAAM,KAAII,uBAAY,EAAE,aAAYN,aAAa,CAACO,QAAQ,EAAG,+BAA8B,CAAC;IAC9F;IAEA,MAAMC,WAAW,GAAGT,UAAU,CAACU,OAAiB;IAChD,MAAMC,cAAc,GAAGV,aAAa,CAACS,OAAiB;IAEtD,MAAME,UAAU,GAAG,IAAI,CAAClB,KAAK,CAACU,WAAW,CAACS,OAAO;IACjD,MAAMC,iBAAiB,GAAG,MAAMX,cAAc,CAACY,WAAW,CAACN,WAAW,EAAEG,UAAU,CAAC;IACnF,MAAMI,oBAAoB,GAAG,MAAMb,cAAc,CAACY,WAAW,CAACJ,cAAc,EAAEC,UAAU,CAAC;IACzF,MAAMK,IAAiB,GAAG,MAAM,IAAAC,4CAA0B,EACxDf,cAAc,EACdW,iBAAiB,EACjBE,oBAAoB,EACpBP,WAAW,EACXE,cAAc,EACd,IAAI,CAACjB,KAAK,CAACU,WAAW,EACtB,CAAC,CAAC,CACH;IAED,MAAMe,aAAa,GAAG;MACpBC,EAAE,EAAG,GAAEpB,UAAW,IAAGC,aAAc,EAAC;MACpCoB,IAAI,EAAEJ,IAAI,CAACK,SAAS,IAAI;IAC1B,CAAC;IAED,OAAOH,aAAa;EACtB;EAKA,aAAaI,QAAQ,CAAC,CAACC,OAAO,EAAEC,SAAS,EAAE/B,KAAK,CAA0C,EAAE;IAC1F,MAAMgC,oBAAoB,GAAG,IAAInC,oBAAoB,CAACkC,SAAS,EAAE/B,KAAK,CAAC;IACvE8B,OAAO,CAACG,QAAQ,CAAC,IAAAC,0CAAsB,EAACF,oBAAoB,CAAC,CAAC;IAC9D,OAAOA,oBAAoB;EAC7B;AACF;AAAC;AAAA,gCA3CYnC,oBAAoB,WAmChB,EAAE;AAAA,gCAnCNA,oBAAoB,kBAoCT,CAACsC,wBAAa,EAAEC,oBAAe,EAAEC,oBAAW,CAAC;AAAA,gCApCxDxC,oBAAoB,aAqCdyC,kBAAW;AAQ9BC,2CAAsB,CAACC,UAAU,CAAC3C,oBAAoB,CAAC;AAAC,eAEzCA,oBAAoB;AAAA"}