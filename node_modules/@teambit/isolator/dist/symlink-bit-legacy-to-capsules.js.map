{"version":3,"names":["symlinkBitLegacyToCapsules","capsules","logger","debug","length","linksP","map","capsule","linkBitLegacyInCapsule","Promise","all","copyBitLegacyToCapsuleRoot","root","localBitLegacyPath","path","join","__dirname","targetPath","fs","copy","bitLegacyPath","wrkDir","getLocalBitLegacyPath","pathOutsideNodeModules","dirInIsolator","normalize","includes","replace","mkdirSync","e","remove","createSymlinkOrCopy"],"sources":["symlink-bit-legacy-to-capsules.ts"],"sourcesContent":["import { Logger } from '@teambit/logger';\nimport createSymlinkOrCopy from '@teambit/legacy/dist/utils/fs/create-symlink-or-copy';\nimport fs from 'fs-extra';\nimport path from 'path';\n\nimport { Capsule } from './capsule';\n\nexport async function symlinkBitLegacyToCapsules(capsules: Capsule[], logger: Logger) {\n  logger.debug(`symlink bit bin to capsules, ${capsules.length} capsules`);\n  const linksP = capsules.map(async (capsule) => linkBitLegacyInCapsule(capsule));\n  return Promise.all(linksP);\n}\n\nexport async function copyBitLegacyToCapsuleRoot(root: string, logger: Logger) {\n  logger.debug(`symlink @teambit/legacy package to capsule root`);\n  const localBitLegacyPath = path.join(__dirname, '@teambit/legacy/dist/..');\n  const targetPath = path.join(root, './node_modules/@teambit/legacy');\n  await fs.copy(localBitLegacyPath, targetPath);\n}\n\nasync function linkBitLegacyInCapsule(capsule: Capsule) {\n  const bitLegacyPath = path.join(capsule.wrkDir, './node_modules/@teambit/legacy');\n  const getLocalBitLegacyPath = () => {\n    const pathOutsideNodeModules = path.join(__dirname, '@teambit/legacy/dist/..');\n    const dirInIsolator = path.normalize('node_modules/@teambit/isolator/dist/@teambit/legacy');\n    if (pathOutsideNodeModules.includes(dirInIsolator)) {\n      return pathOutsideNodeModules.replace(dirInIsolator, '');\n    }\n    return pathOutsideNodeModules;\n    // if (pathOutsideNodeModules.endsWith(`${path.sep}dist`)) {\n    //   return pathOutsideNodeModules;\n    // }\n    // if (__dirname.includes('build-harmony')) {\n    //   // for @teambit/legacy development, the cli extension is installed as a package in build-harmony directory\n    //   return path.join(__dirname.split('build-harmony')[0], 'dist');\n    // }\n    // throw new Error('unable to link @teambit/legacy to the capsule, the location of @teambit/legacy is unknown');\n  };\n  const localBitLegacyPath = getLocalBitLegacyPath();\n  // if there are no deps, sometimes the node_modules folder is not created\n  // and we need it in order to perform the linking\n  try {\n    capsule.fs.mkdirSync('node_modules');\n  } catch (e: any) {\n    // fail silently - we only need to create it if it doesn't already exist\n  }\n\n  // we use fs directly here rather than the capsule.fs because there are some edge cases\n  // that the capsule fs does not deal with well (eg. identifying and deleting\n  // a symlink rather than the what the symlink links to)\n  await fs.remove(bitLegacyPath);\n  createSymlinkOrCopy(localBitLegacyPath, bitLegacyPath);\n}\n"],"mappings":";;;;;;;;;;;;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAIO,eAAeA,0BAA0B,CAACC,QAAmB,EAAEC,MAAc,EAAE;EACpFA,MAAM,CAACC,KAAK,CAAE,gCAA+BF,QAAQ,CAACG,MAAO,WAAU,CAAC;EACxE,MAAMC,MAAM,GAAGJ,QAAQ,CAACK,GAAG,CAAC,MAAOC,OAAO,IAAKC,sBAAsB,CAACD,OAAO,CAAC,CAAC;EAC/E,OAAOE,OAAO,CAACC,GAAG,CAACL,MAAM,CAAC;AAC5B;AAEO,eAAeM,0BAA0B,CAACC,IAAY,EAAEV,MAAc,EAAE;EAC7EA,MAAM,CAACC,KAAK,CAAE,iDAAgD,CAAC;EAC/D,MAAMU,kBAAkB,GAAGC,eAAI,CAACC,IAAI,CAACC,SAAS,EAAE,yBAAyB,CAAC;EAC1E,MAAMC,UAAU,GAAGH,eAAI,CAACC,IAAI,CAACH,IAAI,EAAE,gCAAgC,CAAC;EACpE,MAAMM,kBAAE,CAACC,IAAI,CAACN,kBAAkB,EAAEI,UAAU,CAAC;AAC/C;AAEA,eAAeT,sBAAsB,CAACD,OAAgB,EAAE;EACtD,MAAMa,aAAa,GAAGN,eAAI,CAACC,IAAI,CAACR,OAAO,CAACc,MAAM,EAAE,gCAAgC,CAAC;EACjF,MAAMC,qBAAqB,GAAG,MAAM;IAClC,MAAMC,sBAAsB,GAAGT,eAAI,CAACC,IAAI,CAACC,SAAS,EAAE,yBAAyB,CAAC;IAC9E,MAAMQ,aAAa,GAAGV,eAAI,CAACW,SAAS,CAAC,qDAAqD,CAAC;IAC3F,IAAIF,sBAAsB,CAACG,QAAQ,CAACF,aAAa,CAAC,EAAE;MAClD,OAAOD,sBAAsB,CAACI,OAAO,CAACH,aAAa,EAAE,EAAE,CAAC;IAC1D;IACA,OAAOD,sBAAsB;IAC7B;IACA;IACA;IACA;IACA;IACA;IACA;IACA;EACF,CAAC;;EACD,MAAMV,kBAAkB,GAAGS,qBAAqB,EAAE;EAClD;EACA;EACA,IAAI;IACFf,OAAO,CAACW,EAAE,CAACU,SAAS,CAAC,cAAc,CAAC;EACtC,CAAC,CAAC,OAAOC,CAAM,EAAE;IACf;EACF;;EAEA;EACA;EACA;EACA,MAAMX,kBAAE,CAACY,MAAM,CAACV,aAAa,CAAC;EAC9B,IAAAW,8BAAmB,EAAClB,kBAAkB,EAAEO,aAAa,CAAC;AACxD"}