{"version":3,"names":["Capsule","CapsuleTemplate","constructor","container","fs","console","Console","state","component","_wrkDir","wrkDir","path","realpathSync","start","execNode","executable","args","exec","typedExec","command","cwd","opts","ContainerExec","outputFile","file","data","options","removePath","dir","symlink","src","dest","execute","cmd","execResults","split","stdout","stderr","Promise","resolve","reject","on","error","getAllFilesPaths","files","glob","sync","join","nodir","map","getCapsuleDirName","config","name","filenamify","id","toString","replacement","getCapsuleRootDir","baseDir","createFromComponent","capsuleDirName","alwaysNew","v4","FsContainer","capsule","State"],"sources":["capsule.ts"],"sourcesContent":["import { NodeFS } from '@teambit/any-fs';\nimport { Capsule as CapsuleTemplate, Console, Exec, State } from '@teambit/capsule';\nimport { Component } from '@teambit/component';\nimport filenamify from 'filenamify';\nimport { realpathSync } from 'fs';\nimport glob from 'glob';\nimport path from 'path';\nimport { v4 } from 'uuid';\n\nimport FsContainer, { BitExecOption } from './container';\nimport ContainerExec from './container-exec';\n\nexport default class Capsule extends CapsuleTemplate<Exec, NodeFS> {\n  private _wrkDir: string;\n  constructor(\n    /**\n     * container implementation the capsule is being executed within.\n     */\n    protected container: FsContainer,\n    /**\n     * the capsule's file system.\n     */\n    readonly fs: NodeFS,\n    /**\n     * console for controlling process streams as stdout, stdin and stderr.\n     */\n    readonly console: Console = new Console(),\n    /**\n     * capsule's state.\n     */\n    readonly state: State,\n    readonly component: Component\n  ) {\n    super(container, fs, console, state);\n    this._wrkDir = container.wrkDir;\n  }\n\n  /**\n   * @deprecated please use `this.path`\n   */\n  get wrkDir(): string {\n    return this.path;\n  }\n\n  get path(): string {\n    return realpathSync(this._wrkDir);\n  }\n\n  start(): Promise<any> {\n    return this.container.start();\n  }\n\n  async execNode(executable: string, args: any, exec: ContainerExec) {\n    return this.typedExec(\n      {\n        command: ['node', executable, ...(args.args || [])],\n        cwd: '',\n      },\n      exec\n    );\n  }\n\n  async typedExec(opts: BitExecOption, exec = new ContainerExec()) {\n    return this.container.exec(opts, exec);\n  }\n\n  outputFile(file: string, data: any, options?: any): Promise<any> {\n    return this.container.outputFile(file, data, options);\n  }\n\n  removePath(dir: string): Promise<any> {\n    return this.container.removePath(dir);\n  }\n\n  symlink(src: string, dest: string): Promise<any> {\n    return this.container.symlink(src, dest);\n  }\n\n  // TODO: refactor this crap and simplify capsule API\n  async execute(cmd: string, options?: Record<string, any> | null | undefined) {\n    // @ts-ignore AUTO-ADDED-AFTER-MIGRATION-PLEASE-FIX!\n    const execResults = await this.exec({ command: cmd.split(' '), options });\n    let stdout = '';\n    let stderr = '';\n    return new Promise((resolve, reject) => {\n      execResults.stdout.on('data', (data: string) => {\n        stdout += data;\n      });\n      execResults.stdout.on('error', (error: string) => {\n        return reject(error);\n      });\n      // @ts-ignore\n      execResults.on('close', () => {\n        return resolve({ stdout, stderr });\n      });\n      execResults.stderr.on('error', (error: string) => {\n        return reject(error);\n      });\n      execResults.stderr.on('data', (data: string) => {\n        stderr += data;\n      });\n    });\n  }\n\n  /**\n   * @todo: fix.\n   * it skips the capsule fs because for some reason `capsule.fs.promises.readdir` doesn't work\n   * the same as `capsule.fs.readdir` and it doesn't have the capsule dir as pwd.\n   *\n   * returns the paths inside the capsule\n   */\n  getAllFilesPaths(dir = '.', options: { ignore?: string[] } = {}) {\n    const files = glob.sync('**', { cwd: path.join(this.path, dir), nodir: true, ...options });\n    return files.map((file) => path.join(dir, file));\n  }\n\n  static getCapsuleDirName(component: Component, config: { alwaysNew?: boolean; name?: string } = {}) {\n    return config.name || filenamify(component.id.toString(), { replacement: '_' });\n  }\n\n  static getCapsuleRootDir(component: Component, baseDir: string, config: { alwaysNew?: boolean; name?: string } = {}) {\n    return path.join(baseDir, Capsule.getCapsuleDirName(component, config));\n  }\n\n  static async createFromComponent(\n    component: Component,\n    baseDir: string,\n    config: { alwaysNew?: boolean } = {}\n  ): Promise<Capsule> {\n    // TODO: make this a static method and combine with ComponentCapsule\n    const capsuleDirName = Capsule.getCapsuleDirName(component, config);\n    const wrkDir = path.join(baseDir, config.alwaysNew ? `${capsuleDirName}_${v4()}` : capsuleDirName);\n    const container = new FsContainer(wrkDir);\n    const capsule = new Capsule(container, container.fs, new Console(), new State(), component);\n    await capsule.start();\n    return capsule;\n  }\n}\n"],"mappings":"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"}