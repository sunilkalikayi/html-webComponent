{"version":3,"names":["debug","require","FsContainer","constructor","wrkDir","NodeFS","getPath","composePath","pathToCompose","path","join","outputFile","file","data","options","filePath","fs","removePath","dir","pathToRemove","remove","symlink","src","dest","srcPath","destPath","ensureDir","dirname","ensureSymlink","exec","execOptions","ContainerExec","cwd","command","subprocessP","execa","shell","stdio","on","msg","emit","stderr","pipe","stdout","forEach","eventName","statusCode","setStatus","execP","hasError","Promise","resolve","reject","getContents","size","toString","terminal","process","env","SHELL","start","inspect","pause","resume","stop","ttl","destroy","log","Error","event","fn"],"sources":["container.ts"],"sourcesContent":["import { AnyFS, NodeFS } from '@teambit/any-fs';\nimport { Container, ContainerFactoryOptions, ContainerStatus, Exec, ExecOptions } from '@teambit/capsule';\nimport execa from 'execa';\nimport fs from 'fs-extra';\nimport * as path from 'path';\nimport { Stream } from 'stream';\n\nimport ContainerExec from './container-exec';\n\nconst debug = require('debug')('fs-container');\n\nexport interface BitExecOption extends ExecOptions {\n  cwd: string;\n  stdio?: 'pipe' | 'ipc' | 'ignore' | 'inherit' | Stream | number | undefined;\n}\nexport interface BitContainerConfig extends ContainerFactoryOptions {\n  other?: string;\n}\n\nexport default class FsContainer implements Container<Exec, AnyFS> {\n  id = 'FS Container';\n\n  fs: NodeFS = new NodeFS(this.wrkDir);\n\n  constructor(readonly wrkDir: string) {}\n\n  // TODO: do we need this?\n  public getPath() {\n    return this.wrkDir;\n  }\n\n  private composePath(pathToCompose) {\n    return path.join(this.getPath(), pathToCompose);\n  }\n\n  outputFile(file, data, options) {\n    const filePath = this.composePath(file);\n    debug(`writing file on ${filePath}`);\n    return fs.outputFile(filePath, data, options);\n  }\n\n  removePath(dir: string): Promise<any> {\n    const pathToRemove = this.composePath(dir);\n    return fs.remove(pathToRemove);\n  }\n\n  async symlink(src: string, dest: string): Promise<any> {\n    const srcPath = this.composePath(src);\n    const destPath = this.composePath(dest);\n    await fs.ensureDir(path.dirname(destPath));\n    return fs.ensureSymlink(srcPath, destPath);\n  }\n\n  async exec(execOptions: BitExecOption, exec = new ContainerExec()): Promise<ContainerExec> {\n    const cwd = execOptions.cwd ? this.composePath(execOptions.cwd) : this.getPath();\n    debug(`executing the following command: ${execOptions.command.join(' ')}, on cwd: ${cwd}`);\n    const subprocessP = execa.command(execOptions.command.join(' '), {\n      shell: true,\n      cwd,\n      stdio: ['ipc'],\n    });\n\n    // @TODO: FIX! This probably causes errors ad the promise is not handled properly!\n    // eslint-disable-next-line @typescript-eslint/no-floating-promises\n    subprocessP.on('message', function (msg: any) {\n      exec.emit('message', msg);\n    });\n    /* eslint-disable @typescript-eslint/no-non-null-assertion */\n    subprocessP.stderr?.pipe(exec.stderr);\n    subprocessP.stdout?.pipe(exec.stdout);\n    ['close', 'exit'].forEach(function (eventName: string) {\n      // @TODO: FIX! This probably causes errors ad the promise is not handled properly!\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\n      subprocessP.on(eventName, function (statusCode) {\n        exec.setStatus(statusCode);\n      });\n    });\n\n    return exec;\n  }\n\n  async execP(execOptions: BitExecOption): Promise<string> {\n    let hasError = false;\n    const exec = await this.exec(execOptions);\n    return new Promise((resolve, reject) => {\n      exec.stdout.on('error', () => {\n        hasError = true;\n      });\n      exec.on('close', () => {\n        if (hasError) reject(exec.stderr.getContents!(exec.stderr.size).toString());\n        resolve(exec.stdout.getContents!(exec.stdout.size).toString());\n      });\n    });\n  }\n\n  async terminal() {\n    const cwd = this.getPath();\n    return execa.command(process.env.SHELL || '/bin/zsh', { cwd, stdio: 'inherit' });\n  }\n\n  start(): Promise<void> {\n    return fs.ensureDir(this.wrkDir);\n  }\n  // @ts-ignore\n  async inspect(): Promise<ContainerStatus> {\n    // todo: probably not needed for this container\n  }\n  async pause(): Promise<void> {\n    // do nothing\n  }\n  async resume(): Promise<void> {\n    // do nothing\n  }\n  // eslint-disable-next-line\n  stop(ttl?: number | undefined): Promise<void> {\n    return fs.remove(this.wrkDir);\n  }\n  async destroy(): Promise<void> {\n    await this.stop();\n  }\n  log(): Promise<Exec> {\n    throw new Error('Method not implemented.');\n  }\n  on(event: string, fn: (data: any) => void): void {\n    return fn(event);\n    // throw new Error('Method not implemented.');\n  }\n}\n"],"mappings":"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"}