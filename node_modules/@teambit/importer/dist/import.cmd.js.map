{"version":3,"names":["ImportCmd","constructor","importer","docsDomain","name","description","extendedDescription","WILDCARD_HELP","report","ids","path","objects","displayDependencies","override","verbose","json","conf","skipNpmInstall","skipDependencyInstallation","merge","saveInLane","dependencies","dependents","allHistory","GeneralError","length","console","log","chalk","yellow","mergeStrategy","R","is","String","options","Object","keys","MergeOptions","includes","join","importOptions","Boolean","writeToPath","objectsOnly","writeConfig","installNpmPackages","importDependenciesDirectly","importDependents","importResults","import","_packageManagerArgs","importDetails","importedIds","importedDeps","JSON","stringify","cancellationMessage","titlePrefix","upToDateCount","importedComponents","map","bitId","details","find","c","id","toStringWithoutVersion","Error","toString","status","formatPlainComponentItemWithVersions","upToDateStr","title","componentDependenciesOutput","green","compact","importedDepsOutput","immutableUnshift","uniq","formatPlainComponentItem","dependenciesOutput","getVersionsOutput","versions","latestVersion","usedVersion","version","getConflictMessage","filesStatus","conflictedFiles","filter","file","FileStatus","manual","bold","conflictMessage","deprecated","removed","red","missingDeps","d","undefined","cyan"],"sources":["import.cmd.ts"],"sourcesContent":["import { Command, CommandOptions } from '@teambit/cli';\nimport chalk from 'chalk';\nimport { compact } from 'lodash';\nimport R from 'ramda';\nimport { WILDCARD_HELP } from '@teambit/legacy/dist/constants';\nimport {\n  FileStatus,\n  MergeOptions,\n  MergeStrategy,\n} from '@teambit/legacy/dist/consumer/versions-ops/merge-version/merge-version';\nimport { BitId } from '@teambit/legacy-bit-id';\nimport GeneralError from '@teambit/legacy/dist/error/general-error';\nimport { immutableUnshift } from '@teambit/legacy/dist/utils';\nimport { formatPlainComponentItem } from '@teambit/legacy/dist/cli/chalk-box';\nimport { ImporterMain } from './importer.main.runtime';\nimport { ImportOptions, ImportDetails, ImportStatus } from './import-components';\n\nexport class ImportCmd implements Command {\n  name = 'import [component-patterns...]';\n  description = 'import components from their remote scopes to the local workspace';\n  arguments = [\n    {\n      name: 'component-patterns...',\n      description:\n        'component IDs or component patterns (separated by space). Use patterns to import groups of components using a common scope or namespace. E.g., \"utils/*\" (wrap with double quotes)',\n    },\n  ];\n  extendedDescription: string;\n  group = 'collaborate';\n  alias = '';\n  options = [\n    ['p', 'path <path>', 'import components into a specific directory (a relative path in the workspace)'],\n    [\n      'o',\n      'objects',\n      'import components objects to the local scope without checkout (without writing them to the file system). This is a default behavior for import with no id argument',\n    ],\n    ['d', 'display-dependencies', 'display the imported dependencies'],\n    ['O', 'override', 'override local changes'],\n    ['v', 'verbose', 'show verbose output for inspection'],\n    ['j', 'json', 'return the output as JSON'],\n    // ['', 'conf', 'write the configuration file (component.json) of the component'], // not working. need to fix once ComponentWriter is moved to Harmony\n    ['', 'skip-npm-install', 'DEPRECATED. use \"--skip-dependency-installation\" instead'],\n    ['', 'skip-dependency-installation', 'do not install packages of the imported components'],\n    [\n      'm',\n      'merge [strategy]',\n      'merge local changes with the imported version. strategy should be \"theirs\", \"ours\" or \"manual\"',\n    ],\n    ['', 'dependencies', 'EXPERIMENTAL. import all dependencies and write them to the workspace'],\n    [\n      '',\n      'dependents',\n      'EXPERIMENTAL. import components found while traversing from the given ids upwards to the workspace components',\n    ],\n    [\n      '',\n      'save-in-lane',\n      'EXPERIMENTAL. when checked out to a lane and the component is not on the remote-lane, save it in the lane (default to save on main)',\n    ],\n    [\n      '',\n      'all-history',\n      'relevant for fetching all components objects. avoid optimizations, fetch all history versions, always',\n    ],\n  ] as CommandOptions;\n  loader = true;\n  migration = true;\n  remoteOp = true;\n  _packageManagerArgs: string[]; // gets populated by yargs-adapter.handler().\n\n  constructor(private importer: ImporterMain, private docsDomain: string) {\n    this.extendedDescription = `https://${docsDomain}/components/importing-components\n${WILDCARD_HELP('import')}`;\n  }\n\n  async report(\n    [ids = []]: [string[]],\n    {\n      path,\n      objects = false,\n      displayDependencies = false,\n      override = false,\n      verbose = false,\n      json = false,\n      conf,\n      skipNpmInstall = false,\n      skipDependencyInstallation = false,\n      merge,\n      saveInLane = false,\n      dependencies = false,\n      dependents = false,\n      allHistory = false,\n    }: {\n      path?: string;\n      objects?: boolean;\n      displayDependencies?: boolean;\n      override?: boolean;\n      verbose?: boolean;\n      json?: boolean;\n      conf?: string;\n      skipNpmInstall?: boolean;\n      skipDependencyInstallation?: boolean;\n      merge?: MergeStrategy;\n      saveInLane?: boolean;\n      dependencies?: boolean;\n      dependents?: boolean;\n      allHistory?: boolean;\n    }\n  ): Promise<any> {\n    if (objects && merge) {\n      throw new GeneralError('you cant use --objects and --merge flags combined');\n    }\n    if (override && merge) {\n      throw new GeneralError('you cant use --override and --merge flags combined');\n    }\n    if (!ids.length && dependencies) {\n      throw new GeneralError('you have to specify ids to use \"--dependencies\" flag');\n    }\n    if (!ids.length && dependents) {\n      throw new GeneralError('you have to specify ids to use \"--dependents\" flag');\n    }\n    if (skipNpmInstall) {\n      // eslint-disable-next-line no-console\n      console.log(\n        chalk.yellow(`\"--skip-npm-install\" has been deprecated, please use \"--skip-dependency-installation\" instead`)\n      );\n      skipDependencyInstallation = true;\n    }\n    let mergeStrategy;\n    if (merge && R.is(String, merge)) {\n      const options = Object.keys(MergeOptions);\n      if (!options.includes(merge)) {\n        throw new GeneralError(`merge must be one of the following: ${options.join(', ')}`);\n      }\n      mergeStrategy = merge;\n    }\n\n    const importOptions: ImportOptions = {\n      ids,\n      verbose,\n      merge: Boolean(merge),\n      mergeStrategy,\n      writeToPath: path,\n      objectsOnly: objects,\n      override,\n      writeConfig: Boolean(conf),\n      installNpmPackages: !skipDependencyInstallation,\n      saveInLane,\n      importDependenciesDirectly: dependencies,\n      importDependents: dependents,\n      allHistory,\n    };\n    const importResults = await this.importer.import(importOptions, this._packageManagerArgs);\n    const { importDetails, importedIds, importedDeps } = importResults;\n\n    if (json) {\n      return JSON.stringify({ importDetails }, null, 4);\n    }\n\n    if (!importedIds.length) {\n      return chalk.yellow(importResults.cancellationMessage || 'nothing to import');\n    }\n\n    const titlePrefix =\n      importedIds.length === 1\n        ? 'successfully imported one component'\n        : `successfully imported ${importedIds.length} components`;\n\n    let upToDateCount = 0;\n    const importedComponents = importedIds.map((bitId) => {\n      const details = importDetails.find((c) => c.id === bitId.toStringWithoutVersion());\n      if (!details) throw new Error(`missing details of component ${bitId.toString()}`);\n      if (details.status === 'up to date') {\n        upToDateCount += 1;\n      }\n      return formatPlainComponentItemWithVersions(bitId, details);\n    });\n    const upToDateStr = upToDateCount === 0 ? '' : `, ${upToDateCount} components are up to date`;\n    const title = `${titlePrefix}${upToDateStr}`;\n    const componentDependenciesOutput = [chalk.green(title), ...compact(importedComponents)].join('\\n');\n    const importedDepsOutput =\n      displayDependencies && importedDeps.length\n        ? immutableUnshift(\n            R.uniq(importedDeps.map(formatPlainComponentItem)),\n            chalk.green(`\\n\\nsuccessfully imported ${importedDeps.length} component dependencies`)\n          ).join('\\n')\n        : '';\n\n    const dependenciesOutput = componentDependenciesOutput + importedDepsOutput;\n\n    return dependenciesOutput;\n  }\n}\n\nfunction formatPlainComponentItemWithVersions(bitId: BitId, importDetails: ImportDetails) {\n  const status: ImportStatus = importDetails.status;\n  const id = bitId.toStringWithoutVersion();\n  const getVersionsOutput = () => {\n    if (!importDetails.versions.length) return '';\n    if (importDetails.latestVersion) {\n      return `${importDetails.versions.length} new version(s) available, latest ${importDetails.latestVersion}`;\n    }\n    return `new versions: ${importDetails.versions.join(', ')}`;\n  };\n  const versions = getVersionsOutput();\n  const usedVersion = status === 'added' ? `, currently used version ${bitId.version}` : '';\n  const getConflictMessage = () => {\n    if (!importDetails.filesStatus) return '';\n    const conflictedFiles = Object.keys(importDetails.filesStatus)\n      // @ts-ignore file is set\n      .filter((file) => importDetails.filesStatus[file] === FileStatus.manual);\n    if (!conflictedFiles.length) return '';\n    return `(the following files were saved with conflicts ${conflictedFiles\n      .map((file) => chalk.bold(file))\n      .join(', ')}) `;\n  };\n  const conflictMessage = getConflictMessage();\n  const deprecated = importDetails.deprecated ? chalk.yellow('deprecated') : '';\n  const removed = importDetails.removed ? chalk.red('removed') : '';\n  const missingDeps = importDetails.missingDeps.length\n    ? chalk.red(`missing dependencies: ${importDetails.missingDeps.map((d) => d.toString()).join(', ')}`)\n    : '';\n  if (status === 'up to date' && !missingDeps && !deprecated && !conflictMessage) {\n    return undefined;\n  }\n  return `- ${chalk.green(status)} ${chalk.cyan(\n    id\n  )} ${versions}${usedVersion} ${conflictMessage}${deprecated}${removed} ${missingDeps}`;\n}\n"],"mappings":"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"}