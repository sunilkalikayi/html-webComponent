{"version":3,"names":["CoreExporterTask","constructor","env","aspectLoader","execute","context","mainAspect","capsules","capsuleNetwork","seedersCapsules","mainAspectCapsule","find","capsule","component","id","name","distDir","getCompiler","addFolderForAllCoreAspects","addFolderForHarmony","addFolderForLegacy","componentsResults","artifacts","coreAspectsIds","getCoreAspectIds","coreAspectsNamesPackages","map","getCoreAspectName","packageName","getCoreAspectPackageName","capsuleDir","path","createBarrelFilesP","newDirPath","join","fs","ensureDir","barrelContent","generateBarrelFile","writeFile","Promise","all","addFolderForNonAspectCorePackages"],"sources":["core-exporter.task.ts"],"sourcesContent":["import path from 'path';\nimport fs from 'fs-extra';\nimport { BuildContext, BuiltTaskResult, BuildTask, TaskLocation } from '@teambit/builder';\nimport { AspectLoaderMain, getCoreAspectName, getCoreAspectPackageName } from '@teambit/aspect-loader';\nimport { Capsule } from '@teambit/isolator';\nimport { Environment } from '@teambit/envs';\n\nexport class CoreExporterTask implements BuildTask {\n  constructor(private env: Environment, private aspectLoader: AspectLoaderMain) {}\n\n  location: TaskLocation = 'start';\n  readonly aspectId = 'teambit.harmony/aspect';\n  readonly name = 'CoreExporter';\n  readonly description = 'export all core aspects via the main aspects';\n\n  async execute(context: BuildContext): Promise<BuiltTaskResult> {\n    const mainAspect = this.aspectLoader.mainAspect;\n    const capsules = context.capsuleNetwork.seedersCapsules;\n    const mainAspectCapsule = capsules.find((capsule) => capsule.component.id.name === mainAspect.name);\n    if (mainAspectCapsule) {\n      const distDir = this.env.getCompiler().distDir;\n      await this.addFolderForAllCoreAspects(mainAspectCapsule, distDir);\n      await this.addFolderForHarmony(mainAspectCapsule, distDir);\n      await this.addFolderForLegacy(mainAspectCapsule, distDir);\n    }\n\n    return {\n      componentsResults: [],\n      artifacts: [],\n    };\n  }\n\n  private addFolderForAllCoreAspects(mainAspectCapsule: Capsule, distDir: string) {\n    const coreAspectsIds = this.aspectLoader.getCoreAspectIds();\n    const coreAspectsNamesPackages = coreAspectsIds.map((id) => {\n      return {\n        name: getCoreAspectName(id),\n        packageName: getCoreAspectPackageName(id),\n      };\n    });\n    const capsuleDir = mainAspectCapsule.path;\n    const createBarrelFilesP = coreAspectsNamesPackages.map(async ({ name, packageName }) => {\n      const newDirPath = path.join(capsuleDir, distDir, name);\n      await fs.ensureDir(newDirPath);\n      const barrelContent = generateBarrelFile(packageName);\n      await fs.writeFile(path.join(newDirPath, 'index.js'), barrelContent);\n    });\n    return Promise.all(createBarrelFilesP);\n  }\n\n  private async addFolderForNonAspectCorePackages(\n    mainAspectCapsule: Capsule,\n    distDir: string,\n    name: string,\n    packageName = `@teambit/${name}`\n  ) {\n    const capsuleDir = mainAspectCapsule.path;\n    const newDirPath = path.join(capsuleDir, distDir, name);\n    await fs.ensureDir(newDirPath);\n    const barrelContent = generateBarrelFile(packageName);\n    await fs.writeFile(path.join(newDirPath, 'index.js'), barrelContent);\n  }\n\n  private async addFolderForHarmony(mainAspectCapsule: Capsule, distDir: string) {\n    const name = 'harmony';\n    await this.addFolderForNonAspectCorePackages(mainAspectCapsule, distDir, name);\n  }\n\n  private async addFolderForLegacy(mainAspectCapsule: Capsule, distDir: string) {\n    const name = 'legacy';\n    await this.addFolderForNonAspectCorePackages(mainAspectCapsule, distDir, name);\n  }\n}\n\nfunction generateBarrelFile(packageName) {\n  return `\nObject.defineProperty(exports, \"__esModule\", { value: true });\n// const aspect = require(\"${packageName}\");\n// module.exports = aspect;\nmodule.exports.path = require.resolve(\"${packageName}\");\n`;\n}\n"],"mappings":"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"}